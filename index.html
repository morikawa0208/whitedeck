<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="format-detection" content="telephone=no">
    <title>ã™ãã¾ã§ãƒã‚¯ã‚¹ãƒ©ã€æ²¡ã€‘</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+JP:wght@400;700&display=swap');
        
        html, body {
            margin: 0;
            padding: 0;
            touch-action: manipulation;
            overscroll-behavior: none;
        }

        body {
            font-family: 'Noto Sans JP', sans-serif;
            background-color: #f8fafc;
            color: #1e293b;
            user-select: none;
            -webkit-tap-highlight-color: transparent;
            height: 100dvh;
            display: flex;
            flex-direction: column;
            overflow: hidden;
            align-items: center;
        }

        body.is-booting .app-shell {
            visibility: hidden;
        }

        body.is-booting #boot-overlay {
            display: flex !important;
        }

        .app-shell {
            width: clamp(0px, 100%, 460px);
            min-height: 100dvh;
            display: flex;
            flex-direction: column;
        }

        .page { display: none; height: 100%; min-height: 0; flex-direction: column; overflow-y: auto; }
        .page.active { display: flex; }

        /* Status Bars */
        .bar-container { position: relative; background-color: #e2e8f0; border-radius: 6px; overflow: hidden; height: 20px; border: 1px solid #cbd5e1; width: 100%; }
        .bar-fill { height: 100%; transition: width 0.3s ease; }
        .hp-fill { background-color: #ef4444; }
        .cp-fill { background-color: #dbeafe; }
        .exp-fill { background-color: #fbbf24; }
        .bar-text { position: absolute; inset: 0; display: flex; items-center; justify-content: center; font-size: 10px; font-weight: 800; color: #fff; text-shadow: 1px 1px 0 rgba(0,0,0,0.5); pointer-events: none; }

        @keyframes floatUp {
            0% { opacity: 1; transform: translate(-50%, -50%) translate(var(--offset-x), var(--offset-y)); }
            100% { opacity: 0; transform: translate(-50%, -50%) translate(var(--offset-x), calc(var(--offset-y) - 40px)); }
        }
        .damage-text {
            position: absolute;
            font-weight: 900;
            font-size: 1.5rem;
            animation: floatUp 0.8s forwards;
            pointer-events: none;
            z-index: 100;
            text-shadow: 2px 2px 0 #fff;
            --offset-x: 0px;
            --offset-y: 0px;
            transform: translate(-50%, -50%) translate(var(--offset-x), var(--offset-y));
            white-space: nowrap;
            max-width: 100%;
        }
        .damage-text-popup-label {
            display: block;
            font-size: 0.7rem;
            line-height: 1;
            margin-bottom: 2px;
            letter-spacing: 0.03em;
        }
        #damage-layer {
            overflow: hidden;
        }

        .mini-log {
            font-size: 10px;
            line-height: 1.2;
            mask-image: linear-gradient(to top, black 70%, transparent 100%);
        }

        .rarity-normal { color: #334155; font-weight: bold; }
        .rarity-magic { color: #3b82f6; font-weight: bold; }
        .rarity-rare { color: #facc15; font-weight: bold; }
        .rarity-epic { color: #a855f7; font-weight: bold; }
        .rarity-legendary { color: #a16207; font-weight: bold; text-shadow: 0 0 8px rgba(161, 98, 7, 0.35); }
        .rarity-mythic { color: #7c3aed; font-weight: bold; text-shadow: 0 0 10px rgba(250, 204, 21, 0.55); }

        .drop-log-box {
            font-size: 10px;
            line-height: 1.2;
            mask-image: linear-gradient(to top, black 70%, transparent 100%);
        }
        .drop-log-item {
            display: flex;
            align-items: center;
            gap: 6px;
            font-size: 10px;
            line-height: 1.2;
        }
        .drop-log-item i {
            color: #94a3b8;
        }

        .shake { animation: shake 0.3s cubic-bezier(.36,.07,.19,.97) both; }
        @keyframes shake {
            10%, 90% { transform: translate3d(-1px, 0, 0); }
            20%, 80% { transform: translate3d(2px, 0, 0); }
            30%, 50%, 70% { transform: translate3d(-4px, 0, 0); }
            40%, 60% { transform: translate3d(4px, 0, 0); }
        }

        nav button.active { color: #0f172a; border-top: 3px solid #0f172a; background-color: #fff; }
        .type-tab.active { border-bottom: 3px solid #0f172a; color: #0f172a; font-weight: bold; }

        .no-scrollbar::-webkit-scrollbar { display: none; }

        .boss-visual {
            color: #f59e0b;
            text-shadow: 0 0 12px rgba(245, 158, 11, 0.6);
            animation: bossPulse 1.8s ease-in-out infinite;
        }
        .boss-name {
            color: #b45309;
            text-shadow: 0 0 6px rgba(245, 158, 11, 0.35);
        }
        .boss-badge {
            display: inline-flex;
            align-items: center;
            gap: 4px;
            font-size: 10px;
            font-weight: 900;
            letter-spacing: 0.2em;
            padding: 4px 10px;
            border-radius: 9999px;
            background: linear-gradient(135deg, #f59e0b, #f97316);
            color: #fff7ed;
            box-shadow: 0 0 10px rgba(249, 115, 22, 0.4);
        }
        @keyframes bossPulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.06); }
        }

        .item-name-shrink {
            font-size: 0.72rem;
            line-height: 1.1;
        }

        .item-stat-categories {
            display: flex;
            gap: 8px;
            align-items: flex-start;
            flex-wrap: nowrap;
        }

        .item-stat-group {
            min-width: 0;
            flex: 1;
        }

        .item-stat-group-title {
            display: flex;
            align-items: center;
            gap: 4px;
            font-size: 9px;
            font-weight: 900;
            color: #94a3b8;
            text-transform: uppercase;
            margin-bottom: 2px;
        }

        .item-unique-block {
            margin-top: 6px;
            padding: 6px 8px;
            border-radius: 8px;
            background: rgba(251, 191, 36, 0.1);
            border: 1px solid rgba(251, 191, 36, 0.35);
        }

        .enhance-label {
            font-size: 0.7rem;
            font-weight: 900;
            letter-spacing: 0.02em;
        }
        .enhance-green { color: #22c55e; }
        .enhance-yellow { color: #facc15; }
        .enhance-blue { color: #38bdf8; }
        .enhance-pink { color: #f472b6; }
        .enhance-orange { color: #fb923c; }
        .enhance-gold { color: #f59e0b; text-shadow: 0 0 6px rgba(245, 158, 11, 0.55); }
        .enhance-white { color: #f8fafc; text-shadow: 0 0 4px rgba(15, 23, 42, 0.8); }
        .enhance-broken { color: #ef4444; font-size: 0.6rem; font-weight: 900; letter-spacing: 0.08em; }
        .enhance-rattle { animation: shake 0.35s cubic-bezier(.36,.07,.19,.97) infinite; }
        .enhance-glow-success { animation: enhanceGlow 1.2s ease-in-out infinite; }
        .enhance-glow-fail { animation: enhanceFade 1.2s ease-in-out infinite; }
        @keyframes enhanceGlow {
            0%, 100% { transform: scale(1); box-shadow: 0 0 0 rgba(34, 197, 94, 0.4); }
            50% { transform: scale(1.04); box-shadow: 0 0 20px rgba(34, 197, 94, 0.5); }
        }
        @keyframes enhanceFade {
            0%, 100% { transform: scale(1); opacity: 0.9; }
            50% { transform: scale(0.98); opacity: 0.6; }
        }

        .drop-log-item.rarity-legendary {
            background: linear-gradient(120deg, rgba(251, 191, 36, 0.24), rgba(30, 41, 59, 0.2));
            border: 1px solid rgba(251, 191, 36, 0.6);
            border-radius: 9999px;
            padding: 2px 8px;
            box-shadow: 0 0 12px rgba(251, 191, 36, 0.35);
            animation: legendaryLogGlow 2.4s ease-in-out infinite;
        }
        .drop-log-item.rarity-legendary i {
            color: #fbbf24;
        }
        @keyframes legendaryLogGlow {
            0%, 100% { box-shadow: 0 0 10px rgba(251, 191, 36, 0.3); }
            50% { box-shadow: 0 0 18px rgba(251, 191, 36, 0.55); }
        }

        .feedback-embed {
            width: 100%;
            height: clamp(420px, 70dvh, 760px);
            border: 0;
        }

        #action-btn,
        #action-btn * {
            user-select: none;
            -webkit-user-select: none;
            -webkit-touch-callout: none;
        }

        .preset-badge {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            padding: 1px 6px;
            border-radius: 9999px;
            font-size: 9px;
            font-weight: 900;
            letter-spacing: 0.04em;
            background-color: #e2e8f0;
            color: #334155;
            border: 1px solid #cbd5e1;
        }
    </style>
</head>
<body class="is-booting flex flex-col">
    <div class="app-shell">

    <!-- TOP BAR -->
    <header class="h-12 border-b flex items-center justify-between px-4 shrink-0 bg-white z-50 shadow-sm">
        <div class="font-bold flex items-center gap-2">
            <span class="text-slate-700 text-sm">ã™ãã¾ã§ãƒã‚¯ã‚¹ãƒ©</span>
        </div>
        <div class="flex items-center gap-3">
            <span class="text-[10px] bg-amber-100 text-amber-700 px-2 py-0.5 rounded-full font-bold">Floor: <span id="header-floor">1</span></span>
            <span class="text-[10px] bg-emerald-100 text-emerald-700 px-2 py-0.5 rounded-full font-bold"><i class="fas fa-coins"></i> <span id="header-gold">0</span>G</span>
            <div class="bg-slate-800 text-white text-[10px] px-2 py-1 rounded font-bold">Lv.<span id="header-lvl">1</span></div>
        </div>
    </header>

    <!-- CONTENT PAGES -->
    <main class="flex-1 overflow-hidden relative min-h-0">
        
        <!-- BATTLE PAGE -->
        <section id="page-battle" class="page active p-4" style="padding-top: 4px">
            <div class="flex-1 flex flex-col items-center justify-center relative min-h-[200px]">
                <div class="absolute right-2 top-2 z-10 flex items-center gap-2">
                    <label class="flex items-center gap-1.5 bg-white/90 text-slate-600 text-[12px] font-bold px-3 py-2 rounded-full shadow border border-slate-200">
                        <input id="rematch-toggle" type="checkbox" class="accent-slate-800">
                        å†æˆ¦
                    </label>
                    <button id="warp-btn" class="bg-slate-800 text-white text-xs font-black px-3 py-2 rounded-full shadow flex items-center gap-2 hover:bg-slate-700 active:scale-95 transition">
                        <i class="fas fa-location-arrow"></i>
                        ãƒ¯ãƒ¼ãƒ—
                    </button>
                </div>
                <div id="enemy-container" class="text-center transition-all duration-300">
                    <div id="enemy-visual" class="text-8xl mb-4 text-slate-700"><i class="fas fa-ghost"></i></div>
                                <div id="enemy-name" class="font-bold text-lg mb-1">ã‚¹ãƒ©ã‚¤ãƒ </div>
                                <div id="enemy-cycle-label" class="text-[10px] font-bold text-slate-500 mb-1">Floor 1 å‡ºç¾å€™è£œ 1 / 3</div>
                <div id="enemy-boss-badge" class="hidden justify-center mb-2">
                    <span class="boss-badge"><i class="fas fa-crown"></i> BOSS</span>
                </div>
                <div class="w-48 bar-container mx-auto mb-1 border-0 bg-slate-200">
                    <div id="enemy-hp-bar" class="bar-fill hp-fill"></div>
                    <div class="bar-text">HP: <span id="enemy-hp-text">30/30</span></div>
                </div>
            </div>
                <div id="damage-layer" class="absolute inset-0 pointer-events-none"></div>
                <div class="absolute left-0 bottom-4 w-1/2 drop-log-box pointer-events-none text-left pl-2 text-slate-500 italic">
                    <div id="drop-log-list" class="flex flex-col-reverse gap-1"></div>
                </div>
                <div class="absolute right-0 bottom-4 w-1/2 mini-log pointer-events-none text-right pr-2 text-slate-500 italic space-y-1">
                    <div id="mini-log-9"></div>
                    <div id="mini-log-8"></div>
                    <div id="mini-log-7"></div>
                    <div id="mini-log-6"></div>
                    <div id="mini-log-5"></div>
                    <div id="mini-log-4"></div>
                    <div id="mini-log-3"></div>
                    <div id="mini-log-2"></div>
                    <div id="mini-log-1"></div>
                    <div id="mini-log-0" class="text-slate-800 font-bold"></div>
                </div>
            </div>

            <!-- Player Status Section -->
            <div class="bg-white border rounded-2xl p-4 shadow-sm space-y-3 mb-2">
                <div class="space-y-1.5">
                    <div class="bar-container">
                        <div id="player-hp-bar" class="bar-fill hp-fill"></div>
                        <div class="bar-text">HP: <span id="player-hp-text">100/100</span></div>
                    </div>
                    <div class="bar-container">
                        <div id="player-cp-bar" class="bar-fill cp-fill"></div>
                        <div class="bar-text">CP: <span id="player-cp-text">0/0</span></div>
                    </div>
                    <div class="bar-container">
                        <div id="player-exp-bar-battle" class="bar-fill exp-fill"></div>
                        <div class="bar-text">EXP: <span id="player-exp-text-battle">0/100</span></div>
                    </div>
                </div>
                <div id="auto-skill-display" class="text-[11px] font-bold text-slate-600 bg-slate-50 border border-slate-200 rounded-xl px-3 py-2 space-y-1">
                    <div id="auto-slot-2-display">è‡ªå‹•ã‚¹ãƒ­ãƒƒãƒˆ2: ç©º</div>
                    <div id="auto-slot-1-display">è‡ªå‹•ã‚¹ãƒ­ãƒƒãƒˆ1: -</div>
                </div>
                <div id="manual-skill-buttons" class="grid grid-cols-2 gap-2">
                    <button id="manual-skill-btn-1" class="py-2 rounded-xl bg-slate-100 text-slate-600 text-[10px] font-black"><i class="fas fa-hand-pointer"></i> æ‰‹å‹•1</button>
                    <button id="manual-skill-btn-2" class="py-2 rounded-xl bg-slate-100 text-slate-600 text-[10px] font-black"><i class="fas fa-hand-pointer"></i> æ‰‹å‹•2</button>
                    <button id="manual-skill-btn-3" class="py-2 rounded-xl bg-slate-100 text-slate-600 text-[10px] font-black"><i class="fas fa-hand-pointer"></i> æ‰‹å‹•3</button>
                    <button id="manual-skill-btn-4" class="py-2 rounded-xl bg-slate-100 text-slate-600 text-[10px] font-black"><i class="fas fa-hand-pointer"></i> æ‰‹å‹•4</button>
                </div>

                <button id="action-btn" class="w-full bg-slate-800 text-white font-black py-4 rounded-2xl shadow-lg active:scale-95 transition-transform text-lg flex items-center justify-center gap-2">
                    <i class="fas fa-sword"></i> <span>æ”»æ’ƒ</span>
                </button>
            </div>
            
            <div id="death-overlay" class="absolute inset-0 bg-red-900/40 backdrop-blur-[2px] hidden items-center justify-center z-50">
                <div class="bg-white p-8 rounded-3xl shadow-2xl text-center border-2 border-red-500 mx-4">
                    <div class="text-6xl mb-4">ğŸ’€</div>
                    <h2 class="text-2xl font-black text-red-600 mb-2">YOU DIED</h2>
                    <p class="text-sm text-slate-500 mb-2">ãƒšãƒŠãƒ«ãƒ†ã‚£ãŒç™ºç”Ÿã—ã¾ã—ãŸï¼š</p>
                    <div class="text-xs text-red-600 font-bold mb-6 bg-red-50 p-3 rounded-xl">
                        çµŒé¨“å€¤ãƒ­ã‚¹ãƒˆ: <span id="lost-exp-val">-</span>
                    </div>
                    <button onclick="revive()" class="w-full bg-red-600 text-white font-bold px-8 py-4 rounded-xl shadow-lg active:scale-95">è¡—ã«æˆ»ã‚‹</button>
                </div>
            </div>
        </section>

        <!-- SAVE PAGE -->
        <section id="page-save" class="page p-4 bg-slate-50">
            <div class="flex items-center justify-between mb-4 px-2">
                <h2 class="text-xl font-black flex items-center gap-2"><i class="fas fa-floppy-disk"></i> ã‚»ãƒ¼ãƒ–</h2>
            </div>
            <div id="save-section" class="bg-white rounded-3xl p-6 shadow-sm mb-6">
                <div class="flex items-center justify-between mb-3">
                    <h3 class="text-sm font-black text-slate-700 flex items-center gap-2"><i class="fas fa-floppy-disk"></i> ã‚»ãƒ¼ãƒ–/ãƒ­ãƒ¼ãƒ‰</h3>
                    <span id="autosave-indicator" class="text-[10px] text-emerald-600 font-bold">ã‚ªãƒ¼ãƒˆã‚»ãƒ¼ãƒ–: ã‚¹ãƒ­ãƒƒãƒˆ1</span>
                </div>
                <p class="text-[10px] text-slate-500 mb-3">30ç§’ã”ã¨ã«é¸æŠã—ãŸã‚¹ãƒ­ãƒƒãƒˆã¸è‡ªå‹•ä¿å­˜ã—ã¾ã™ã€‚</p>
                <div id="save-status" class="text-[10px] text-slate-400 mb-3">æœªä¿å­˜</div>
                <div class="grid grid-cols-2 gap-2 mb-3">
                    <button id="switch-save-slot-btn" class="py-2 rounded-xl bg-slate-100 text-slate-600 text-[10px] font-black flex items-center justify-center gap-2">
                        <i class="fas fa-right-left"></i> ã‚¹ãƒ­ãƒƒãƒˆåˆ‡æ›¿
                    </button>
                    <button id="new-save-btn" class="py-2 rounded-xl bg-rose-50 text-rose-600 text-[10px] font-black flex items-center justify-center gap-2">
                        <i class="fas fa-trash-can"></i> æ–°ã—ãå§‹ã‚ã‚‹
                    </button>
                </div>
                <div class="space-y-3">
                    <div class="rounded-2xl border border-slate-200 bg-slate-50 p-3">
                        <div class="flex items-center justify-between gap-2">
                            <div>
                                <div class="text-xs font-black text-slate-700">ã‚¹ãƒ­ãƒƒãƒˆ1</div>
                                <div id="save-slot-info-1" class="text-[10px] text-slate-400">ç©º</div>
                            </div>
                            <label class="text-[9px] font-bold text-slate-500 flex items-center gap-1">
                                <input type="radio" name="autosave-slot" value="1" class="accent-slate-800">
                                ã‚ªãƒ¼ãƒˆã‚»ãƒ¼ãƒ–
                            </label>
                        </div>
                        <div class="flex gap-2 mt-2">
                            <button data-save-slot="1" class="flex-1 py-2 rounded-xl bg-slate-800 text-white text-[10px] font-black flex items-center justify-center gap-1">
                                <i class="fas fa-floppy-disk"></i> ã‚»ãƒ¼ãƒ–
                            </button>
                            <button data-load-slot="1" class="flex-1 py-2 rounded-xl bg-slate-200 text-slate-700 text-[10px] font-black flex items-center justify-center gap-1">
                                <i class="fas fa-download"></i> ãƒ­ãƒ¼ãƒ‰
                            </button>
                        </div>
                    </div>
                    <div class="rounded-2xl border border-slate-200 bg-slate-50 p-3">
                        <div class="flex items-center justify-between gap-2">
                            <div>
                                <div class="text-xs font-black text-slate-700">ã‚¹ãƒ­ãƒƒãƒˆ2</div>
                                <div id="save-slot-info-2" class="text-[10px] text-slate-400">ç©º</div>
                            </div>
                            <label class="text-[9px] font-bold text-slate-500 flex items-center gap-1">
                                <input type="radio" name="autosave-slot" value="2" class="accent-slate-800">
                                ã‚ªãƒ¼ãƒˆã‚»ãƒ¼ãƒ–
                            </label>
                        </div>
                        <div class="flex gap-2 mt-2">
                            <button data-save-slot="2" class="flex-1 py-2 rounded-xl bg-slate-800 text-white text-[10px] font-black flex items-center justify-center gap-1">
                                <i class="fas fa-floppy-disk"></i> ã‚»ãƒ¼ãƒ–
                            </button>
                            <button data-load-slot="2" class="flex-1 py-2 rounded-xl bg-slate-200 text-slate-700 text-[10px] font-black flex items-center justify-center gap-1">
                                <i class="fas fa-download"></i> ãƒ­ãƒ¼ãƒ‰
                            </button>
                        </div>
                    </div>
                    <div class="rounded-2xl border border-slate-200 bg-slate-50 p-3">
                        <div class="flex items-center justify-between gap-2">
                            <div>
                                <div class="text-xs font-black text-slate-700">ã‚¹ãƒ­ãƒƒãƒˆ3</div>
                                <div id="save-slot-info-3" class="text-[10px] text-slate-400">ç©º</div>
                            </div>
                            <label class="text-[9px] font-bold text-slate-500 flex items-center gap-1">
                                <input type="radio" name="autosave-slot" value="3" class="accent-slate-800">
                                ã‚ªãƒ¼ãƒˆã‚»ãƒ¼ãƒ–
                            </label>
                        </div>
                        <div class="flex gap-2 mt-2">
                            <button data-save-slot="3" class="flex-1 py-2 rounded-xl bg-slate-800 text-white text-[10px] font-black flex items-center justify-center gap-1">
                                <i class="fas fa-floppy-disk"></i> ã‚»ãƒ¼ãƒ–
                            </button>
                            <button data-load-slot="3" class="flex-1 py-2 rounded-xl bg-slate-200 text-slate-700 text-[10px] font-black flex items-center justify-center gap-1">
                                <i class="fas fa-download"></i> ãƒ­ãƒ¼ãƒ‰
                            </button>
                        </div>
                    </div>
                </div>

                <div class="mt-4 rounded-2xl border border-slate-200 bg-white p-4">
                    <div class="flex items-center justify-between gap-2 mb-2">
                        <h4 class="text-[11px] font-black text-slate-700 flex items-center gap-2">
                            <i class="fas fa-file-export"></i> ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆ / ã‚¤ãƒ³ãƒãƒ¼ãƒˆ
                        </h4>
                        <span class="text-[9px] text-slate-400">ç¾åœ¨ã®ã‚ªãƒ¼ãƒˆã‚»ãƒ¼ãƒ–ã‚¹ãƒ­ãƒƒãƒˆã‚’å¯¾è±¡</span>
                    </div>
                    <p class="text-[10px] text-slate-500 mb-3">
                        æ–‡å­—åˆ—ã‚³ãƒ”ãƒ¼ã§ä»–ç«¯æœ«ã¸å¼•ãç¶™ã’ã¾ã™ã€‚
                    </p>
                    <div class="grid grid-cols-1 gap-3">
                        <div class="rounded-xl border border-slate-200 bg-slate-50 p-3 space-y-2">
                            <div class="flex items-center justify-between gap-2">
                                <span class="text-[10px] font-black text-slate-600 flex items-center gap-1">
                                    <i class="fas fa-copy"></i> ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆæ–‡å­—åˆ—
                                </span>
                                <button id="export-refresh-btn" class="text-[9px] font-black px-2 py-1 rounded-full bg-slate-800 text-white">
                                    å¼•ãç¶™ãã‚³ãƒ¼ãƒ‰ç”Ÿæˆ
                                </button>
                            </div>
                            <textarea id="export-text" class="w-full h-20 rounded-lg border border-slate-200 bg-white p-2 text-[9px] text-slate-600" readonly></textarea>
                            <div id="export-copy-message" class="text-[9px] text-emerald-600 font-bold hidden">ã‚³ãƒ”ãƒ¼ã—ã¾ã—ãŸ</div>
                            <div class="flex items-center gap-2">
                                <button id="export-copy-btn" class="flex-1 py-2 rounded-xl bg-slate-800 text-white text-[10px] font-black flex items-center justify-center gap-1">
                                    <i class="fas fa-copy"></i> ã‚³ãƒ”ãƒ¼
                                </button>
                                <button id="export-clear-btn" class="flex-1 py-2 rounded-xl bg-slate-200 text-slate-700 text-[10px] font-black flex items-center justify-center gap-1">
                                    <i class="fas fa-eraser"></i> ã‚¯ãƒªã‚¢
                                </button>
                            </div>
                        </div>

                        <div class="rounded-xl border border-slate-200 bg-slate-50 p-3 space-y-2">
                            <span class="text-[10px] font-black text-slate-600 flex items-center gap-1">
                                <i class="fas fa-file-import"></i> ã‚¤ãƒ³ãƒãƒ¼ãƒˆæ–‡å­—åˆ—
                            </span>
                            <div class="flex items-center justify-between gap-2 text-[9px] text-slate-500">
                                <span class="font-bold flex items-center gap-1">
                                    <i class="fas fa-bullseye"></i> å–ã‚Šè¾¼ã¿å…ˆã‚¹ãƒ­ãƒƒãƒˆ
                                </span>
                                <select id="import-slot-select" class="rounded-lg border border-slate-200 bg-white px-2 py-1 text-[9px] text-slate-600">
                                    <option value="auto">ã‚ªãƒ¼ãƒˆã‚»ãƒ¼ãƒ–</option>
                                    <option value="1">ã‚¹ãƒ­ãƒƒãƒˆ1</option>
                                    <option value="2">ã‚¹ãƒ­ãƒƒãƒˆ2</option>
                                    <option value="3">ã‚¹ãƒ­ãƒƒãƒˆ3</option>
                                </select>
                            </div>
                            <textarea id="import-text" class="w-full h-20 rounded-lg border border-slate-200 bg-white p-2 text-[9px] text-slate-600" placeholder="ã“ã“ã«è²¼ã‚Šä»˜ã‘"></textarea>
                            <div class="flex items-center gap-2">
                                <button id="import-apply-btn" class="flex-1 py-2 rounded-xl bg-emerald-600 text-white text-[10px] font-black flex items-center justify-center gap-1">
                                    <i class="fas fa-upload"></i> å–ã‚Šè¾¼ã¿
                                </button>
                                <button id="import-clear-btn" class="flex-1 py-2 rounded-xl bg-slate-200 text-slate-700 text-[10px] font-black flex items-center justify-center gap-1">
                                    <i class="fas fa-eraser"></i> ã‚¯ãƒªã‚¢
                                </button>
                            </div>
                            <div id="import-tamper-message" class="text-[9px] text-rose-500 font-bold hidden">
                                æ”¹ã–ã‚“ãŒæ¤œå‡ºã•ã‚ŒãŸãŸã‚å–ã‚Šè¾¼ã¿ã‚’æ‹’å¦ã—ã¾ã—ãŸã€‚
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </section>
        <!-- STATUS PAGE -->
        <section id="page-status" class="page p-4 bg-slate-50">
            
            <!-- Summary Card -->
            <div class="bg-white rounded-3xl p-6 shadow-sm mb-4">
                <div class="flex items-center justify-between border-b pb-4 mb-4">
                    <div>
                        <div class="text-[10px] text-slate-400 font-bold uppercase tracking-widest">Level</div>
                        <div class="text-4xl font-black" id="status-lvl">1</div>
                    </div>
                    <div class="text-right">
                        <div class="text-[10px] text-slate-400 font-bold uppercase tracking-widest">Experience</div>
                        <div class="text-sm font-bold"><span id="status-exp">0</span> / <span id="status-next">100</span></div>
                        <div class="w-32 bar-container h-2 mt-1 border-0 bg-slate-100"><div id="status-exp-bar" class="bar-fill exp-fill"></div></div>
                    </div>
                </div>

                <div class="grid grid-cols-2 gap-y-6 gap-x-4">
                    <div class="flex flex-col">
                        <span class="text-[10px] text-slate-400 font-bold uppercase">STRï¼ˆç­‹åŠ›ï¼‰</span>
                        <span class="text-2xl font-black text-slate-700" id="status-atk">1</span>
                        <div class="mt-2 grid grid-cols-4 gap-1">
                            <button class="stat-adjust-btn py-1 rounded-lg border border-slate-200 bg-slate-50 text-[10px] font-black text-slate-600" data-stat="STR" data-delta="1">+1</button>
                            <button class="stat-adjust-btn py-1 rounded-lg border border-slate-200 bg-slate-50 text-[10px] font-black text-slate-600" data-stat="STR" data-delta="10">+10</button>
                            <button class="stat-adjust-btn py-1 rounded-lg border border-slate-200 bg-slate-50 text-[10px] font-black text-slate-600" data-stat="STR" data-delta="-1">-1</button>
                            <button class="stat-adjust-btn py-1 rounded-lg border border-slate-200 bg-slate-50 text-[10px] font-black text-slate-600" data-stat="STR" data-delta="-10">-10</button>
                        </div>
                    </div>
                    <div class="flex flex-col">
                        <span class="text-[10px] text-slate-400 font-bold uppercase">VITï¼ˆä½“åŠ›ï¼‰</span>
                        <span class="text-2xl font-black text-slate-700" id="status-def">1</span>
                        <div class="mt-2 grid grid-cols-4 gap-1">
                            <button class="stat-adjust-btn py-1 rounded-lg border border-slate-200 bg-slate-50 text-[10px] font-black text-slate-600" data-stat="VIT" data-delta="1">+1</button>
                            <button class="stat-adjust-btn py-1 rounded-lg border border-slate-200 bg-slate-50 text-[10px] font-black text-slate-600" data-stat="VIT" data-delta="10">+10</button>
                            <button class="stat-adjust-btn py-1 rounded-lg border border-slate-200 bg-slate-50 text-[10px] font-black text-slate-600" data-stat="VIT" data-delta="-1">-1</button>
                            <button class="stat-adjust-btn py-1 rounded-lg border border-slate-200 bg-slate-50 text-[10px] font-black text-slate-600" data-stat="VIT" data-delta="-10">-10</button>
                        </div>
                    </div>
                    <div class="flex flex-col">
                        <span class="text-[10px] text-slate-400 font-bold uppercase">INTï¼ˆçŸ¥åŠ›ï¼‰</span>
                        <span class="text-2xl font-black text-slate-700" id="status-int">1</span>
                        <div class="mt-2 grid grid-cols-4 gap-1">
                            <button class="stat-adjust-btn py-1 rounded-lg border border-slate-200 bg-slate-50 text-[10px] font-black text-slate-600" data-stat="INT" data-delta="1">+1</button>
                            <button class="stat-adjust-btn py-1 rounded-lg border border-slate-200 bg-slate-50 text-[10px] font-black text-slate-600" data-stat="INT" data-delta="10">+10</button>
                            <button class="stat-adjust-btn py-1 rounded-lg border border-slate-200 bg-slate-50 text-[10px] font-black text-slate-600" data-stat="INT" data-delta="-1">-1</button>
                            <button class="stat-adjust-btn py-1 rounded-lg border border-slate-200 bg-slate-50 text-[10px] font-black text-slate-600" data-stat="INT" data-delta="-10">-10</button>
                        </div>
                    </div>
                    <div class="flex flex-col">
                        <span class="text-[10px] text-slate-400 font-bold uppercase">DEXï¼ˆå™¨ç”¨ï¼‰</span>
                        <span class="text-2xl font-black text-slate-700" id="status-dex">1</span>
                        <div class="mt-2 grid grid-cols-4 gap-1">
                            <button class="stat-adjust-btn py-1 rounded-lg border border-slate-200 bg-slate-50 text-[10px] font-black text-slate-600" data-stat="DEX" data-delta="1">+1</button>
                            <button class="stat-adjust-btn py-1 rounded-lg border border-slate-200 bg-slate-50 text-[10px] font-black text-slate-600" data-stat="DEX" data-delta="10">+10</button>
                            <button class="stat-adjust-btn py-1 rounded-lg border border-slate-200 bg-slate-50 text-[10px] font-black text-slate-600" data-stat="DEX" data-delta="-1">-1</button>
                            <button class="stat-adjust-btn py-1 rounded-lg border border-slate-200 bg-slate-50 text-[10px] font-black text-slate-600" data-stat="DEX" data-delta="-10">-10</button>
                        </div>
                    </div>
                    <div class="flex flex-col">
                        <span class="text-[10px] text-slate-400 font-bold uppercase">LUKï¼ˆé‹ï¼‰</span>
                        <span class="text-2xl font-black text-slate-700" id="status-luk">1</span>
                        <div class="mt-2 grid grid-cols-4 gap-1">
                            <button class="stat-adjust-btn py-1 rounded-lg border border-slate-200 bg-slate-50 text-[10px] font-black text-slate-600" data-stat="LUK" data-delta="1">+1</button>
                            <button class="stat-adjust-btn py-1 rounded-lg border border-slate-200 bg-slate-50 text-[10px] font-black text-slate-600" data-stat="LUK" data-delta="10">+10</button>
                            <button class="stat-adjust-btn py-1 rounded-lg border border-slate-200 bg-slate-50 text-[10px] font-black text-slate-600" data-stat="LUK" data-delta="-1">-1</button>
                            <button class="stat-adjust-btn py-1 rounded-lg border border-slate-200 bg-slate-50 text-[10px] font-black text-slate-600" data-stat="LUK" data-delta="-10">-10</button>
                        </div>
                    </div>
                    <div class="flex flex-col justify-end items-end">
                        <span class="text-[10px] text-slate-400 font-bold uppercase tracking-widest">Stat Point</span>
                        <span class="text-2xl font-black text-indigo-600" id="status-stat-points">0</span>
                    </div>
                </div>
            </div>

            <!-- Detailed Stats -->
            <div class="bg-slate-800 rounded-3xl p-6 text-white mb-6">
                <div class="flex items-center justify-between mb-4 border-b border-slate-700 pb-2">
                    <h3 class="text-xs font-bold text-slate-400 uppercase tracking-tighter">äºŒæ¬¡ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹</h3>
                    <div class="flex items-center gap-2">
                        <button id="secondary-breakdown-btn" class="text-slate-400 hover:text-white transition-colors text-xs font-bold flex items-center gap-1">
                            <i class="fas fa-list"></i> è©³ç´°
                        </button>
                        <button id="secondary-info-btn" class="text-slate-400 hover:text-white transition-colors text-xs font-bold flex items-center gap-1">
                            <i class="fas fa-circle-info"></i> Info
                        </button>
                    </div>
                </div>
                <div class="grid grid-cols-2 gap-4 text-xs">
                    <div class="flex justify-between border-b border-slate-700 pb-1"><span>æœ€å¤§HP</span><span id="stat-max-hp">0</span></div>
                    <div class="flex justify-between border-b border-slate-700 pb-1"><span>æœ€å¤§CP</span><span id="stat-max-mp">0</span></div>
                    <div class="flex justify-between border-b border-slate-700 pb-1"><span>ç‰©ç†æ”»æ’ƒåŠ›</span><span id="stat-atk-flat">0</span></div>
                    <div class="flex justify-between border-b border-slate-700 pb-1"><span>é­”æ³•æ”»æ’ƒåŠ›</span><span id="stat-magic-atk">0</span></div>
                    <div class="flex justify-between border-b border-slate-700 pb-1"><span>é˜²å¾¡åŠ›</span><span id="stat-def-flat">0</span></div>
                    <div class="flex justify-between border-b border-slate-700 pb-1"><span>å‘½ä¸­</span><span id="stat-hit">0</span></div>
                    <div class="flex justify-between border-b border-slate-700 pb-1"><span>å›é¿</span><span id="stat-eva">0%</span></div>
                    <div class="flex justify-between border-b border-slate-700 pb-1"><span>ã‚¯ãƒªãƒ†ã‚£ã‚«ãƒ«ç‡</span><span id="stat-crit">0%</span></div>
                    <div class="flex justify-between border-b border-slate-700 pb-1"><span>è¿½åŠ ãƒ€ãƒ¡ãƒ¼ã‚¸%</span><span id="stat-dmg">0%</span></div>
                    <div class="flex justify-between border-b border-slate-700 pb-1"><span>è¿½åŠ é˜²å¾¡%</span><span id="stat-dr">0%</span></div>
                    <div class="flex justify-between border-b border-slate-700 pb-1"><span>ãƒ‰ãƒ­ãƒƒãƒ—ç‡è£œæ­£</span><span id="stat-drop">0%</span></div>
                    <div class="flex justify-between border-b border-slate-700 pb-1"><span>ã‚¨ãƒªãƒ¼ãƒˆé­é‡ç‡</span><span id="stat-elite-encounter">0%</span></div>
                    <div class="flex justify-between border-b border-slate-700 pb-1"><span>ã‚´ãƒ¼ãƒ«ãƒ‰ç²å¾—é‡è£œæ­£</span><span id="stat-gold-gain">0%</span></div>
                    <div class="flex justify-between border-b border-slate-700 pb-1"><span>çµŒé¨“å€¤ç²å¾—é‡è£œæ­£</span><span id="stat-exp-bonus">0%</span></div>
                </div>
            </div>

            <!-- Equipment -->
            <div id="active-preset-tags" class="mb-3 px-1 text-[10px] font-black text-slate-500 flex flex-wrap items-center gap-1"></div>
            <div class="space-y-3 mb-12">
                <div class="bg-white p-4 rounded-2xl border shadow-sm">
                    <div class="text-[9px] text-slate-400 font-black uppercase tracking-widest mb-1 flex items-center gap-1">
                        <i class="fas fa-khanda text-slate-300"></i>
                        <span>Weapon Slot</span>
                    </div>
                    <div id="equip-weapon" class="font-black text-[11px] leading-tight whitespace-normal break-words">ãªã—</div>
                    <div id="weapon-val" class="mt-1"></div>
                </div>
                <div class="bg-white p-4 rounded-2xl border shadow-sm">
                    <div class="text-[9px] text-slate-400 font-black uppercase tracking-widest mb-1 flex items-center gap-1">
                        <i class="fas fa-shield-halved text-slate-300"></i>
                        <span>Armor Slot</span>
                    </div>
                    <div id="equip-armor" class="font-black text-[11px] leading-tight whitespace-normal break-words">ãªã—</div>
                    <div id="armor-val" class="mt-1"></div>
                </div>
                <div class="bg-white p-4 rounded-2xl border shadow-sm">
                    <div class="text-[9px] text-slate-400 font-black uppercase tracking-widest mb-1 flex items-center gap-1">
                        <i class="fas fa-helmet-safety text-slate-300"></i>
                        <span>Helm Slot</span>
                    </div>
                    <div id="equip-head" class="font-black text-[11px] leading-tight whitespace-normal break-words">ãªã—</div>
                    <div id="head-val" class="mt-1"></div>
                </div>
                <div class="bg-white p-4 rounded-2xl border shadow-sm">
                    <div class="text-[9px] text-slate-400 font-black uppercase tracking-widest mb-1 flex items-center gap-1">
                        <i class="fas fa-hand text-slate-300"></i>
                        <span>Hand Slot</span>
                    </div>
                    <div id="equip-hands" class="font-black text-[11px] leading-tight whitespace-normal break-words">ãªã—</div>
                    <div id="hands-val" class="mt-1"></div>
                </div>
                <div class="bg-white p-4 rounded-2xl border shadow-sm">
                    <div class="text-[9px] text-slate-400 font-black uppercase tracking-widest mb-1 flex items-center gap-1">
                        <i class="fas fa-shoe-prints text-slate-300"></i>
                        <span>Foot Slot</span>
                    </div>
                    <div id="equip-feet" class="font-black text-[11px] leading-tight whitespace-normal break-words">ãªã—</div>
                    <div id="feet-val" class="mt-1"></div>
                </div>
                <div class="bg-white p-4 rounded-2xl border shadow-sm">
                    <div class="text-[9px] text-slate-400 font-black uppercase tracking-widest mb-1 flex items-center gap-1">
                        <i class="fas fa-gem text-slate-300"></i>
                        <span>Accessory Slot 1</span>
                    </div>
                    <div id="equip-accessory1" class="font-black text-[11px] leading-tight whitespace-normal break-words">ãªã—</div>
                    <div id="accessory1-val" class="mt-1"></div>
                </div>
                <div class="bg-white p-4 rounded-2xl border shadow-sm">
                    <div class="text-[9px] text-slate-400 font-black uppercase tracking-widest mb-1 flex items-center gap-1">
                        <i class="fas fa-gem text-slate-300"></i>
                        <span>Accessory Slot 2</span>
                    </div>
                    <div id="equip-accessory2" class="font-black text-[11px] leading-tight whitespace-normal break-words">ãªã—</div>
                    <div id="accessory2-val" class="mt-1"></div>
                </div>
            </div>
        </section>

        <!-- SKILL PAGE -->
        <section id="page-skill" class="page bg-slate-50 flex-col h-full min-h-0">
            <div class="p-4 bg-white border-b shrink-0">
                <div class="flex items-center justify-between">
                    <h2 class="text-xl font-black flex items-center gap-2"><i class="fas fa-star"></i> ã‚¹ã‚­ãƒ«</h2>
                </div>
            </div>
            <div class="flex-1 p-4 overflow-y-auto">
                <div class="bg-white border rounded-2xl p-6 text-center text-slate-500 font-bold">-</div>
            </div>
        </section>

        <!-- INVENTORY PAGE -->
        <section id="page-inventory" class="page p-4 bg-slate-50">
            <div class="flex items-center justify-between mb-4 px-2">
                <h2 class="text-xl font-black flex items-center gap-2"><i class="fas fa-box-open"></i> æŒã¡ç‰©</h2>
                <span class="text-[10px] font-bold text-slate-400 bg-slate-200 px-2 py-0.5 rounded-full"><span id="inv-count">0</span> / âˆ</span>
            </div>
            <div id="inventory-list" class="flex-1 overflow-y-auto space-y-2 pb-12"></div>
            <div class="bg-white rounded-2xl border p-3 mt-3 shadow-sm">
                <div class="flex items-center justify-between mb-2">
                    <div class="flex items-center gap-0.5">
                        <button id="build-preset-open" class="px-3 py-2 rounded-xl border text-[8px] font-black flex items-center gap-2 bg-indigo-50 text-indigo-600 border-indigo-200">
                            <i class="fas fa-layer-group"></i>
                            <span>ãƒ—ãƒªã‚»ãƒƒãƒˆ</span>
                        </button>
                        
                        <button id="inv-sort-toggle" onclick="toggleInventorySort()" class="px-3 py-2 rounded-xl border text-[8px] font-black flex items-center gap-2 bg-slate-50 text-slate-500 border-slate-200">
                            <i class="fas fa-clock"></i>
                            <span id="inv-sort-label">å…¥æ‰‹é †</span>
                        </button>
                        <button id="loot-filter-open" class="px-3 py-2 rounded-xl border text-[8px] font-black flex items-center gap-2 bg-slate-50 text-slate-500 border-slate-200">
                            <i class="fas fa-filter"></i>
                            <span>å–å¾—è¨­å®š</span>
                        </button>
                        <button id="bulk-sell-open" class="px-3 py-2 rounded-xl border text-[8px] font-black flex items-center gap-2 bg-slate-50 text-slate-500 border-slate-200">
                            <i class="fas fa-sack-dollar"></i>
                            <span>ä¸€æ‹¬å£²å´</span>
                        </button>
                    </div>
                </div>
                <div class="grid grid-cols-8 gap-2 text-[10px] font-bold">
                    <button data-inv-filter="all" onclick="setInventoryFilter('all')" class="inv-filter-btn py-2 rounded-xl border">å…¨ã¦</button>
                    <button data-inv-filter="weapon" onclick="setInventoryFilter('weapon')" class="inv-filter-btn py-2 rounded-xl border">æ­¦å™¨</button>
                    <button data-inv-filter="armor" onclick="setInventoryFilter('armor')" class="inv-filter-btn py-2 rounded-xl border">é§</button>
                    <button data-inv-filter="head" onclick="setInventoryFilter('head')" class="inv-filter-btn py-2 rounded-xl border">å…œ</button>
                    <button data-inv-filter="hands" onclick="setInventoryFilter('hands')" class="inv-filter-btn py-2 rounded-xl border">æ‰‹</button>
                    <button data-inv-filter="feet" onclick="setInventoryFilter('feet')" class="inv-filter-btn py-2 rounded-xl border">è¶³</button>
                    <button data-inv-filter="accessory" onclick="setInventoryFilter('accessory')" class="inv-filter-btn py-2 rounded-xl border col-span-3">è£…é£¾å“</button>
                    <button data-inv-filter="potion" onclick="setInventoryFilter('potion')" class="inv-filter-btn py-2 rounded-xl border col-span-3">è–¬</button>
                </div>
            </div>
        </section>

        <!-- LOG PAGE -->
        <section id="page-log" class="page p-4 bg-slate-900 text-slate-300 font-mono text-[10px]">
            <h2 class="text-slate-500 border-b border-slate-800 pb-2 mb-2 uppercase tracking-widest font-black">System History Log</h2>
            <div id="full-log-container" class="flex-1 overflow-y-auto space-y-1"></div>
        </section>

        <!-- HELP PAGE -->
        <section id="page-help" class="page p-4 bg-slate-50">
            <div class="flex items-start justify-between mb-4 px-2">
                <h2 class="text-xl font-black flex items-center gap-2"><i class="fas fa-circle-question"></i> ãƒ˜ãƒ«ãƒ—</h2>
            </div>
            <div class="bg-white rounded-3xl p-6 shadow-sm space-y-4">
                <div>

            <p class="text-[10px] text-slate-500 mt-2">
              ã„ã¤ã‚‚éŠã‚“ã§ãã‚Œã¦ã‚ã‚ŠãŒã¨ã†ã”ã–ã„ã¾ã™ã€‚
            </p>
         </div>
               
                <div class="space-y-4 text-sm">

                    <div class="rounded-2xl border border-slate-100 bg-slate-50 p-4 space-y-2">
                        <div class="text-[10px] font-black text-slate-400 uppercase tracking-widest">è£…å‚™å¼·åŒ–</div>
                        <ul class="text-xs text-slate-500 space-y-1">
                            <li>å¯¾è±¡: ãƒãƒ¼ã‚·ãƒ§ãƒ³ä»¥å¤–ã®è£…å‚™å“ï¼ˆæ­¦å™¨/é˜²å…·/è£…é£¾å“ï¼‰ã€‚</li>
                            <li>æˆåŠŸæ™‚ã¯åŸºç¤ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ãŒå¼·åŒ–å€¤1ã”ã¨ã«+3%å¢—åŠ ï¼ˆæ¬¡ã®å¼·åŒ–å€¤åˆ†ã ã‘åæ˜ ï¼‰ã€‚</li>
                            <li>å¼·åŒ–è²»ç”¨ã¯å¼·åŒ–å€¤ãŒé«˜ã„ã»ã©ä¸Šæ˜‡ã€‚</li>
                            <li>å¤±æ•—ãƒšãƒŠãƒ«ãƒ†ã‚£: +5ã¾ã§å¤‰åŒ–ãªã— / +6ã€œ+9ã¯1ä½ä¸‹ / +10ä»¥ä¸Šã¯ç ´æã—ã¦ä¿®ç†ãŒå¿…è¦ã€‚</li>
                        </ul>
                    </div>
                    
                    <div class="rounded-2xl border border-slate-100 bg-slate-50 p-4">
                        <div class="text-xs text-slate-500 font-bold">-</div>
                    </div>

                </div>
            </div>
        </section>

        <!-- FEEDBACK PAGE -->
        <section id="page-feedback" class="page p-4 bg-slate-50 flex-col gap-3">
            <div class="flex items-start justify-between px-2">
                <h2 class="text-xl font-black flex items-center gap-2"><i class="fas fa-comment-dots"></i> æ„Ÿæƒ³ãƒ»è¦æœ›</h2>
            </div>
            <div class="bg-white rounded-3xl p-3 shadow-sm flex-1 min-h-0">
                <iframe class="feedback-embed" src="https://docs.google.com/forms/d/e/1FAIpQLSehb6HL2A69toW9cmKpbNiUYmkd8FCZRXImFKVzzcPbPwu2sw/viewform?embedded=true" frameborder="0" marginheight="0" marginwidth="0">èª­ã¿è¾¼ã‚“ã§ã„ã¾ã™â€¦</iframe>
            </div>
        </section>

    </main>

    <!-- BOTTOM NAV -->
    <div id="bottom-menu-backdrop" class="fixed inset-0 z-[45] hidden" aria-hidden="true"></div>
    <div id="bottom-menu-panel" class="fixed left-1/2 -translate-x-1/2 bottom-20 z-[60] hidden" style="width: min(420px, calc(100% - 2rem));">
        <div class="bg-white border border-slate-200 rounded-2xl shadow-2xl px-3 py-3">
            <div class="grid grid-cols-5 gap-2 text-[10px] font-black text-slate-700">
                
                <button onclick="openBottomMenuSave()" class="flex flex-col items-center justify-center gap-1 rounded-xl border border-slate-200 bg-slate-50 py-2 active:scale-95 transition-transform">
                    <i class="fas fa-floppy-disk text-base text-slate-500"></i>
                    ã‚»ãƒ¼ãƒ–
                </button>
                <button onclick="openBottomMenuHelp()" class="flex flex-col items-center justify-center gap-1 rounded-xl border border-slate-200 bg-slate-50 py-2 active:scale-95 transition-transform">
                    <i class="fas fa-circle-question text-base text-slate-500"></i>
                    ãƒ˜ãƒ«ãƒ—
                </button>
                <button onclick="openBottomMenuTweet(event)" class="flex flex-col items-center justify-center gap-1 rounded-xl border border-slate-200 bg-slate-50 py-2 active:scale-95 transition-transform">
                    <i class="fa-brands fa-twitter text-base text-slate-500"></i>
                    ãƒ„ã‚¤ãƒ¼ãƒˆ
                </button>
                <button onclick="openBottomMenuFeedback()" class="flex flex-col items-center justify-center gap-1 rounded-xl border border-slate-200 bg-slate-50 py-2 active:scale-95 transition-transform">
                    <i class="fas fa-comment-dots text-base text-slate-500"></i>
                    æ„Ÿæƒ³ãƒ»è¦æœ›
                </button>
            </div>
        </div>
    </div>
    <nav class="h-16 border-t bg-white grid grid-cols-6 shrink-0 items-center pb-1 z-50 relative shadow-[0_-2px_10px_rgba(0,0,0,0.05)]">
        <button onclick="switchPage('battle')" id="nav-battle" class="flex-1 h-full flex flex-col items-center justify-center gap-1 text-slate-300 transition-all">
            <i class="fas fa-hand-fist text-xl"></i><span class="text-[9px] font-black">æˆ¦é—˜</span>
        </button>
        <button onclick="switchPage('status')" id="nav-status" class="flex-1 h-full flex flex-col items-center justify-center gap-1 text-slate-300 transition-all">
            <i class="fas fa-user-circle text-xl"></i><span class="text-[9px] font-black">èƒ½åŠ›</span>
        </button>
        <button onclick="switchPage('skill')" id="nav-skill" class="flex-1 h-full flex flex-col items-center justify-center gap-1 text-slate-300 transition-all relative">
            <i class="fas fa-star text-xl"></i><span class="text-[9px] font-black">ã‚¹ã‚­ãƒ«</span>
        </button>
        <button onclick="switchPage('inventory')" id="nav-inventory" class="flex-1 h-full flex flex-col items-center justify-center gap-1 text-slate-300 transition-all relative">
            <i class="fas fa-box-open text-xl"></i><span class="text-[9px] font-black">è£…å‚™</span>
        </button>
        <button onclick="switchPage('log')" id="nav-log" class="flex-1 h-full flex flex-col items-center justify-center gap-1 text-slate-300 transition-all">
            <i class="fas fa-scroll text-xl"></i><span class="text-[9px] font-black">å±¥æ­´</span>
        </button>
        <button onclick="toggleBottomMenu()" id="nav-help" aria-controls="bottom-menu-panel" aria-expanded="false" class="flex-1 h-full flex flex-col items-center justify-center gap-1 text-slate-300 transition-all">
            <i class="fas fa-bars text-xl"></i><span class="text-[9px] font-black">ãƒ¡ãƒ‹ãƒ¥ãƒ¼</span>
        </button>
        <button id="nav-save" class="hidden" aria-hidden="true" tabindex="-1"></button>
    </nav>

    <!-- LOOT MODAL -->
    <div id="loot-modal" class="fixed inset-0 bg-slate-900/80 z-[100] hidden items-center justify-center p-6 backdrop-blur-sm">
        <div class="bg-white w-full max-w-xs rounded-[2rem] overflow-hidden shadow-2xl transform scale-100 p-8 text-center border-b-8 border-slate-200">
            <div class="text-6xl mb-6">ğŸ“¦</div>
            <h3 class="font-black text-xl mb-2">æˆ¦åˆ©å“ã‚’ç™ºè¦‹ï¼</h3>
            <div id="loot-display" class="bg-slate-50 rounded-2xl p-6 my-4 border border-slate-100"></div>
            <div class="flex gap-3">
                <button onclick="closeLoot(false)" class="flex-1 py-4 text-sm font-bold text-slate-400 bg-slate-100 rounded-2xl">æ¨ã¦ã‚‹</button>
                <button onclick="closeLoot(true)" class="flex-1 py-4 text-sm font-bold text-white bg-slate-800 rounded-2xl shadow-lg">æ‹¾ã†</button>
            </div>
        </div>
    </div>

    <!-- LOOT FILTER MODAL -->
    <div id="loot-filter-modal" class="fixed inset-0 bg-slate-900/80 z-[105] hidden items-center justify-center p-6 backdrop-blur-sm">
        <div class="bg-white w-full max-w-sm rounded-[2rem] overflow-hidden shadow-2xl p-6 border-b-8 border-slate-200">
            <div class="flex items-center justify-between mb-4">
                <h3 class="font-black text-lg text-slate-800 flex items-center gap-2">
                    <i class="fas fa-filter text-slate-500"></i> å–å¾—ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼
                </h3>
                <button id="loot-filter-close" class="text-slate-400 hover:text-slate-700 text-lg"><i class="fas fa-xmark"></i></button>
            </div>
            <p class="text-xs text-slate-500 mb-4">ãƒã‚§ãƒƒã‚¯ã—ãŸãƒ¬ã‚¢åº¦ã¯æ‹¾ã‚ãšã€å‰Šé™¤æ‰±ã„ã«ã—ã¾ã™ã€‚</p>
            <div class="space-y-2 text-sm">
                <label class="flex items-center justify-between bg-slate-50 border border-slate-100 rounded-xl px-3 py-2">
                    <span class="flex items-center gap-2 font-bold rarity-normal">
                        <input type="checkbox" class="loot-filter-checkbox accent-slate-800" data-rarity="normal">
                        ãƒãƒ¼ãƒãƒ«
                    </span>
                    <span class="text-[10px] text-slate-400 font-bold">æ‹¾ã‚ãªã„</span>
                </label>
                <label class="flex items-center justify-between bg-slate-50 border border-slate-100 rounded-xl px-3 py-2">
                    <span class="flex items-center gap-2 font-bold rarity-magic">
                        <input type="checkbox" class="loot-filter-checkbox accent-slate-800" data-rarity="magic">
                        ãƒã‚¸ãƒƒã‚¯
                    </span>
                    <span class="text-[10px] text-slate-400 font-bold">æ‹¾ã‚ãªã„</span>
                </label>
                <label class="flex items-center justify-between bg-slate-50 border border-slate-100 rounded-xl px-3 py-2">
                    <span class="flex items-center gap-2 font-bold rarity-rare">
                        <input type="checkbox" class="loot-filter-checkbox accent-slate-800" data-rarity="rare">
                        ãƒ¬ã‚¢
                    </span>
                    <span class="text-[10px] text-slate-400 font-bold">æ‹¾ã‚ãªã„</span>
                </label>
                <label class="flex items-center justify-between bg-slate-50 border border-slate-100 rounded-xl px-3 py-2">
                    <span class="flex items-center gap-2 font-bold rarity-epic">
                        <input type="checkbox" class="loot-filter-checkbox accent-slate-800" data-rarity="epic">
                        ã‚¨ãƒ”ãƒƒã‚¯
                    </span>
                    <span class="text-[10px] text-slate-400 font-bold">æ‹¾ã‚ãªã„</span>
                </label>
                <label class="flex items-center justify-between bg-slate-50 border border-slate-100 rounded-xl px-3 py-2">
                    <span class="flex items-center gap-2 font-bold rarity-legendary">
                        <input type="checkbox" class="loot-filter-checkbox accent-slate-800" data-rarity="legendary">
                        ãƒ¬ã‚¸ã‚§ãƒ³ãƒ€ãƒªãƒ¼
                    </span>
                    <span class="text-[10px] text-slate-400 font-bold">æ‹¾ã‚ãªã„</span>
                </label>
                <label class="hidden flex items-center justify-between bg-slate-50 border border-slate-100 rounded-xl px-3 py-2">
                    <span class="flex items-center gap-2 font-bold rarity-mythic">
                        <input type="checkbox" class="loot-filter-checkbox accent-slate-800" data-rarity="mythic">
                        ãƒŸã‚·ãƒƒã‚¯
                    </span>
                    <span class="text-[10px] text-slate-400 font-bold">æ‹¾ã‚ãªã„</span>
                </label>
            </div>
            <button id="loot-filter-close-bottom" class="mt-5 w-full bg-slate-800 text-white font-black py-3 rounded-2xl shadow-lg">é–‰ã˜ã‚‹</button>
        </div>
    </div>

    <!-- BULK SELL MODAL -->
    <div id="bulk-sell-modal" class="fixed inset-0 bg-slate-900/80 z-[106] hidden items-center justify-center p-6 backdrop-blur-sm">
        <div class="bg-white w-full max-w-sm rounded-[2rem] overflow-hidden shadow-2xl p-6 border-b-8 border-amber-100">
            <div class="flex items-center justify-between mb-4">
                <h3 class="font-black text-lg text-slate-800 flex items-center gap-2">
                    <i class="fas fa-sack-dollar text-amber-500"></i> ä¸€æ‹¬å£²å´
                </h3>
                <button id="bulk-sell-close" class="text-slate-400 hover:text-slate-700 text-lg"><i class="fas fa-xmark"></i></button>
            </div>
            <p class="text-xs text-slate-500 mb-4">å£²ã‚ŠãŸã„ãƒ¬ã‚¢åº¦ã‚’è¤‡æ•°é¸æŠã—ã¦ã€ä¸€æ‹¬ã§å£²å´ã—ã¾ã™ã€‚</p>
            <div class="space-y-2 text-sm">
                <label class="flex items-center justify-between bg-slate-50 border border-slate-100 rounded-xl px-3 py-2">
                    <span class="flex items-center gap-2 font-bold rarity-normal">
                        <input type="checkbox" class="bulk-sell-checkbox accent-amber-500" data-rarity="normal">
                        ãƒãƒ¼ãƒãƒ«
                    </span>
                </label>
                <label class="flex items-center justify-between bg-slate-50 border border-slate-100 rounded-xl px-3 py-2">
                    <span class="flex items-center gap-2 font-bold rarity-magic">
                        <input type="checkbox" class="bulk-sell-checkbox accent-amber-500" data-rarity="magic">
                        ãƒã‚¸ãƒƒã‚¯
                    </span>
                </label>
                <label class="flex items-center justify-between bg-slate-50 border border-slate-100 rounded-xl px-3 py-2">
                    <span class="flex items-center gap-2 font-bold rarity-rare">
                        <input type="checkbox" class="bulk-sell-checkbox accent-amber-500" data-rarity="rare">
                        ãƒ¬ã‚¢
                    </span>
                </label>
                <label class="flex items-center justify-between bg-slate-50 border border-slate-100 rounded-xl px-3 py-2">
                    <span class="flex items-center gap-2 font-bold rarity-epic">
                        <input type="checkbox" class="bulk-sell-checkbox accent-amber-500" data-rarity="epic">
                        ã‚¨ãƒ”ãƒƒã‚¯
                    </span>
                </label>
                <label class="flex items-center justify-between bg-slate-50 border border-slate-100 rounded-xl px-3 py-2">
                    <span class="flex items-center gap-2 font-bold rarity-legendary">
                        <input type="checkbox" class="bulk-sell-checkbox accent-amber-500" data-rarity="legendary">
                        ãƒ¬ã‚¸ã‚§ãƒ³ãƒ€ãƒªãƒ¼
                    </span>
                </label>
                <label class="hidden flex items-center justify-between bg-slate-50 border border-slate-100 rounded-xl px-3 py-2">
                    <span class="flex items-center gap-2 font-bold rarity-mythic">
                        <input type="checkbox" class="bulk-sell-checkbox accent-amber-500" data-rarity="mythic">
                        ãƒŸã‚·ãƒƒã‚¯
                    </span>
                </label>
            </div>
            <div class="mt-5 space-y-2">
                <button id="bulk-sell-confirm" class="w-full bg-amber-500 text-white font-black py-3 rounded-2xl shadow-lg">å£²å´ï¼</button>
                <button id="bulk-sell-close-bottom" class="w-full bg-slate-100 text-slate-500 font-black py-3 rounded-2xl shadow">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
            </div>
        </div>
    </div>

    <!-- EQUIP SLOT MODAL -->
    <div id="equip-slot-modal" class="fixed inset-0 bg-slate-900/80 z-[108] hidden items-center justify-center p-6 backdrop-blur-sm">
        <div class="bg-white w-full max-w-sm rounded-[2rem] overflow-hidden shadow-2xl p-6 border-b-8 border-slate-200">
            <div class="flex items-center justify-between mb-4">
                <h3 id="equip-slot-title" class="font-black text-lg text-slate-800 flex items-center gap-2"></h3>
                <button id="equip-slot-close" class="text-slate-400 hover:text-slate-700 text-lg"><i class="fas fa-xmark"></i></button>
            </div>
            <div class="space-y-3">
                <div class="rounded-2xl border border-slate-200 bg-slate-50 p-3 space-y-2">
                    <div id="equip-slot-1-label" class="flex items-center justify-between text-[11px] font-black text-slate-600"></div>
                    <div>
                        <button id="equip-slot-1" class="w-full bg-slate-800 text-white font-black py-2 rounded-2xl shadow-lg text-[11px] flex items-center justify-center gap-2">
                            <i class="fas fa-shield"></i>è£…å‚™
                        </button>
                    </div>
                </div>
                <div class="rounded-2xl border border-slate-200 bg-slate-50 p-3 space-y-2">
                    <div id="equip-slot-2-label" class="flex items-center justify-between text-[11px] font-black text-slate-600"></div>
                    <div>
                        <button id="equip-slot-2" class="w-full bg-slate-800 text-white font-black py-2 rounded-2xl shadow-lg text-[11px] flex items-center justify-center gap-2">
                            <i class="fas fa-shield"></i>è£…å‚™
                        </button>
                    </div>
                </div>
            </div>
            <button id="equip-slot-close-bottom" class="mt-5 w-full bg-slate-100 text-slate-500 font-black py-3 rounded-2xl shadow">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
        </div>
    </div>

    <!-- BUILD PRESET MODAL -->
    <div id="build-preset-modal" class="fixed inset-0 bg-slate-900/80 z-[111] hidden items-center justify-center p-6 backdrop-blur-sm">
        <div class="bg-white w-full max-w-md rounded-[2rem] overflow-hidden shadow-2xl p-6 border-b-8 border-indigo-100 max-h-[88dvh] overflow-y-auto">
            <div class="flex items-center justify-between mb-3">
                <h3 class="font-black text-lg text-slate-800 flex items-center gap-2"><i class="fas fa-layer-group text-indigo-500"></i> ãƒ—ãƒªã‚»ãƒƒãƒˆ</h3>
                <button id="build-preset-close" class="text-slate-400 hover:text-slate-700 text-lg"><i class="fas fa-xmark"></i></button>
            </div>
            <p class="text-[11px] text-slate-500 mb-4">ä¿å­˜å†…å®¹ã¯ç¾åœ¨æœªå®Ÿè£…ã§ã™ã€‚</p>
            <div id="build-preset-list" class="space-y-3"></div>
            <button id="build-preset-close-bottom" class="mt-5 w-full bg-slate-100 text-slate-500 font-black py-3 rounded-2xl shadow">é–‰ã˜ã‚‹</button>
        </div>
    </div>

    <!-- COMPARE MODAL -->
    <div id="compare-modal" class="fixed inset-0 bg-slate-900/80 z-[112] hidden items-center justify-center p-6 backdrop-blur-sm">
        <div class="bg-white w-full max-w-sm rounded-[2rem] overflow-hidden shadow-2xl p-6 border-b-8 border-emerald-100">
            <div class="flex items-center justify-between mb-3">
                <h3 class="font-black text-lg text-slate-800 flex items-center gap-2"><i class="fas fa-scale-balanced"></i> è£…å‚™æ¯”è¼ƒ</h3>
                <button id="compare-modal-close" class="text-slate-400 hover:text-slate-700 text-lg"><i class="fas fa-xmark"></i></button>
            </div>
            <div class="text-[11px] text-slate-500 font-bold flex items-center justify-between gap-2">
                <div class="flex-1 min-w-0">
                    <div class="text-[9px] text-slate-400 uppercase tracking-widest">ç¾åœ¨è£…å‚™</div>
                    <div id="compare-modal-equipped" class="text-slate-700 font-black truncate"></div>
                </div>
                <div class="flex-1 min-w-0 text-right">
                    <div class="text-[9px] text-slate-400 uppercase tracking-widest">å€™è£œè£…å‚™</div>
                    <div id="compare-modal-candidate" class="text-slate-800 font-black truncate"></div>
                </div>
            </div>
            <div class="mt-4 space-y-3">
                <div>
                    <div class="text-[10px] font-black text-emerald-500 uppercase tracking-widest">å¢—åŠ </div>
                    <div id="compare-modal-increase" class="mt-1 space-y-1"></div>
                </div>
                <div>
                    <div class="text-[10px] font-black text-rose-500 uppercase tracking-widest">æ¸›å°‘</div>
                    <div id="compare-modal-decrease" class="mt-1 space-y-1"></div>
                </div>
            </div>
            <div class="mt-4 space-y-2">
                <button id="compare-modal-equip" class="w-full bg-slate-800 text-white font-black py-3 rounded-2xl shadow-lg flex items-center justify-center gap-2">
                    <i class="fas fa-shield"></i>è£…å‚™ã™ã‚‹
                </button>
                <button id="compare-modal-close-bottom" class="w-full bg-slate-100 text-slate-500 font-black py-3 rounded-2xl shadow">é–‰ã˜ã‚‹</button>
            </div>
        </div>
    </div>

    <!-- CONFIRM MODAL -->
    <div id="confirm-modal" class="fixed inset-0 bg-slate-900/80 z-[125] hidden items-center justify-center p-6 backdrop-blur-sm">
        <div class="bg-white w-full max-w-sm rounded-[2rem] overflow-hidden shadow-2xl p-6 border-b-8 border-rose-100 text-center space-y-4">
            <div class="text-rose-500 text-3xl"><i class="fas fa-triangle-exclamation"></i></div>
            <h3 class="text-base font-black text-slate-800">ç¢ºèª</h3>
            <p id="confirm-modal-message" class="text-xs text-slate-500"></p>
            <div class="grid grid-cols-2 gap-3 pt-2">
                <button id="confirm-modal-cancel" class="py-2 rounded-xl bg-slate-100 text-slate-600 text-[10px] font-black">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
                <button id="confirm-modal-ok" class="py-2 rounded-xl bg-rose-500 text-white text-[10px] font-black hover:bg-rose-600 transition">å®Ÿè¡Œ</button>
            </div>
        </div>
    </div>

    <!-- ENHANCE MODAL -->
    <div id="enhance-modal" class="fixed inset-0 bg-slate-900/80 z-[130] hidden items-center justify-center p-6 backdrop-blur-sm">
        <div class="bg-white w-full max-w-sm rounded-[2rem] overflow-hidden shadow-2xl p-6 border-b-8 border-slate-200">
            <div class="flex items-center justify-between mb-4">
                <h3 id="enhance-modal-title" class="font-black text-lg text-slate-800 flex items-center gap-2"></h3>
                <button id="enhance-modal-close" class="text-slate-400 hover:text-slate-700 text-lg"><i class="fas fa-xmark"></i></button>
            </div>
            <div id="enhance-modal-info" class="space-y-2 text-xs text-slate-600">
                <div class="flex items-center justify-between">
                    <span class="font-bold text-slate-500">ç¾åœ¨ã®å¼·åŒ–å€¤</span>
                    <span id="enhance-modal-level" class="font-black text-slate-700"></span>
                </div>
                <div class="flex items-center justify-between">
                    <span class="font-bold text-slate-500">å¼·åŒ–è²»ç”¨</span>
                    <span id="enhance-modal-cost" class="font-black text-slate-700"></span>
                </div>
                <div class="flex items-center justify-between">
                    <span class="font-bold text-slate-500">æˆåŠŸæ™‚ã‚¢ãƒƒãƒ—è¦‹è¾¼ã¿</span>
                    <span id="enhance-modal-preview" class="font-black text-emerald-600"></span>
                </div>
                <div id="enhance-modal-warning" class="text-[10px] text-rose-500 font-bold"></div>
            </div>
                        <div id="enhance-modal-progress" class="hidden mt-6 text-center space-y-3">
                <div class="w-16 h-16 mx-auto rounded-2xl bg-slate-100 flex items-center justify-center text-slate-600 enhance-rattle">
                    <i class="fas fa-hammer text-2xl"></i>
                </div>
                <div class="font-black text-slate-700">é›å†¶ä¸­...</div>
                <div class="text-[10px] text-slate-400">ã‚¿ãƒƒãƒ—ã§ã‚¹ã‚­ãƒƒãƒ—</div>
            </div>
            <div id="enhance-modal-result" class="hidden mt-6 text-center space-y-3">
                <div id="enhance-modal-result-icon" class="w-16 h-16 mx-auto rounded-2xl bg-slate-100 flex items-center justify-center text-2xl"></div>
                <div id="enhance-modal-result-title" class="font-black text-lg"></div>
                <div id="enhance-modal-result-detail" class="text-xs font-bold text-slate-600"></div>
                <div id="enhance-modal-result-extra" class="text-[10px] text-slate-400"></div>
                <div class="text-[10px] text-slate-400">ã‚¿ãƒƒãƒ—ã§é–‰ã˜ã‚‹</div>
            </div>
            <button id="enhance-modal-repeat" class="mt-4 w-full bg-slate-800 text-white font-black py-2.5 rounded-xl shadow flex items-center justify-center gap-2">
                <i class="fas fa-hammer"></i>
                <span id="enhance-modal-repeat-label">å¼·åŒ–ã™ã‚‹</span>
            </button>
        </div>
    </div>

    <!-- STATUS BREAKDOWN MODAL -->
    <div id="status-breakdown-modal" class="fixed inset-0 bg-slate-900/80 z-[110] hidden items-center justify-center p-6 backdrop-blur-sm">
        <div class="bg-white w-full max-w-md rounded-[2rem] overflow-x-hidden overflow-y-auto max-h-[calc(100dvh-3rem)] no-scrollbar shadow-2xl p-6 border-b-8 border-slate-200">
            <div class="flex items-center justify-between mb-4">
                <h3 class="font-black text-lg text-slate-800 flex items-center gap-2">
                    <i class="fas fa-list text-slate-500"></i> ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹è©³ç´°
                </h3>
                <button id="status-breakdown-close" class="text-slate-400 hover:text-slate-700 text-lg"><i class="fas fa-xmark"></i></button>
            </div>
            <div class="space-y-4 text-xs">
                <div>
                    <div class="text-[10px] font-black text-slate-400 uppercase">Primary</div>
                    <div class="mt-2 space-y-1 text-slate-700 font-bold">
                        <div class="flex justify-between"><span>STR</span><span id="detail-primary-str">0(0+0)</span></div>
                        <div class="flex justify-between"><span>INT</span><span id="detail-primary-int">0(0+0)</span></div>
                        <div class="flex justify-between"><span>VIT</span><span id="detail-primary-vit">0(0+0)</span></div>
                        <div class="flex justify-between"><span>DEX</span><span id="detail-primary-dex">0(0+0)</span></div>
                        <div class="flex justify-between"><span>LUK</span><span id="detail-primary-luk">0(0+0)</span></div>
                    </div>
                </div>
                <div>
                    <div class="text-[10px] font-black text-slate-400 uppercase">Secondary</div>
                    <div class="mt-2 space-y-1 text-slate-700 font-bold">
                        <div class="flex justify-between"><span>æœ€å¤§HP</span><span id="detail-stat-max-hp">0(0+0)</span></div>
                        <div class="flex justify-between"><span>æœ€å¤§CP</span><span id="detail-stat-max-mp">0(0+0)</span></div>
                        <div class="flex justify-between"><span>ç‰©ç†æ”»æ’ƒåŠ›</span><span id="detail-stat-atk-flat">0(0+0)</span></div>
                        <div class="flex justify-between"><span>é­”æ³•æ”»æ’ƒåŠ›</span><span id="detail-stat-magic-atk">0(0+0)</span></div>
                        <div class="flex justify-between"><span>é˜²å¾¡åŠ›</span><span id="detail-stat-def-flat">0(0+0)</span></div>
                        <div class="flex justify-between"><span>å‘½ä¸­</span><span id="detail-stat-hit">0(0+0)</span></div>
                        <div class="flex justify-between"><span>å›é¿</span><span id="detail-stat-eva">0(0+0)%</span></div>
                        <div class="flex justify-between"><span>ã‚¯ãƒªãƒ†ã‚£ã‚«ãƒ«ç‡</span><span id="detail-stat-crit">0(0+0)%</span></div>
                        <div class="flex justify-between"><span>è¿½åŠ ãƒ€ãƒ¡ãƒ¼ã‚¸%</span><span id="detail-stat-dmg">0(0+0)%</span></div>
                        <div class="flex justify-between"><span>è¿½åŠ é˜²å¾¡%</span><span id="detail-stat-dr">0(0+0)%</span></div>
                        <div class="flex justify-between"><span>ãƒ‰ãƒ­ãƒƒãƒ—ç‡è£œæ­£</span><span id="detail-stat-drop">0(0+0)%</span></div>
                        <div class="flex justify-between"><span>ã‚¨ãƒªãƒ¼ãƒˆé­é‡ç‡</span><span id="detail-stat-elite-encounter">0(0+0)%</span></div>
                        <div class="flex justify-between"><span>ã‚´ãƒ¼ãƒ«ãƒ‰ç²å¾—é‡è£œæ­£</span><span id="detail-stat-gold-gain">0(0+0)%</span></div>
                        <div class="flex justify-between"><span>çµŒé¨“å€¤ç²å¾—é‡è£œæ­£</span><span id="detail-stat-exp-bonus">0(0+0)%</span></div>
                    </div>
                </div>
            </div>
            <button id="status-breakdown-close-bottom" class="mt-5 w-full bg-slate-800 text-white font-black py-3 rounded-2xl shadow-lg">é–‰ã˜ã‚‹</button>
        </div>
    </div>

    <!-- STATUS INFO MODAL -->
    <div id="status-info-modal" class="fixed inset-0 bg-slate-900/80 z-[110] hidden items-center justify-center p-6 backdrop-blur-sm">
        <div class="bg-white w-full max-w-md rounded-[2rem] overflow-x-hidden overflow-y-auto max-h-[calc(100dvh-3rem)] no-scrollbar shadow-2xl p-6 border-b-8 border-slate-200">
            <div class="flex items-center justify-between mb-4">
                <h3 class="font-black text-lg text-slate-800 flex items-center gap-2">
                    <i class="fas fa-circle-info text-slate-500"></i> ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹è§£èª¬
                </h3>
                <button id="status-info-close" class="text-slate-400 hover:text-slate-700 text-lg"><i class="fas fa-xmark"></i></button>
            </div>
            <div class="space-y-4 text-xs text-slate-600">
                <div>
                    <div class="text-[10px] font-black text-slate-400 uppercase">ä¸€æ¬¡ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹</div>
                    <ul class="mt-2 space-y-1">
                        <li><span class="font-bold text-slate-700">STRï¼ˆç­‹åŠ›ï¼‰</span>ï¼šç‰©ç†æ”»æ’ƒåŠ›ã®å…ƒã«ãªã‚‹å€¤ã§ã™ã€‚</li>
                        <li><span class="font-bold text-slate-700">INTï¼ˆçŸ¥åŠ›ï¼‰</span>ï¼šé­”æ³•æ”»æ’ƒåŠ›ã¨æœ€å¤§CPã®å…ƒã«ãªã‚‹å€¤ã§ã™ã€‚</li>
                        <li><span class="font-bold text-slate-700">VITï¼ˆä½“åŠ›ï¼‰</span>ï¼šæœ€å¤§HPã¨é˜²å¾¡åŠ›ã®å…ƒã«ãªã‚‹å€¤ã§ã™ã€‚</li>
                        <li><span class="font-bold text-slate-700">DEXï¼ˆå™¨ç”¨ï¼‰</span>ï¼šå‘½ä¸­ãƒ»å›é¿ãƒ»ã‚¯ãƒªãƒ†ã‚£ã‚«ãƒ«ç‡ã«å½±éŸ¿ã—ã¾ã™ã€‚</li>
                        <li><span class="font-bold text-slate-700">LUKï¼ˆé‹ï¼‰</span>ï¼šã‚¯ãƒªãƒ†ã‚£ã‚«ãƒ«è£œåŠ©ã¨å ±é…¬ç³»ãƒœãƒ¼ãƒŠã‚¹ã«å½±éŸ¿ã—ã¾ã™ã€‚</li>
                    </ul>
                </div>
                <div>
                    <div class="text-[10px] font-black text-slate-400 uppercase">äºŒæ¬¡ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹</div>
                    <ul class="mt-2 space-y-1">
                        <li>æœ€å¤§HP / æœ€å¤§CPï¼šæˆ¦é—˜ä¸­ã«ä½¿ã†ãƒªã‚½ãƒ¼ã‚¹ä¸Šé™ã§ã™ã€‚</li>
                        <li>ç‰©ç†æ”»æ’ƒåŠ› / é­”æ³•æ”»æ’ƒåŠ›ï¼šãƒ€ãƒ¡ãƒ¼ã‚¸è¨ˆç®—ã®åŸºæº–å€¤ã§ã™ã€‚</li>
                        <li>é˜²å¾¡åŠ›ï¼šè¢«ãƒ€ãƒ¡ãƒ¼ã‚¸è¨ˆç®—ã®åŸºæº–å€¤ã§ã™ï¼ˆè¿½åŠ é˜²å¾¡%é©ç”¨å¾Œï¼‰ã€‚</li>
                        <li>å‘½ä¸­ / å›é¿ï¼šæ”»æ’ƒãŒå½“ãŸã‚‹ãƒ»é¿ã‘ã‚‹åˆ¤å®šã«ä½¿ã†å€¤ã§ã™ã€‚</li>
                        <li>ã‚¯ãƒªãƒ†ã‚£ã‚«ãƒ«ç‡ï¼šç‰©ç†ãƒ’ãƒƒãƒˆã®ã‚¯ãƒªãƒ†ã‚£ã‚«ãƒ«ç™ºç”Ÿç‡ã§ã™ã€‚</li>
                        <li>è¿½åŠ ãƒ€ãƒ¡ãƒ¼ã‚¸%ï¼šä¸ãƒ€ãƒ¡ãƒ¼ã‚¸ã‚’å¾Œæ®µã§å¢—ã‚„ã™è£œæ­£ã§ã™ã€‚</li>
                        <li>è¿½åŠ é˜²å¾¡%ï¼šé˜²å¾¡åŠ›ãã®ã‚‚ã®ã‚’å‰²åˆã§å¢—ã‚„ã™è£œæ­£ã§ã™ã€‚</li>
                        <li>ãƒ‰ãƒ­ãƒƒãƒ—ç‡è£œæ­£ï¼šè£…å‚™å“ãŒè½ã¡ã‚‹ç¢ºç‡ã‚’é«˜ã‚ã¾ã™ã€‚</li>
                        <li>ã‚¨ãƒªãƒ¼ãƒˆé­é‡ç‡ï¼šã‚¨ãƒªãƒ¼ãƒˆå€‹ä½“ã«å‡ºä¼šã†ç¢ºç‡ã‚’é«˜ã‚ã¾ã™ã€‚</li>
                        <li>ã‚´ãƒ¼ãƒ«ãƒ‰ç²å¾—é‡è£œæ­£ / çµŒé¨“å€¤ç²å¾—é‡è£œæ­£ï¼šå–å¾—å ±é…¬é‡ã‚’å¢—ã‚„ã—ã¾ã™ã€‚</li>
                    </ul>
                </div>
                <div class="rounded-xl bg-slate-50 border border-slate-200 px-3 py-2 text-[10px] font-bold text-slate-500">
                    é€šå¸¸è¡¨ç¤ºã¯åˆè¨ˆå€¤ã€å³ä¸Šã®ã€Œè©³ç´°ã€ã§ã¯åˆè¨ˆ(åŸºç¤+åŠ ç®—)ã®å†…è¨³ã‚’ç¢ºèªã§ãã¾ã™ã€‚
                </div>
            </div>
            <button id="status-info-close-bottom" class="mt-5 w-full bg-slate-800 text-white font-black py-3 rounded-2xl shadow-lg">é–‰ã˜ã‚‹</button>
        </div>
    </div>

    <!-- WARP MODAL -->
    <div id="warp-modal" class="fixed inset-0 bg-slate-900/80 z-[115] hidden items-center justify-center p-6 backdrop-blur-sm">
        <div class="bg-white w-full max-w-sm rounded-[2rem] shadow-2xl p-6 border-b-8 border-slate-200">
            <div class="flex items-center justify-between mb-4">
                <h3 class="font-black text-lg text-slate-800 flex items-center gap-2"><i class="fas fa-location-arrow"></i> ãƒ¯ãƒ¼ãƒ—</h3>
                <button id="warp-close" class="text-slate-400 hover:text-slate-700 text-lg"><i class="fas fa-xmark"></i></button>
            </div>
            <div class="text-xs text-slate-500 font-bold">-</div>
        </div>
    </div>

    <!-- DONATE MODAL -->
    <div id="donate-modal" class="fixed inset-0 bg-slate-900/80 z-[120] hidden items-center justify-center p-6 backdrop-blur-sm">
      <div class="bg-white w-full max-w-sm rounded-[2rem] overflow-hidden shadow-2xl p-6 border-b-8 border-amber-200">
        <div class="flex items-center justify-between mb-4">
          <h3 class="font-black text-lg text-slate-800 flex items-center gap-2">
            <i class="fas fa-heart text-rose-500"></i> å¿œæ´
          </h3>
          <button class="text-slate-400 hover:text-slate-700 text-lg" onclick="closeDonateModal()">
            <i class="fas fa-xmark"></i>
          </button>
        </div>
    
        <div class="text-[11px] text-slate-600 font-bold mb-4">
          æ°—ãŒå‘ã„ãŸã‚‰ã§å¤§ä¸ˆå¤«ã§ã™ã€‚é–‹ç™ºã®åŠ±ã¿ã«ãªã‚Šã¾ã™ã€‚
        </div>
    
        <div class="space-y-3">
          <button class="w-full bg-white text-slate-900 border border-slate-900 font-black py-3 rounded-2xl shadow-sm flex items-center justify-center gap-2 hover:bg-slate-100 transition"
            onclick="purchaseTip('tip100',event)">
            â˜•ï¸ 100å††ï¼ˆã‚³ãƒ¼ãƒ’ãƒ¼ï¼‰
          </button>
    
          <button class="w-full bg-white text-slate-900 border border-slate-900 font-black py-3 rounded-2xl shadow-sm flex items-center justify-center gap-2 hover:bg-slate-100 transition"
            onclick="purchaseTip('tip300',event)">
            â˜•ï¸ğŸª 300å††ï¼ˆã‚³ãƒ¼ãƒ’ãƒ¼ï¼‹ãŠè“å­ï¼‰
          </button>
    
          <button class="w-full bg-white text-slate-900 font-black rounded-2xl flex items-center justify-center"
            >
            ğŸ”¥ æœ¬å½“ã«å¿œæ´ã‚ã‚ŠãŒã¨ã†ã”ã–ã„ã¾ã™
          </button>
        </div>
    
        <button class="mt-5 w-full bg-slate-100 text-slate-500 font-black py-3 rounded-2xl shadow"
          onclick="closeDonateModal()">
          ã‚­ãƒ£ãƒ³ã‚»ãƒ«
        </button>
      </div>
    </div>
    
    <!-- DONATE TOAST -->
    <div id="donate-toast" class="fixed left-1/2 -translate-x-1/2 bottom-24 z-[130] hidden">
      <div class="bg-white/95 border border-slate-200 shadow-xl rounded-2xl px-4 py-3 text-[12px] font-black text-slate-800">
        <span id="donate-toast-text"></span>
      </div>
    </div>

    <div id="boot-overlay" class="fixed inset-0 z-[160] hidden bg-slate-900/40 flex items-center justify-center">
      <div class="bg-white/90 text-slate-700 font-black text-sm px-4 py-2 rounded-xl shadow">
        ãƒ­ãƒ¼ãƒ‰ä¸­â€¦
      </div>
    </div>


    <script>
        (() => {
            const COMBAT_CONSTANTS = Object.freeze({
                DEX_PER_BONUS_HIT_CAP: 100,
                DOUBLE_CRITICAL_LUCK_GAP: 400,
                CRITICAL_MULTIPLIER: 2,
                DOUBLE_CRITICAL_MULTIPLIER: 4,
                BONUS_ON_HIT_STATUS_AILMENT_SCALE: 0.5,
                BONUS_ON_HIT_DRAIN_SCALE: 0.3,
                BASE_HIT_CHANCE: 85,
                HIT_DELTA_SCALE: 20,
                HIT_DELTA_SOFTNESS: 50,
                MIN_HIT_CHANCE: 10,
                MAX_HIT_CHANCE: 98,
                ENEMY_HIT_CHANCE_FLAT_BONUS: 0,
                ENEMY_HIT_CHANCE_MULTIPLIER: 1,
                PHYSICAL_DEFENSE_SOFTNESS: 100,
                MAGIC_DEFENSE_SOFTNESS: 140,
                MIN_DAMAGE: 1
            });

            const PrimaryStatKey = Object.freeze({
                STR: 'STR',
                INT: 'INT',
                VIT: 'VIT',
                DEX: 'DEX',
                LUK: 'LUK'
            });

            const SecondaryStatKey = Object.freeze({
                MaxHP: 'MaxHP',
                MaxCP: 'MaxCP',
                PhysicalAttack: 'PhysicalAttack',
                MagicAttack: 'MagicAttack',
                Defense: 'Defense',
                HitRate: 'HitRate',
                AvoidRate: 'AvoidRate',
                CriticalChance: 'CriticalChance',
                BonusDamagePercent: 'BonusDamagePercent',
                BonusDefensePercent: 'BonusDefensePercent',
                DropRateBonus: 'DropRateBonus',
                EnchantSuccessRateBonus: 'EnchantSuccessRateBonus',
                GoldGainRate: 'GoldGainRate',
                ExpGainRate: 'ExpGainRate',
                EliteEncounterRate: 'EliteEncounterRate'
            });

            const HitSourceType = Object.freeze({
                Guaranteed: 'Guaranteed',
                Bonus: 'Bonus'
            });

            const CritTier = Object.freeze({
                None: 'None',
                Critical: 'Critical',
                DoubleCritical: 'DoubleCritical'
            });

            const CombatActorSide = Object.freeze({
                Player: 'Player',
                Enemy: 'Enemy'
            });

            const createPrimaryStats = (stats = {}) => ({
                [PrimaryStatKey.STR]: Number.isFinite(stats[PrimaryStatKey.STR]) ? Math.max(0, Math.floor(stats[PrimaryStatKey.STR])) : 0,
                [PrimaryStatKey.INT]: Number.isFinite(stats[PrimaryStatKey.INT]) ? Math.max(0, Math.floor(stats[PrimaryStatKey.INT])) : 0,
                [PrimaryStatKey.VIT]: Number.isFinite(stats[PrimaryStatKey.VIT]) ? Math.max(0, Math.floor(stats[PrimaryStatKey.VIT])) : 0,
                [PrimaryStatKey.DEX]: Number.isFinite(stats[PrimaryStatKey.DEX]) ? Math.max(0, Math.floor(stats[PrimaryStatKey.DEX])) : 0,
                [PrimaryStatKey.LUK]: Number.isFinite(stats[PrimaryStatKey.LUK]) ? Math.max(0, Math.floor(stats[PrimaryStatKey.LUK])) : 0
            });

            const createSecondaryStats = (stats = {}) => {
                const pickNonNegative = (key) => {
                    const value = Number.isFinite(stats[key]) ? Number(stats[key]) : 0;
                    return Math.max(0, value);
                };

                return {
                    [SecondaryStatKey.MaxHP]: Math.max(1, Math.floor(pickNonNegative(SecondaryStatKey.MaxHP))),
                    [SecondaryStatKey.MaxCP]: Math.floor(pickNonNegative(SecondaryStatKey.MaxCP)),
                    [SecondaryStatKey.PhysicalAttack]: Math.floor(pickNonNegative(SecondaryStatKey.PhysicalAttack)),
                    [SecondaryStatKey.MagicAttack]: Math.floor(pickNonNegative(SecondaryStatKey.MagicAttack)),
                    [SecondaryStatKey.Defense]: Math.floor(pickNonNegative(SecondaryStatKey.Defense)),
                    [SecondaryStatKey.HitRate]: pickNonNegative(SecondaryStatKey.HitRate),
                    [SecondaryStatKey.AvoidRate]: pickNonNegative(SecondaryStatKey.AvoidRate),
                    [SecondaryStatKey.CriticalChance]: pickNonNegative(SecondaryStatKey.CriticalChance),
                    [SecondaryStatKey.BonusDamagePercent]: pickNonNegative(SecondaryStatKey.BonusDamagePercent),
                    [SecondaryStatKey.BonusDefensePercent]: pickNonNegative(SecondaryStatKey.BonusDefensePercent),
                    [SecondaryStatKey.DropRateBonus]: pickNonNegative(SecondaryStatKey.DropRateBonus),
                    [SecondaryStatKey.EnchantSuccessRateBonus]: pickNonNegative(SecondaryStatKey.EnchantSuccessRateBonus),
                    [SecondaryStatKey.GoldGainRate]: pickNonNegative(SecondaryStatKey.GoldGainRate),
                    [SecondaryStatKey.ExpGainRate]: pickNonNegative(SecondaryStatKey.ExpGainRate),
                    [SecondaryStatKey.EliteEncounterRate]: pickNonNegative(SecondaryStatKey.EliteEncounterRate)
                };
            };

            const DEFAULT_BASE_STAT_CONFIG = Object.freeze({
                BaseHP: 100,
                BaseCP: 30,
                BasePAtk: 10,
                BaseMAtk: 16,
                BaseDef: 5,
                BaseHit: 90,
                BaseAvoid: 3,
                BaseCrit: 5
            });

            const DEFAULT_PRIMARY_STATS = Object.freeze({
                [PrimaryStatKey.STR]: 1,
                [PrimaryStatKey.INT]: 1,
                [PrimaryStatKey.VIT]: 1,
                [PrimaryStatKey.DEX]: 1,
                [PrimaryStatKey.LUK]: 1
            });

            class PlayerStatusCalculator {
                static calculateSecondaryStats({
                    primaryStats,
                    baseStatConfig = DEFAULT_BASE_STAT_CONFIG,
                    bonusStats = {},
                    roundingMode = Math.floor
                }) {
                    const primary = createPrimaryStats(primaryStats);
                    const baseConfig = PlayerStatusCalculator.#createBaseConfig(baseStatConfig);
                    const bonus = PlayerStatusCalculator.#createBonusStats(bonusStats);
                    const primaryBonus = {
                        [PrimaryStatKey.STR]: bonus[PrimaryStatKey.STR],
                        [PrimaryStatKey.INT]: bonus[PrimaryStatKey.INT],
                        [PrimaryStatKey.VIT]: bonus[PrimaryStatKey.VIT],
                        [PrimaryStatKey.DEX]: bonus[PrimaryStatKey.DEX],
                        [PrimaryStatKey.LUK]: bonus[PrimaryStatKey.LUK]
                    };
                    const totalPrimary = {
                        [PrimaryStatKey.STR]: primary[PrimaryStatKey.STR] + primaryBonus[PrimaryStatKey.STR],
                        [PrimaryStatKey.INT]: primary[PrimaryStatKey.INT] + primaryBonus[PrimaryStatKey.INT],
                        [PrimaryStatKey.VIT]: primary[PrimaryStatKey.VIT] + primaryBonus[PrimaryStatKey.VIT],
                        [PrimaryStatKey.DEX]: primary[PrimaryStatKey.DEX] + primaryBonus[PrimaryStatKey.DEX],
                        [PrimaryStatKey.LUK]: primary[PrimaryStatKey.LUK] + primaryBonus[PrimaryStatKey.LUK]
                    };

                    const baseValues = {
                        [SecondaryStatKey.MaxHP]: baseConfig.BaseHP + totalPrimary.VIT * 12,
                        [SecondaryStatKey.MaxCP]: baseConfig.BaseCP + totalPrimary.INT * 10,
                        [SecondaryStatKey.PhysicalAttack]: baseConfig.BasePAtk + totalPrimary.STR * 3,
                        [SecondaryStatKey.MagicAttack]: baseConfig.BaseMAtk + totalPrimary.INT * 3,
                        DefenseBase: baseConfig.BaseDef + totalPrimary.VIT * 2,
                        [SecondaryStatKey.HitRate]: baseConfig.BaseHit + totalPrimary.DEX * 0.15,
                        [SecondaryStatKey.AvoidRate]: baseConfig.BaseAvoid + totalPrimary.DEX * 0.08,
                        [SecondaryStatKey.CriticalChance]: baseConfig.BaseCrit + totalPrimary.DEX * 0.05 + totalPrimary.LUK * 0.10,
                        [SecondaryStatKey.DropRateBonus]: totalPrimary.LUK * 0.20,
                        [SecondaryStatKey.EnchantSuccessRateBonus]: totalPrimary.LUK * 0.03,
                        [SecondaryStatKey.GoldGainRate]: totalPrimary.LUK * 0.05,
                        [SecondaryStatKey.ExpGainRate]: totalPrimary.LUK * 0.03,
                        [SecondaryStatKey.EliteEncounterRate]: BASE_ELITE_ENCOUNTER_RATE,
                        [SecondaryStatKey.BonusDamagePercent]: bonus[SecondaryStatKey.BonusDamagePercent],
                        [SecondaryStatKey.BonusDefensePercent]: bonus[SecondaryStatKey.BonusDefensePercent]
                    };

                    const totalValues = {
                        [SecondaryStatKey.MaxHP]: Math.max(1, roundingMode(baseValues[SecondaryStatKey.MaxHP] + bonus[SecondaryStatKey.MaxHP])),
                        [SecondaryStatKey.MaxCP]: Math.max(0, roundingMode(baseValues[SecondaryStatKey.MaxCP] + bonus[SecondaryStatKey.MaxCP])),
                        [SecondaryStatKey.PhysicalAttack]: Math.max(0, roundingMode(baseValues[SecondaryStatKey.PhysicalAttack] + bonus[SecondaryStatKey.PhysicalAttack])),
                        [SecondaryStatKey.MagicAttack]: Math.max(0, roundingMode(baseValues[SecondaryStatKey.MagicAttack] + bonus[SecondaryStatKey.MagicAttack])),
                        DefenseBase: Math.max(0, roundingMode(baseValues.DefenseBase + bonus.DefenseBase + bonus[SecondaryStatKey.Defense])),
                        [SecondaryStatKey.HitRate]: Math.max(0, baseValues[SecondaryStatKey.HitRate] + bonus[SecondaryStatKey.HitRate]),
                        [SecondaryStatKey.AvoidRate]: Math.max(0, baseValues[SecondaryStatKey.AvoidRate] + bonus[SecondaryStatKey.AvoidRate]),
                        [SecondaryStatKey.CriticalChance]: Math.max(0, baseValues[SecondaryStatKey.CriticalChance] + bonus[SecondaryStatKey.CriticalChance]),
                        [SecondaryStatKey.BonusDamagePercent]: Math.max(0, baseValues[SecondaryStatKey.BonusDamagePercent]),
                        [SecondaryStatKey.BonusDefensePercent]: Math.max(0, baseValues[SecondaryStatKey.BonusDefensePercent]),
                        [SecondaryStatKey.DropRateBonus]: Math.max(0, baseValues[SecondaryStatKey.DropRateBonus] + bonus[SecondaryStatKey.DropRateBonus]),
                        [SecondaryStatKey.EnchantSuccessRateBonus]: Math.max(0, baseValues[SecondaryStatKey.EnchantSuccessRateBonus] + bonus[SecondaryStatKey.EnchantSuccessRateBonus]),
                        [SecondaryStatKey.GoldGainRate]: Math.max(0, baseValues[SecondaryStatKey.GoldGainRate] + bonus[SecondaryStatKey.GoldGainRate]),
                        [SecondaryStatKey.ExpGainRate]: Math.max(0, baseValues[SecondaryStatKey.ExpGainRate] + bonus[SecondaryStatKey.ExpGainRate]),
                        [SecondaryStatKey.EliteEncounterRate]: Math.max(0, baseValues[SecondaryStatKey.EliteEncounterRate] + bonus[SecondaryStatKey.EliteEncounterRate])
                    };

                    const totalBonusDefensePercent = totalValues[SecondaryStatKey.BonusDefensePercent];
                    const defense = Math.max(0, roundingMode(totalValues.DefenseBase * (1 + totalBonusDefensePercent / 100)));

                    const secondaryStats = createSecondaryStats({
                        [SecondaryStatKey.MaxHP]: totalValues[SecondaryStatKey.MaxHP],
                        [SecondaryStatKey.MaxCP]: totalValues[SecondaryStatKey.MaxCP],
                        [SecondaryStatKey.PhysicalAttack]: totalValues[SecondaryStatKey.PhysicalAttack],
                        [SecondaryStatKey.MagicAttack]: totalValues[SecondaryStatKey.MagicAttack],
                        [SecondaryStatKey.Defense]: defense,
                        [SecondaryStatKey.HitRate]: totalValues[SecondaryStatKey.HitRate],
                        [SecondaryStatKey.AvoidRate]: totalValues[SecondaryStatKey.AvoidRate],
                        [SecondaryStatKey.CriticalChance]: totalValues[SecondaryStatKey.CriticalChance],
                        [SecondaryStatKey.BonusDamagePercent]: totalValues[SecondaryStatKey.BonusDamagePercent],
                        [SecondaryStatKey.BonusDefensePercent]: totalValues[SecondaryStatKey.BonusDefensePercent],
                        [SecondaryStatKey.DropRateBonus]: totalValues[SecondaryStatKey.DropRateBonus],
                        [SecondaryStatKey.EnchantSuccessRateBonus]: totalValues[SecondaryStatKey.EnchantSuccessRateBonus],
                        [SecondaryStatKey.GoldGainRate]: totalValues[SecondaryStatKey.GoldGainRate],
                        [SecondaryStatKey.ExpGainRate]: totalValues[SecondaryStatKey.ExpGainRate],
                        [SecondaryStatKey.EliteEncounterRate]: totalValues[SecondaryStatKey.EliteEncounterRate]
                    });

                    return {
                        primaryStats: primary,
                        primaryBonus,
                        totalPrimary,
                        baseStatConfig: baseConfig,
                        baseValues,
                        bonusValues: bonus,
                        totalValues,
                        secondaryStats,
                        defense
                    };
                }

                static #createBaseConfig(baseStatConfig = {}) {
                    return {
                        BaseHP: Number.isFinite(baseStatConfig.BaseHP) ? baseStatConfig.BaseHP : DEFAULT_BASE_STAT_CONFIG.BaseHP,
                        BaseCP: Number.isFinite(baseStatConfig.BaseCP) ? baseStatConfig.BaseCP : DEFAULT_BASE_STAT_CONFIG.BaseCP,
                        BasePAtk: Number.isFinite(baseStatConfig.BasePAtk) ? baseStatConfig.BasePAtk : DEFAULT_BASE_STAT_CONFIG.BasePAtk,
                        BaseMAtk: Number.isFinite(baseStatConfig.BaseMAtk) ? baseStatConfig.BaseMAtk : DEFAULT_BASE_STAT_CONFIG.BaseMAtk,
                        BaseDef: Number.isFinite(baseStatConfig.BaseDef) ? baseStatConfig.BaseDef : DEFAULT_BASE_STAT_CONFIG.BaseDef,
                        BaseHit: Number.isFinite(baseStatConfig.BaseHit) ? baseStatConfig.BaseHit : DEFAULT_BASE_STAT_CONFIG.BaseHit,
                        BaseAvoid: Number.isFinite(baseStatConfig.BaseAvoid) ? baseStatConfig.BaseAvoid : DEFAULT_BASE_STAT_CONFIG.BaseAvoid,
                        BaseCrit: Number.isFinite(baseStatConfig.BaseCrit) ? baseStatConfig.BaseCrit : DEFAULT_BASE_STAT_CONFIG.BaseCrit
                    };
                }

                static #createBonusStats(bonusStats = {}) {
                    const asNonNegative = (value) => (Number.isFinite(value) ? Math.max(0, Number(value)) : 0);
                    return {
                        [SecondaryStatKey.MaxHP]: asNonNegative(bonusStats[SecondaryStatKey.MaxHP]),
                        [SecondaryStatKey.MaxCP]: asNonNegative(bonusStats[SecondaryStatKey.MaxCP]),
                        [SecondaryStatKey.PhysicalAttack]: asNonNegative(bonusStats[SecondaryStatKey.PhysicalAttack]),
                        [SecondaryStatKey.MagicAttack]: asNonNegative(bonusStats[SecondaryStatKey.MagicAttack]),
                        DefenseBase: asNonNegative(bonusStats.DefenseBase),
                        [SecondaryStatKey.Defense]: asNonNegative(bonusStats[SecondaryStatKey.Defense]),
                        [SecondaryStatKey.HitRate]: asNonNegative(bonusStats[SecondaryStatKey.HitRate]),
                        [SecondaryStatKey.AvoidRate]: asNonNegative(bonusStats[SecondaryStatKey.AvoidRate]),
                        [SecondaryStatKey.CriticalChance]: asNonNegative(bonusStats[SecondaryStatKey.CriticalChance]),
                        [SecondaryStatKey.BonusDamagePercent]: asNonNegative(bonusStats[SecondaryStatKey.BonusDamagePercent]),
                        [SecondaryStatKey.BonusDefensePercent]: asNonNegative(bonusStats[SecondaryStatKey.BonusDefensePercent]),
                        [SecondaryStatKey.DropRateBonus]: asNonNegative(bonusStats[SecondaryStatKey.DropRateBonus]),
                        [SecondaryStatKey.EnchantSuccessRateBonus]: asNonNegative(bonusStats[SecondaryStatKey.EnchantSuccessRateBonus]),
                        [SecondaryStatKey.GoldGainRate]: asNonNegative(bonusStats[SecondaryStatKey.GoldGainRate]),
                        [SecondaryStatKey.ExpGainRate]: asNonNegative(bonusStats[SecondaryStatKey.ExpGainRate]),
                        [SecondaryStatKey.EliteEncounterRate]: asNonNegative(bonusStats[SecondaryStatKey.EliteEncounterRate]),
                        [PrimaryStatKey.STR]: asNonNegative(bonusStats[PrimaryStatKey.STR]),
                        [PrimaryStatKey.INT]: asNonNegative(bonusStats[PrimaryStatKey.INT]),
                        [PrimaryStatKey.VIT]: asNonNegative(bonusStats[PrimaryStatKey.VIT]),
                        [PrimaryStatKey.DEX]: asNonNegative(bonusStats[PrimaryStatKey.DEX]),
                        [PrimaryStatKey.LUK]: asNonNegative(bonusStats[PrimaryStatKey.LUK])
                    };
                }
            }

            const formatStatBreakdown = ({ total = 0, base = 0, bonus = 0, digits = 0, suffix = '' } = {}) => {
                const toSafeNumber = (value) => (Number.isFinite(value) ? Number(value) : 0);
                const normalize = (value) => {
                    const safe = toSafeNumber(value);
                    return digits > 0 ? safe.toFixed(digits) : String(Math.round(safe));
                };

                return `${normalize(total)}(${normalize(base)}+${normalize(bonus)})${suffix}`;
            };

            class HitSequenceResolver {
                static resolve({ attackDefinition, attackerDex, rng = Math.random }) {
                    const guaranteedHits = Math.max(0, Math.floor(attackDefinition.guaranteedHits || 0));
                    const skillBonusHitCap = Math.max(0, Math.floor(attackDefinition.skillBonusHitCap || 0));
                    const dexBonusHitCap = Math.floor(Math.max(0, attackerDex || 0) / COMBAT_CONSTANTS.DEX_PER_BONUS_HIT_CAP);
                    const actualBonusHitCap = Math.min(dexBonusHitCap, skillBonusHitCap);
                    const bonusHitChanceTable = Array.isArray(attackDefinition.bonusHitChanceTable) ? attackDefinition.bonusHitChanceTable : [];
                    const bonusHitDamageScaleTable = Array.isArray(attackDefinition.bonusHitDamageScaleTable) ? attackDefinition.bonusHitDamageScaleTable : [];

                    const hitSequence = [];
                    const damageType = attackDefinition.damageType || 'Physical';

                    for (let i = 0; i < guaranteedHits; i += 1) {
                        hitSequence.push({
                            hitSourceType: HitSourceType.Guaranteed,
                            isGuaranteedHit: true,
                            damageType,
                            damageScale: 1,
                            bonusSlotIndex: null,
                            onHitEffectScale: 1
                        });
                    }

                    for (let i = 0; i < actualBonusHitCap; i += 1) {
                        const chance = HitSequenceResolver.#pickTableValue(bonusHitChanceTable, i, 0);
                        if (rng() < chance) {
                            hitSequence.push({
                                hitSourceType: HitSourceType.Bonus,
                                isGuaranteedHit: false,
                                damageType,
                                damageScale: HitSequenceResolver.#pickTableValue(bonusHitDamageScaleTable, i, 0),
                                bonusSlotIndex: i,
                                onHitEffectScale: {
                                    statusAilment: COMBAT_CONSTANTS.BONUS_ON_HIT_STATUS_AILMENT_SCALE,
                                    hpMpDrain: COMBAT_CONSTANTS.BONUS_ON_HIT_DRAIN_SCALE,
                                    triggerPolicy: 'OncePerAction'
                                }
                            });
                        }
                    }

                    return hitSequence.map((hit, index) => ({ ...hit, hitIndex: index }));
                }

                static #pickTableValue(table, index, fallback) {
                    if (!table.length) {
                        return fallback;
                    }

                    const picked = index < table.length ? table[index] : table[table.length - 1];
                    return Number.isFinite(picked) ? picked : fallback;
                }
            }

            class CriticalResolver {
                static resolveCritTier({ isCritical, attackerLuk, defenderLuk }) {
                    if (!isCritical) {
                        return CritTier.None;
                    }

                    const luckGap = (attackerLuk || 0) - (defenderLuk || 0);
                    if (luckGap >= COMBAT_CONSTANTS.DOUBLE_CRITICAL_LUCK_GAP) {
                        return CritTier.DoubleCritical;
                    }

                    return CritTier.Critical;
                }

                static getCritMultiplier(critTier) {
                    if (critTier === CritTier.DoubleCritical) {
                        return COMBAT_CONSTANTS.DOUBLE_CRITICAL_MULTIPLIER;
                    }
                    if (critTier === CritTier.Critical) {
                        return COMBAT_CONSTANTS.CRITICAL_MULTIPLIER;
                    }
                    return 1;
                }
            }

            const clamp = (min, value, max) => Math.min(max, Math.max(min, value));

            const calculatePhysicalHitChancePercent = ({
                attackerHitRate,
                defenderAvoidRate,
                flatBonus = 0,
                multiplier = 1
            }) => {
                const attackerHit = Number.isFinite(attackerHitRate) ? attackerHitRate : 0;
                const defenderAvoid = Number.isFinite(defenderAvoidRate) ? defenderAvoidRate : 0;
                const delta = attackerHit - defenderAvoid;
                const baseChance = COMBAT_CONSTANTS.BASE_HIT_CHANCE
                    + (delta * COMBAT_CONSTANTS.HIT_DELTA_SCALE)
                    / (Math.abs(delta) + COMBAT_CONSTANTS.HIT_DELTA_SOFTNESS);
                const adjustedChance = (baseChance + flatBonus) * multiplier;
                return clamp(
                    COMBAT_CONSTANTS.MIN_HIT_CHANCE,
                    adjustedChance,
                    COMBAT_CONSTANTS.MAX_HIT_CHANCE
                );
            };

            const toNonNegativeNumber = (value, fallback = 0) => {
                const picked = Number.isFinite(value) ? Number(value) : fallback;
                return Math.max(0, picked);
            };

            const calcPhysicalDamageOnHit = ({
                attackerSecondaryStats,
                defenderSecondaryStats,
                skillPowerMultiplier = 1,
                totalBonusDamagePercent = 0,
                critTier = CritTier.None,
                config = {}
            }) => {
                const attackerSecondary = createSecondaryStats(attackerSecondaryStats);
                const defenderSecondary = createSecondaryStats(defenderSecondaryStats);
                const safeSkillPowerMultiplier = toNonNegativeNumber(skillPowerMultiplier, 1);
                const safeBonusDamagePercent = toNonNegativeNumber(totalBonusDamagePercent, 0);
                const physicalDefenseSoftness = toNonNegativeNumber(config.physicalDefenseSoftness, COMBAT_CONSTANTS.PHYSICAL_DEFENSE_SOFTNESS);
                const minDamage = toNonNegativeNumber(config.minDamage, COMBAT_CONSTANTS.MIN_DAMAGE);
                const attackPart = attackerSecondary.PhysicalAttack * safeSkillPowerMultiplier;
                const reducedDamage = attackPart * physicalDefenseSoftness / (defenderSecondary.Defense + physicalDefenseSoftness);
                const critMultiplier = CriticalResolver.getCritMultiplier(critTier);
                const damageBeforeBonus = Math.max(minDamage, reducedDamage * critMultiplier);
                const finalDamage = Math.floor(damageBeforeBonus * (1 + safeBonusDamagePercent / 100));

                return {
                    isHit: true,
                    isCritical: critTier !== CritTier.None,
                    isDoubleCritical: critTier === CritTier.DoubleCritical,
                    finalDamage,
                    attackPart,
                    reducedDamage,
                    damageBeforeBonus
                };
            };

            const calcMagicDamage = ({
                attackerSecondaryStats,
                defenderSecondaryStats,
                skillPowerMultiplier = 1,
                totalBonusDamagePercent = 0,
                config = {}
            }) => {
                const attackerSecondary = createSecondaryStats(attackerSecondaryStats);
                const defenderSecondary = createSecondaryStats(defenderSecondaryStats);
                const safeSkillPowerMultiplier = toNonNegativeNumber(skillPowerMultiplier, 1);
                const safeBonusDamagePercent = toNonNegativeNumber(totalBonusDamagePercent, 0);
                const magicDefenseSoftness = toNonNegativeNumber(config.magicDefenseSoftness, COMBAT_CONSTANTS.MAGIC_DEFENSE_SOFTNESS);
                const minDamage = toNonNegativeNumber(config.minDamage, COMBAT_CONSTANTS.MIN_DAMAGE);
                const attackPart = attackerSecondary.MagicAttack * safeSkillPowerMultiplier;
                const reducedDamage = attackPart * magicDefenseSoftness / (defenderSecondary.Defense + magicDefenseSoftness);
                const damageBeforeBonus = Math.max(minDamage, reducedDamage);
                const finalDamage = Math.floor(damageBeforeBonus * (1 + safeBonusDamagePercent / 100));

                return {
                    isHit: true,
                    isCritical: false,
                    isDoubleCritical: false,
                    finalDamage,
                    attackPart,
                    reducedDamage,
                    damageBeforeBonus
                };
            };

            const resolveHitResults = ({
                attackDefinition,
                attackerPrimaryStats,
                defenderPrimaryStats,
                attackerSecondaryStats,
                defenderSecondaryStats,
                rollCritical,
                hitChanceModifiers,
                attackerSide = CombatActorSide.Player,
                rng = Math.random
            }) => {
                const attacker = createPrimaryStats(attackerPrimaryStats);
                const defender = createPrimaryStats(defenderPrimaryStats);
                const attackerSecondary = createSecondaryStats(attackerSecondaryStats);
                const defenderSecondary = createSecondaryStats(defenderSecondaryStats);
                const hitSequence = HitSequenceResolver.resolve({
                    attackDefinition,
                    attackerDex: attacker.DEX,
                    rng
                });

                const defaultHitChanceModifiers = attackerSide === CombatActorSide.Enemy
                    ? {
                        flatBonus: COMBAT_CONSTANTS.ENEMY_HIT_CHANCE_FLAT_BONUS,
                        multiplier: COMBAT_CONSTANTS.ENEMY_HIT_CHANCE_MULTIPLIER
                    }
                    : {
                        flatBonus: 0,
                        multiplier: 1
                    };
                const resolvedHitChanceModifiers = {
                    ...defaultHitChanceModifiers,
                    ...(hitChanceModifiers || {})
                };

                const rollCriticalBySecondary = ({ hit, rng: random }) => {
                    if (hit.damageType === 'Magical') {
                        return false;
                    }
                    const criticalChance = attackerSecondary.CriticalChance;
                    return random() < (criticalChance / 100);
                };

                const resolveCritical = typeof rollCritical === 'function'
                    ? rollCritical
                    : rollCriticalBySecondary;

                return hitSequence.map((hit) => {
                    const isPhysicalHit = hit.damageType === 'Physical';
                    const hitChancePercent = isPhysicalHit
                        ? calculatePhysicalHitChancePercent({
                            attackerHitRate: attackerSecondary.HitRate,
                            defenderAvoidRate: defenderSecondary.AvoidRate,
                            flatBonus: resolvedHitChanceModifiers.flatBonus,
                            multiplier: resolvedHitChanceModifiers.multiplier
                        })
                        : 100;
                    const isHit = !isPhysicalHit || (rng() < (hitChancePercent / 100));
                    const isCritical = isHit && !!resolveCritical({
                        hit,
                        attacker,
                        defender,
                        attackerSecondary,
                        defenderSecondary,
                        rng
                    });
                    const critTier = CriticalResolver.resolveCritTier({
                        isCritical,
                        attackerLuk: attacker.LUK,
                        defenderLuk: defender.LUK
                    });

                    return {
                        ...hit,
                        isHit,
                        hitChancePercent,
                        critTier,
                        critMultiplier: CriticalResolver.getCritMultiplier(critTier)
                    };
                });
            };

            const NORMAL_ATTACK_HIT_DEFINITION = Object.freeze({
                guaranteedHits: 1,
                skillBonusHitCap: 3,
                bonusHitChanceTable: [0.6, 0.35, 0.2, 0.1, 0.05, 0.05],
                bonusHitDamageScaleTable: [0.7, 0.55, 0.4, 0.3, 0.3]
            });

            window.CombatSpec = Object.freeze({
                COMBAT_CONSTANTS,
                PrimaryStatKey,
                SecondaryStatKey,
                HitSourceType,
                CritTier,
                CombatActorSide,
                DEFAULT_BASE_STAT_CONFIG,
                DEFAULT_PRIMARY_STATS,
                createPrimaryStats,
                createSecondaryStats,
                formatStatBreakdown,
                PlayerStatusCalculator,
                HitSequenceResolver,
                CriticalResolver,
                calculatePhysicalHitChancePercent,
                calcPhysicalDamageOnHit,
                calcMagicDamage,
                resolveHitResults,
                NORMAL_ATTACK_HIT_DEFINITION
            });

            const LEVEL_UP_STAT_POINT_GAIN = 5;
            const MIN_PRIMARY_STAT_VALUE = 1;
            const BASE_ELITE_ENCOUNTER_RATE = 5;
            const DEATH_FLOOR_PENALTY = 20;
            const DEATH_EXP_LOSS_RATE = 0.05;
            const GUARD_POPUP_THRESHOLD = 0.45;

            const BATTLE_POPUP_STYLE = Object.freeze({
                physical: { color: '#ffffff' },
                magical: { color: '#facc15' },
                critical: { color: '#ef4444', label: 'Critical!' },
                doubleCritical: { color: '#ef4444', label: 'Double!' },
                heal: { color: '#22c55e', prefix: '+' },
                miss: { color: '#94a3b8', text: 'MISS' },
                guard: { color: '#38bdf8', text: 'Guard' },
                drain: { color: '#a855f7', label: 'Drain', prefix: '+' },
                exp: { color: '#38bdf8', prefix: 'EXP +' },
                levelUp: { color: '#fbbf24', text: 'Level Up!' }
            });

            const playerProgressState = {
                level: 1,
                exp: 0,
                statPoints: 0,
                primaryStats: createPrimaryStats(DEFAULT_PRIMARY_STATS)
            };

            const getRequiredExp = (level) => Math.max(1, Math.floor(80 + Math.pow(Math.max(1, level), 1.45) * 18));
            const getKillExp = (floorValue) => Math.max(1, Math.floor(14 + clampFloor(floorValue) * 0.55));

            const updateStatAdjustButtonState = () => {
                const buttons = document.querySelectorAll('.stat-adjust-btn');
                buttons.forEach((button) => {
                    const statKey = button.dataset.stat;
                    const delta = Number(button.dataset.delta || 0);
                    const currentValue = playerProgressState.primaryStats[statKey] || MIN_PRIMARY_STAT_VALUE;
                    let canApply = true;
                    if (delta > 0) {
                        canApply = playerProgressState.statPoints >= delta;
                    } else if (delta < 0) {
                        canApply = currentValue + delta >= MIN_PRIMARY_STAT_VALUE;
                    }
                    button.disabled = !canApply;
                    button.classList.toggle('opacity-40', !canApply);
                    button.classList.toggle('cursor-not-allowed', !canApply);
                });
            };

            const renderStatusSummary = () => {
                const levelEl = document.getElementById('status-lvl');
                const expEl = document.getElementById('status-exp');
                const nextEl = document.getElementById('status-next');
                const expBarEl = document.getElementById('status-exp-bar');
                const statPointsEl = document.getElementById('status-stat-points');
                const requiredExp = getRequiredExp(playerProgressState.level);
                if (levelEl) {
                    levelEl.innerText = String(playerProgressState.level);
                }
                if (expEl) {
                    expEl.innerText = String(playerProgressState.exp);
                }
                if (nextEl) {
                    nextEl.innerText = String(requiredExp);
                }
                if (expBarEl) {
                    const ratio = requiredExp > 0 ? Math.min(100, Math.max(0, (playerProgressState.exp / requiredExp) * 100)) : 0;
                    expBarEl.style.width = `${ratio.toFixed(2)}%`;
                }
                if (statPointsEl) {
                    statPointsEl.innerText = String(playerProgressState.statPoints);
                }
                const headerLevelEl = document.getElementById('header-lvl');
                if (headerLevelEl) {
                    headerLevelEl.innerText = String(playerProgressState.level);
                }
                const battleExpTextEl = document.getElementById('player-exp-text-battle');
                if (battleExpTextEl) {
                    battleExpTextEl.innerText = `${playerProgressState.exp}/${requiredExp}`;
                }
                const battleExpBarEl = document.getElementById('player-exp-bar-battle');
                if (battleExpBarEl) {
                    const ratio = requiredExp > 0 ? Math.min(100, Math.max(0, (playerProgressState.exp / requiredExp) * 100)) : 0;
                    battleExpBarEl.style.width = `${ratio.toFixed(2)}%`;
                }
                updateStatAdjustButtonState();
            };

            const addExperience = (amount) => {
                if (!Number.isFinite(amount) || amount <= 0) {
                    return { leveledUpCount: 0 };
                }
                let leveledUpCount = 0;
                playerProgressState.exp += Math.floor(amount);
                while (playerProgressState.exp >= getRequiredExp(playerProgressState.level)) {
                    const required = getRequiredExp(playerProgressState.level);
                    playerProgressState.exp -= required;
                    playerProgressState.level += 1;
                    playerProgressState.statPoints += LEVEL_UP_STAT_POINT_GAIN;
                    leveledUpCount += 1;
                }
                renderStatusSummary();
                return { leveledUpCount };
            };

            const changePrimaryStat = (statKey, delta) => {
                if (!Object.prototype.hasOwnProperty.call(playerProgressState.primaryStats, statKey)) {
                    return;
                }
                const value = Number(playerProgressState.primaryStats[statKey] || MIN_PRIMARY_STAT_VALUE);
                if (delta > 0) {
                    if (playerProgressState.statPoints < delta) {
                        return;
                    }
                    playerProgressState.primaryStats[statKey] = value + delta;
                    playerProgressState.statPoints -= delta;
                } else if (delta < 0) {
                    const maxDecrement = Math.max(0, value - MIN_PRIMARY_STAT_VALUE);
                    const decrement = Math.min(Math.abs(delta), maxDecrement);
                    if (decrement <= 0) {
                        return;
                    }
                    playerProgressState.primaryStats[statKey] = value - decrement;
                    playerProgressState.statPoints += decrement;
                } else {
                    return;
                }
                renderDerivedSecondaryStats({ primaryStats: playerProgressState.primaryStats, bonusStats: getEquippedBonusStats() });
                renderStatusSummary();
            };

            const renderDerivedSecondaryStats = ({
                primaryStats = DEFAULT_PRIMARY_STATS,
                bonusStats = {}
            } = {}) => {
                const result = PlayerStatusCalculator.calculateSecondaryStats({ primaryStats, bonusStats });
                const { baseValues, bonusValues, totalValues, secondaryStats, primaryStats: basePrimary, primaryBonus, totalPrimary } = result;

                const primaryMainFieldDefinitions = [
                    { id: 'status-atk', key: PrimaryStatKey.STR },
                    { id: 'status-int', key: PrimaryStatKey.INT },
                    { id: 'status-def', key: PrimaryStatKey.VIT },
                    { id: 'status-dex', key: PrimaryStatKey.DEX },
                    { id: 'status-luk', key: PrimaryStatKey.LUK }
                ];
                primaryMainFieldDefinitions.forEach(({ id, key }) => {
                    const field = document.getElementById(id);
                    if (field) {
                        field.innerText = Math.floor(totalPrimary[key] || 0);
                    }
                });

                const secondaryMainFieldDefinitions = [
                    { id: 'stat-max-hp', key: SecondaryStatKey.MaxHP, isPercent: false },
                    { id: 'stat-max-mp', key: SecondaryStatKey.MaxCP, isPercent: false },
                    { id: 'stat-atk-flat', key: SecondaryStatKey.PhysicalAttack, isPercent: false },
                    { id: 'stat-magic-atk', key: SecondaryStatKey.MagicAttack, isPercent: false },
                    { id: 'stat-def-flat', key: SecondaryStatKey.Defense, isPercent: false },
                    { id: 'stat-hit', key: SecondaryStatKey.HitRate, isPercent: false, digits: 1 },
                    { id: 'stat-eva', key: SecondaryStatKey.AvoidRate, isPercent: true, digits: 2 },
                    { id: 'stat-crit', key: SecondaryStatKey.CriticalChance, isPercent: true, digits: 2 },
                    { id: 'stat-dmg', key: SecondaryStatKey.BonusDamagePercent, isPercent: true, digits: 2 },
                    { id: 'stat-dr', key: SecondaryStatKey.BonusDefensePercent, isPercent: true, digits: 2 },
                    { id: 'stat-drop', key: SecondaryStatKey.DropRateBonus, isPercent: true, digits: 2 },
                    { id: 'stat-elite-encounter', key: SecondaryStatKey.EliteEncounterRate, isPercent: true, digits: 2 },
                    { id: 'stat-gold-gain', key: SecondaryStatKey.GoldGainRate, isPercent: true, digits: 2 },
                    { id: 'stat-exp-bonus', key: SecondaryStatKey.ExpGainRate, isPercent: true, digits: 2 }
                ];
                secondaryMainFieldDefinitions.forEach(({ id, key, isPercent, digits = 0 }) => {
                    const field = document.getElementById(id);
                    if (!field) {
                        return;
                    }
                    const totalValue = key === SecondaryStatKey.Defense ? secondaryStats[SecondaryStatKey.Defense] : totalValues[key] || 0;
                    field.innerText = digits > 0 ? Number(totalValue).toFixed(digits) : String(Math.floor(totalValue));
                    if (isPercent) {
                        field.innerText += '%';
                    }
                });

                const detailPrimaryDefinitions = [
                    { id: 'detail-primary-str', key: PrimaryStatKey.STR },
                    { id: 'detail-primary-int', key: PrimaryStatKey.INT },
                    { id: 'detail-primary-vit', key: PrimaryStatKey.VIT },
                    { id: 'detail-primary-dex', key: PrimaryStatKey.DEX },
                    { id: 'detail-primary-luk', key: PrimaryStatKey.LUK }
                ];
                detailPrimaryDefinitions.forEach(({ id, key }) => {
                    const field = document.getElementById(id);
                    if (!field) {
                        return;
                    }
                    field.innerText = formatStatBreakdown({
                        total: totalPrimary[key] || 0,
                        base: basePrimary[key] || 0,
                        bonus: primaryBonus[key] || 0
                    });
                });

                const detailSecondaryDefinitions = [
                    { id: 'detail-stat-max-hp', key: SecondaryStatKey.MaxHP, isPercent: false },
                    { id: 'detail-stat-max-mp', key: SecondaryStatKey.MaxCP, isPercent: false },
                    { id: 'detail-stat-atk-flat', key: SecondaryStatKey.PhysicalAttack, isPercent: false },
                    { id: 'detail-stat-magic-atk', key: SecondaryStatKey.MagicAttack, isPercent: false },
                    { id: 'detail-stat-def-flat', key: SecondaryStatKey.Defense, isPercent: false, baseKey: 'DefenseBase', bonusKey: 'DefenseBase' },
                    { id: 'detail-stat-hit', key: SecondaryStatKey.HitRate, isPercent: false, digits: 1 },
                    { id: 'detail-stat-eva', key: SecondaryStatKey.AvoidRate, isPercent: true, digits: 2 },
                    { id: 'detail-stat-crit', key: SecondaryStatKey.CriticalChance, isPercent: true, digits: 2 },
                    { id: 'detail-stat-dmg', key: SecondaryStatKey.BonusDamagePercent, isPercent: true, digits: 2 },
                    { id: 'detail-stat-dr', key: SecondaryStatKey.BonusDefensePercent, isPercent: true, digits: 2 },
                    { id: 'detail-stat-drop', key: SecondaryStatKey.DropRateBonus, isPercent: true, digits: 2 },
                    { id: 'detail-stat-elite-encounter', key: SecondaryStatKey.EliteEncounterRate, isPercent: true, digits: 2 },
                    { id: 'detail-stat-gold-gain', key: SecondaryStatKey.GoldGainRate, isPercent: true, digits: 2 },
                    { id: 'detail-stat-exp-bonus', key: SecondaryStatKey.ExpGainRate, isPercent: true, digits: 2 }
                ];
                detailSecondaryDefinitions.forEach(({ id, key, isPercent, digits = 0, baseKey, bonusKey }) => {
                    const field = document.getElementById(id);
                    if (!field) {
                        return;
                    }
                    const baseValue = baseValues[baseKey || key] || 0;
                    const bonusValue = bonusValues[bonusKey || key] || 0;
                    const totalValue = key === SecondaryStatKey.Defense ? secondaryStats[SecondaryStatKey.Defense] : totalValues[key] || 0;
                    field.innerText = formatStatBreakdown({
                        total: totalValue,
                        base: baseValue,
                        bonus: bonusValue,
                        digits,
                        suffix: isPercent ? '%' : ''
                    });
                });
            };

            const statValueIds = [
                'player-hp-text', 'player-cp-text', 'player-exp-text-battle',
                'enemy-hp-text', 'enemy-name',
                'status-lvl', 'status-atk', 'status-def', 'status-int', 'status-dex', 'status-luk', 'status-stat-points',
                'status-exp', 'status-next',
                'stat-max-hp', 'stat-max-mp', 'stat-atk-flat', 'stat-magic-atk',
                'stat-def-flat', 'stat-hit', 'stat-crit', 'stat-dmg', 'stat-dr',
                'stat-eva', 'stat-exp-bonus', 'stat-drop', 'stat-elite-encounter',
                'stat-gold-gain'
            ];

            const setDashValues = () => {
                statValueIds.forEach((id) => {
                    const el = document.getElementById(id);
                    if (el) {
                        el.innerText = '-';
                    }
                });

                const plainStatIds = ['stat-max-hp', 'stat-max-mp', 'stat-atk-flat', 'stat-magic-atk', 'stat-def-flat', 'stat-hit'];
                plainStatIds.forEach((id) => {
                    const el = document.getElementById(id);
                    if (el) {
                        el.innerText = '0';
                    }
                });

                const percentStatIds = ['stat-crit', 'stat-dmg', 'stat-dr', 'stat-eva', 'stat-exp-bonus', 'stat-drop', 'stat-elite-encounter', 'stat-gold-gain'];
                percentStatIds.forEach((id) => {
                    const el = document.getElementById(id);
                    if (el) {
                        el.innerText = '0%';
                    }
                });

                const detailIds = [
                    'detail-primary-str', 'detail-primary-int', 'detail-primary-vit', 'detail-primary-dex', 'detail-primary-luk',
                    'detail-stat-max-hp', 'detail-stat-max-mp', 'detail-stat-atk-flat', 'detail-stat-magic-atk', 'detail-stat-def-flat',
                    'detail-stat-hit', 'detail-stat-eva', 'detail-stat-crit', 'detail-stat-dmg', 'detail-stat-dr',
                    'detail-stat-drop', 'detail-stat-elite-encounter', 'detail-stat-gold-gain', 'detail-stat-exp-bonus'
                ];
                detailIds.forEach((id) => {
                    const el = document.getElementById(id);
                    if (el) {
                        const isPercentDetail = ['detail-stat-eva', 'detail-stat-crit', 'detail-stat-dmg', 'detail-stat-dr', 'detail-stat-drop', 'detail-stat-elite-encounter', 'detail-stat-gold-gain', 'detail-stat-exp-bonus'].includes(id);
                        el.innerText = isPercentDetail ? '0(0+0)%' : '0(0+0)';
                    }
                });

                ['player-hp-bar', 'player-cp-bar', 'player-exp-bar-battle', 'enemy-hp-bar', 'status-exp-bar'].forEach((id) => {
                    const bar = document.getElementById(id);
                    if (bar) bar.style.width = '0%';
                });

                ['battle-log', 'drop-log-list'].forEach((id) => {
                    const el = document.getElementById(id);
                    if (el) el.innerHTML = '';
                });
            };

            const runSecondaryStatSelfTests = () => {
                const testResult = PlayerStatusCalculator.calculateSecondaryStats({
                    primaryStats: {
                        [PrimaryStatKey.STR]: 10,
                        [PrimaryStatKey.INT]: 10,
                        [PrimaryStatKey.VIT]: 10,
                        [PrimaryStatKey.DEX]: 10,
                        [PrimaryStatKey.LUK]: 10
                    },
                    bonusStats: {
                        [SecondaryStatKey.BonusDefensePercent]: 20
                    }
                });

                const hitChanceDeltaZero = calculatePhysicalHitChancePercent({
                    attackerHitRate: 50,
                    defenderAvoidRate: 50
                });
                const hitChanceUpperClamp = calculatePhysicalHitChancePercent({
                    attackerHitRate: 9999,
                    defenderAvoidRate: 0
                });
                const hitChanceLowerClamp = calculatePhysicalHitChancePercent({
                    attackerHitRate: 0,
                    defenderAvoidRate: 9999,
                    flatBonus: -999
                });
                const enemyModifierBaseline = calculatePhysicalHitChancePercent({
                    attackerHitRate: 120,
                    defenderAvoidRate: 20,
                    flatBonus: COMBAT_CONSTANTS.ENEMY_HIT_CHANCE_FLAT_BONUS,
                    multiplier: COMBAT_CONSTANTS.ENEMY_HIT_CHANCE_MULTIPLIER
                });
                const neutralBaseline = calculatePhysicalHitChancePercent({
                    attackerHitRate: 120,
                    defenderAvoidRate: 20
                });
                const playerSidePhysicalResult = resolveHitResults({
                    attackDefinition: {
                        guaranteedHits: 1,
                        skillBonusHitCap: 0,
                        bonusHitChanceTable: [],
                        bonusHitDamageScaleTable: [],
                        damageType: 'Physical'
                    },
                    attackerPrimaryStats: DEFAULT_PRIMARY_STATS,
                    defenderPrimaryStats: DEFAULT_PRIMARY_STATS,
                    attackerSecondaryStats: {
                        [SecondaryStatKey.HitRate]: 120,
                        [SecondaryStatKey.CriticalChance]: 0
                    },
                    defenderSecondaryStats: {
                        [SecondaryStatKey.AvoidRate]: 20
                    },
                    attackerSide: CombatActorSide.Player,
                    rng: () => 0
                });
                const enemySidePhysicalResult = resolveHitResults({
                    attackDefinition: {
                        guaranteedHits: 1,
                        skillBonusHitCap: 0,
                        bonusHitChanceTable: [],
                        bonusHitDamageScaleTable: [],
                        damageType: 'Physical'
                    },
                    attackerPrimaryStats: DEFAULT_PRIMARY_STATS,
                    defenderPrimaryStats: DEFAULT_PRIMARY_STATS,
                    attackerSecondaryStats: {
                        [SecondaryStatKey.HitRate]: 120,
                        [SecondaryStatKey.CriticalChance]: 0
                    },
                    defenderSecondaryStats: {
                        [SecondaryStatKey.AvoidRate]: 20
                    },
                    attackerSide: CombatActorSide.Enemy,
                    rng: () => 0
                });
                const magicalResult = resolveHitResults({
                    attackDefinition: {
                        guaranteedHits: 1,
                        skillBonusHitCap: 0,
                        bonusHitChanceTable: [],
                        bonusHitDamageScaleTable: [],
                        damageType: 'Magical'
                    },
                    attackerPrimaryStats: DEFAULT_PRIMARY_STATS,
                    defenderPrimaryStats: DEFAULT_PRIMARY_STATS,
                    attackerSecondaryStats: {
                        [SecondaryStatKey.HitRate]: 1,
                        [SecondaryStatKey.CriticalChance]: 0
                    },
                    defenderSecondaryStats: {
                        [SecondaryStatKey.AvoidRate]: 999
                    },
                    rng: () => 0.9999
                });
                const physicalNormalDamage = calcPhysicalDamageOnHit({
                    attackerSecondaryStats: {
                        [SecondaryStatKey.PhysicalAttack]: 40
                    },
                    defenderSecondaryStats: {
                        [SecondaryStatKey.Defense]: 25
                    },
                    skillPowerMultiplier: 1.5,
                    totalBonusDamagePercent: 20,
                    critTier: CritTier.None
                });
                const physicalCriticalDamage = calcPhysicalDamageOnHit({
                    attackerSecondaryStats: {
                        [SecondaryStatKey.PhysicalAttack]: 40
                    },
                    defenderSecondaryStats: {
                        [SecondaryStatKey.Defense]: 25
                    },
                    skillPowerMultiplier: 1.5,
                    totalBonusDamagePercent: 20,
                    critTier: CritTier.Critical
                });
                const physicalDoubleCriticalDamage = calcPhysicalDamageOnHit({
                    attackerSecondaryStats: {
                        [SecondaryStatKey.PhysicalAttack]: 40
                    },
                    defenderSecondaryStats: {
                        [SecondaryStatKey.Defense]: 25
                    },
                    skillPowerMultiplier: 1.5,
                    totalBonusDamagePercent: 20,
                    critTier: CritTier.DoubleCritical
                });
                const magicalDamage = calcMagicDamage({
                    attackerSecondaryStats: {
                        [SecondaryStatKey.MagicAttack]: 46
                    },
                    defenderSecondaryStats: {
                        [SecondaryStatKey.Defense]: 25
                    },
                    skillPowerMultiplier: 1.8,
                    totalBonusDamagePercent: 20
                });
                const minDamagePhysical = calcPhysicalDamageOnHit({
                    attackerSecondaryStats: {
                        [SecondaryStatKey.PhysicalAttack]: 1
                    },
                    defenderSecondaryStats: {
                        [SecondaryStatKey.Defense]: 999999
                    },
                    skillPowerMultiplier: 1,
                    totalBonusDamagePercent: 0,
                    critTier: CritTier.None
                });

                const checks = [
                    { ok: testResult.totalValues[SecondaryStatKey.MaxHP] === 220, message: 'MaxHPå¼' },
                    { ok: testResult.totalValues[SecondaryStatKey.MaxCP] === 130, message: 'MaxCPå¼' },
                    { ok: testResult.totalValues[SecondaryStatKey.PhysicalAttack] === 40, message: 'PhysicalAttackå¼' },
                    { ok: testResult.totalValues[SecondaryStatKey.MagicAttack] === 46, message: 'MagicAttackå¼' },
                    { ok: testResult.totalValues.DefenseBase === 25, message: 'DefenseBaseå¼' },
                    { ok: testResult.secondaryStats[SecondaryStatKey.Defense] === 30, message: 'BonusDefensePercenté©ç”¨' },
                    { ok: Math.abs(testResult.totalValues[SecondaryStatKey.CriticalChance] - 6.5) < 1e-9, message: 'CriticalChanceå¼' },
                    { ok: Math.abs(testResult.totalValues[SecondaryStatKey.DropRateBonus] - 2.0) < 1e-9, message: 'DropRateBonuså¼' },
                    { ok: Math.abs(hitChanceDeltaZero - COMBAT_CONSTANTS.BASE_HIT_CHANCE) < 1e-9, message: 'å‘½ä¸­ç‡Delta=0å¼' },
                    { ok: Math.abs(hitChanceUpperClamp - COMBAT_CONSTANTS.MAX_HIT_CHANCE) < 1e-9, message: 'å‘½ä¸­ç‡ä¸Šé™ã‚¯ãƒ©ãƒ³ãƒ—' },
                    { ok: Math.abs(hitChanceLowerClamp - COMBAT_CONSTANTS.MIN_HIT_CHANCE) < 1e-9, message: 'å‘½ä¸­ç‡ä¸‹é™ã‚¯ãƒ©ãƒ³ãƒ—' },
                    { ok: magicalResult.length === 1 && magicalResult[0].isHit === true && magicalResult[0].hitChancePercent === 100, message: 'é­”æ³•å¿…ä¸­' },
                    { ok: Math.abs(enemyModifierBaseline - neutralBaseline) < 1e-9, message: 'æ•µè£œæ­£åˆæœŸå€¤ã®ä¸­ç«‹æ€§' },
                    { ok: playerSidePhysicalResult.length === 1 && Math.abs(playerSidePhysicalResult[0].hitChancePercent - neutralBaseline) < 1e-9, message: 'ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼å´ã¯æ•µè£œæ­£ã‚’é©ç”¨ã—ãªã„' },
                    { ok: enemySidePhysicalResult.length === 1 && Math.abs(enemySidePhysicalResult[0].hitChancePercent - neutralBaseline) < 1e-9, message: 'æ•µå´åˆæœŸè£œæ­£ã¯ä¸­ç«‹ã§åŒå¼' },
                    { ok: physicalNormalDamage.finalDamage === 57, message: 'ç‰©ç†ãƒ€ãƒ¡ãƒ¼ã‚¸é€šå¸¸å¼' },
                    { ok: physicalCriticalDamage.finalDamage === 115 && physicalCriticalDamage.isCritical === true, message: 'ç‰©ç†ãƒ€ãƒ¡ãƒ¼ã‚¸ã‚¯ãƒªãƒ†ã‚£ã‚«ãƒ«å¼' },
                    { ok: physicalDoubleCriticalDamage.finalDamage === 230 && physicalDoubleCriticalDamage.isDoubleCritical === true, message: 'ç‰©ç†ãƒ€ãƒ¡ãƒ¼ã‚¸ãƒ€ãƒ–ãƒ«ã‚¯ãƒªãƒ†ã‚£ã‚«ãƒ«å¼' },
                    { ok: magicalDamage.finalDamage === 84 && magicalDamage.isCritical === false && magicalDamage.isHit === true, message: 'é­”æ³•ãƒ€ãƒ¡ãƒ¼ã‚¸å¼' },
                    { ok: minDamagePhysical.finalDamage === COMBAT_CONSTANTS.MIN_DAMAGE, message: 'æœ€ä½ãƒ€ãƒ¡ãƒ¼ã‚¸ä¿è¨¼' }
                ];

                const failed = checks.find((check) => !check.ok);
                if (failed) {
                    throw new Error(`SecondaryStatSelfTest failed: ${failed.message}`);
                }
            };

            const MAX_IMPLEMENTED_FLOOR = 500;

            const ENEMY_COMMON_BASE_RANGES = Object.freeze({
                maxHp: [70, 90],
                physicalAttack: [8, 10],
                magicAttack: [0, 0],
                defense: [11, 13],
                hitRate: [22, 22],
                avoidRate: [85, 85],
                criticalChance: [0, 0],
                bonusDamagePercent: [0, 0],
                bonusDefensePercent: [0, 0],
                luk: [0, 0]
            });

            const ENEMY_TIER_SCALING = Object.freeze({
                maxHp: 1.18,
                physicalAttack: 1.14,
                magicAttack: 1.14,
                defense: 1.16,
                hitRate: 1,
                avoidRate: 1,
                criticalChance: 1,
                bonusDamagePercent: 1,
                bonusDefensePercent: 1,
                luk: 1
            });

            const ENEMY_AFFIX_SCALING = Object.freeze({
                normal: {
                    key: 'normal',
                    label: 'Normal',
                    statMultipliers: {
                        maxHp: 1,
                        physicalAttack: 1,
                        magicAttack: 1,
                        defense: 1,
                        hitRate: 1,
                        avoidRate: 1,
                        criticalChance: 1,
                        bonusDamagePercent: 1,
                        bonusDefensePercent: 1,
                        luk: 1
                    }
                },
                elite: {
                    key: 'elite',
                    label: 'Elite',
                    statMultipliers: {
                        maxHp: 1.25,
                        physicalAttack: 1.15,
                        magicAttack: 1.15,
                        defense: 1.2,
                        hitRate: 1,
                        avoidRate: 1,
                        criticalChance: 1,
                        bonusDamagePercent: 1,
                        bonusDefensePercent: 1,
                        luk: 1
                    }
                }
            });

            const FLOOR_ENEMY_POOLS = Object.freeze([
                Object.freeze([
                    { id: 'f001_slime', name: 'ç·‘ã‚¹ãƒ©ã‚¤ãƒ ', iconClass: 'fa-droplet', iconColorClass: 'text-emerald-400', statMultipliers: { maxHp: 0.9, defense: 0.9, physicalAttack: 0.95 } },
                    { id: 'f001_goblin', name: 'ã‚´ãƒ–ãƒªãƒ³æ–¥å€™', iconClass: 'fa-dagger', iconColorClass: 'text-lime-500', statMultipliers: { maxHp: 1.0, defense: 1.0, physicalAttack: 1.0 } },
                    { id: 'f001_wolf', name: 'ç°æ¯›ã‚¦ãƒ«ãƒ•', iconClass: 'fa-dog', iconColorClass: 'text-slate-500', statMultipliers: { maxHp: 0.95, defense: 0.9, physicalAttack: 1.1 } }
                ]),
                Object.freeze([
                    { id: 'f101_skeleton', name: 'éª¸éª¨å…µ', iconClass: 'fa-skull', iconColorClass: 'text-slate-400', statMultipliers: { maxHp: 1.05, defense: 1.05, physicalAttack: 1.05 } },
                    { id: 'f101_bat', name: 'ãƒ–ãƒ©ãƒƒãƒ‰ãƒãƒƒãƒˆ', iconClass: 'fa-bat', iconColorClass: 'text-purple-500', statMultipliers: { maxHp: 0.9, defense: 0.9, physicalAttack: 1.15 } },
                    { id: 'f101_orc', name: 'ã‚ªãƒ¼ã‚¯æˆ¦å£«', iconClass: 'fa-hammer', iconColorClass: 'text-amber-700', statMultipliers: { maxHp: 1.15, defense: 1.1, physicalAttack: 1.0 } }
                ]),
                Object.freeze([
                    { id: 'f201_gargoyle', name: 'ã‚¬ãƒ¼ã‚´ã‚¤ãƒ«', iconClass: 'fa-chess-rook', iconColorClass: 'text-stone-500', statMultipliers: { maxHp: 1.1, defense: 1.2, physicalAttack: 0.95 } },
                    { id: 'f201_lizard', name: 'ãƒªã‚¶ãƒ¼ãƒ‰ãƒãƒ³', iconClass: 'fa-dragon', iconColorClass: 'text-teal-500', statMultipliers: { maxHp: 1.0, defense: 1.0, physicalAttack: 1.1 } },
                    { id: 'f201_bandit', name: 'å±±è³Šå‰£å£«', iconClass: 'fa-user-ninja', iconColorClass: 'text-rose-500', statMultipliers: { maxHp: 0.95, defense: 0.95, physicalAttack: 1.2 } }
                ]),
                Object.freeze([
                    { id: 'f301_dullahan', name: 'ãƒ‡ãƒ¥ãƒ©ãƒãƒ³', iconClass: 'fa-shield', iconColorClass: 'text-indigo-500', statMultipliers: { maxHp: 1.15, defense: 1.1, physicalAttack: 1.1 } },
                    { id: 'f301_ogre', name: 'ã‚ªãƒ¼ã‚¬', iconClass: 'fa-dumbbell', iconColorClass: 'text-orange-600', statMultipliers: { maxHp: 1.2, defense: 1.0, physicalAttack: 1.15 } },
                    { id: 'f301_wraith', name: 'ãƒ¬ã‚¤ã‚¹', iconClass: 'fa-ghost', iconColorClass: 'text-cyan-400', statMultipliers: { maxHp: 1.0, defense: 0.95, physicalAttack: 1.2 } }
                ]),
                Object.freeze([
                    { id: 'f401_revenant', name: 'ãƒ¬ãƒ´ãƒŠãƒ³ãƒˆ', iconClass: 'fa-skull-crossbones', iconColorClass: 'text-red-500', statMultipliers: { maxHp: 1.15, defense: 1.15, physicalAttack: 1.1 } },
                    { id: 'f401_manticore', name: 'ãƒãƒ³ãƒ†ã‚£ã‚³ã‚¢å¹¼ä½“', iconClass: 'fa-cat', iconColorClass: 'text-yellow-600', statMultipliers: { maxHp: 1.05, defense: 0.95, physicalAttack: 1.25 } },
                    { id: 'f401_knight', name: 'å‘ªé‹¼é¨å£«', iconClass: 'fa-shield-halved', iconColorClass: 'text-slate-600', statMultipliers: { maxHp: 1.2, defense: 1.25, physicalAttack: 1.0 } }
                ])
            ]);

            const EQUIP_SLOT = Object.freeze({
                weapon: 'weapon',
                armor: 'armor',
                head: 'head',
                hands: 'hands',
                feet: 'feet',
                accessory: 'accessory'
            });

            const ITEM_RARITY = Object.freeze({
                normal: 'normal',
                magic: 'magic',
                rare: 'rare',
                legendary: 'legendary'
            });

            const RARITY_DROP_WEIGHTS = Object.freeze([
                { rarity: ITEM_RARITY.normal, weight: 85 },
                { rarity: ITEM_RARITY.magic, weight: 12 },
                { rarity: ITEM_RARITY.rare, weight: 3 }
            ]);

            const RARITY_MULTIPLIER = Object.freeze({
                [ITEM_RARITY.normal]: 1,
                [ITEM_RARITY.magic]: 1.1,
                [ITEM_RARITY.rare]: 1.3,
                [ITEM_RARITY.legendary]: 1.6
            });

            const AFFIX_COUNT_WEIGHTS = Object.freeze([
                { count: 0, weight: 40 },
                { count: 1, weight: 35 },
                { count: 2, weight: 20 },
                { count: 3, weight: 5 }
            ]);

            const WEAPON_MAIN_TIER_MULTIPLIER = 1.14;
            const BASE_DROP_CHANCE = 0.1;
            const DROP_RATE_BONUS_CAP = 0.25;
            const BOSS_LEGENDARY_DROP_CHANCE = 0.01;

            const AFFIX_POOL = Object.freeze([
                { id: 'affix_patk_flat', label: 'æ”»æ’ƒåŠ›', statKey: SecondaryStatKey.PhysicalAttack, min: 1, max: 100 },
                { id: 'affix_hp_flat', label: 'æœ€å¤§HP', statKey: SecondaryStatKey.MaxHP, min: 1, max: 300 },
                { id: 'affix_def_flat', label: 'é˜²å¾¡åŠ›', statKey: SecondaryStatKey.Defense, min: 1, max: 80 },
                { id: 'affix_hit_flat', label: 'å‘½ä¸­', statKey: SecondaryStatKey.HitRate, min: 1, max: 60 },
                { id: 'affix_crit_flat', label: 'ä¼šå¿ƒ', statKey: SecondaryStatKey.CriticalChance, min: 1, max: 20 },
                { id: 'affix_str_flat', label: 'STR', statKey: PrimaryStatKey.STR, min: 1, max: 30 },
                { id: 'affix_vit_flat', label: 'VIT', statKey: PrimaryStatKey.VIT, min: 1, max: 30 },
                { id: 'affix_int_flat', label: 'INT', statKey: PrimaryStatKey.INT, min: 1, max: 30 },
                { id: 'affix_dex_flat', label: 'DEX', statKey: PrimaryStatKey.DEX, min: 1, max: 30 },
                { id: 'affix_luk_flat', label: 'LUK', statKey: PrimaryStatKey.LUK, min: 1, max: 30 },
                { id: 'affix_exp_flat', label: 'çµŒé¨“å€¤ç²å¾—è£œæ­£', statKey: SecondaryStatKey.ExpGainRate, min: 1, max: 15 }
            ]);

            const EQUIPMENT_DROP_TABLES = Object.freeze([
                {
                    minFloor: 1,
                    maxFloor: 100,
                    bases: [
                        { id: 'w_t1_sword', slot: EQUIP_SLOT.weapon, name: 'è¨“ç·´å‰£', iconClass: 'fa-sword', mainStatKey: SecondaryStatKey.PhysicalAttack, mainStatMin: 8, mainStatMax: 18, uniqueStatKey: PrimaryStatKey.STR, uniqueMin: 1, uniqueMax: 5 },
                        { id: 'a_t1_armor', slot: EQUIP_SLOT.armor, name: 'é©é§', iconClass: 'fa-shield-halved', mainStatKey: SecondaryStatKey.Defense, mainStatMin: 6, mainStatMax: 14, uniqueStatKey: SecondaryStatKey.MaxHP, uniqueMin: 8, uniqueMax: 40 },
                        { id: 'h_t1_helm', slot: EQUIP_SLOT.head, name: 'é©å¸½å­', iconClass: 'fa-helmet-safety', mainStatKey: SecondaryStatKey.MaxHP, mainStatMin: 20, mainStatMax: 60, uniqueStatKey: PrimaryStatKey.VIT, uniqueMin: 1, uniqueMax: 5 },
                        { id: 'g_t1_glove', slot: EQUIP_SLOT.hands, name: 'ä½œæ¥­æ‰‹è¢‹', iconClass: 'fa-hand-back-fist', mainStatKey: SecondaryStatKey.HitRate, mainStatMin: 3, mainStatMax: 10, uniqueStatKey: PrimaryStatKey.DEX, uniqueMin: 1, uniqueMax: 5 },
                        { id: 'f_t1_boot', slot: EQUIP_SLOT.feet, name: 'é©é´', iconClass: 'fa-shoe-prints', mainStatKey: SecondaryStatKey.AvoidRate, mainStatMin: 2, mainStatMax: 8, uniqueStatKey: SecondaryStatKey.Defense, uniqueMin: 1, uniqueMax: 8 },
                        { id: 'x_t1_ring', slot: EQUIP_SLOT.accessory, name: 'å­¦å¾’ã®æŒ‡è¼ª', iconClass: 'fa-ring', mainStatKey: SecondaryStatKey.ExpGainRate, mainStatMin: 1, mainStatMax: 8, uniqueStatKey: PrimaryStatKey.LUK, uniqueMin: 1, uniqueMax: 5 }
                    ]
                },
                {
                    minFloor: 101,
                    maxFloor: 200,
                    bases: [
                        { id: 'w_t2_sword', slot: EQUIP_SLOT.weapon, name: 'é‹¼é‰„å‰£', iconClass: 'fa-sword', mainStatKey: SecondaryStatKey.PhysicalAttack, mainStatMin: 12, mainStatMax: 24, uniqueStatKey: PrimaryStatKey.STR, uniqueMin: 3, uniqueMax: 8 },
                        { id: 'a_t2_armor', slot: EQUIP_SLOT.armor, name: 'é‹¼é§', iconClass: 'fa-shield-halved', mainStatKey: SecondaryStatKey.Defense, mainStatMin: 9, mainStatMax: 18, uniqueStatKey: SecondaryStatKey.MaxHP, uniqueMin: 20, uniqueMax: 75 },
                        { id: 'h_t2_helm', slot: EQUIP_SLOT.head, name: 'é‹¼å…œ', iconClass: 'fa-helmet-safety', mainStatKey: SecondaryStatKey.MaxHP, mainStatMin: 35, mainStatMax: 90, uniqueStatKey: PrimaryStatKey.VIT, uniqueMin: 3, uniqueMax: 8 },
                        { id: 'g_t2_glove', slot: EQUIP_SLOT.hands, name: 'ç‹™æ’ƒæ‰‹è¢‹', iconClass: 'fa-hand-back-fist', mainStatKey: SecondaryStatKey.HitRate, mainStatMin: 6, mainStatMax: 14, uniqueStatKey: PrimaryStatKey.DEX, uniqueMin: 3, uniqueMax: 8 },
                        { id: 'f_t2_boot', slot: EQUIP_SLOT.feet, name: 'æˆ¦é—˜é´', iconClass: 'fa-shoe-prints', mainStatKey: SecondaryStatKey.AvoidRate, mainStatMin: 4, mainStatMax: 12, uniqueStatKey: SecondaryStatKey.Defense, uniqueMin: 4, uniqueMax: 12 },
                        { id: 'x_t2_ring', slot: EQUIP_SLOT.accessory, name: 'ç†Ÿç·´ã®æŒ‡è¼ª', iconClass: 'fa-ring', mainStatKey: SecondaryStatKey.ExpGainRate, mainStatMin: 3, mainStatMax: 11, uniqueStatKey: PrimaryStatKey.LUK, uniqueMin: 3, uniqueMax: 8 }
                    ]
                },
                {
                    minFloor: 201,
                    maxFloor: 300,
                    bases: [
                        { id: 'w_t3_sword', slot: EQUIP_SLOT.weapon, name: 'é¨å£«å›£å‰£', iconClass: 'fa-sword', mainStatKey: SecondaryStatKey.PhysicalAttack, mainStatMin: 16, mainStatMax: 30, uniqueStatKey: PrimaryStatKey.STR, uniqueMin: 6, uniqueMax: 12 },
                        { id: 'a_t3_armor', slot: EQUIP_SLOT.armor, name: 'é¨å£«å›£é§', iconClass: 'fa-shield-halved', mainStatKey: SecondaryStatKey.Defense, mainStatMin: 13, mainStatMax: 24, uniqueStatKey: SecondaryStatKey.MaxHP, uniqueMin: 40, uniqueMax: 110 },
                        { id: 'h_t3_helm', slot: EQUIP_SLOT.head, name: 'é¨å£«å›£å…œ', iconClass: 'fa-helmet-safety', mainStatKey: SecondaryStatKey.MaxHP, mainStatMin: 55, mainStatMax: 130, uniqueStatKey: PrimaryStatKey.VIT, uniqueMin: 6, uniqueMax: 12 },
                        { id: 'g_t3_glove', slot: EQUIP_SLOT.hands, name: 'å¿…ä¸­æ‰‹è¢‹', iconClass: 'fa-hand-back-fist', mainStatKey: SecondaryStatKey.HitRate, mainStatMin: 10, mainStatMax: 19, uniqueStatKey: PrimaryStatKey.DEX, uniqueMin: 6, uniqueMax: 12 },
                        { id: 'f_t3_boot', slot: EQUIP_SLOT.feet, name: 'ç–¾é¢¨ã®é´', iconClass: 'fa-shoe-prints', mainStatKey: SecondaryStatKey.AvoidRate, mainStatMin: 7, mainStatMax: 16, uniqueStatKey: SecondaryStatKey.Defense, uniqueMin: 8, uniqueMax: 17 },
                        { id: 'x_t3_ring', slot: EQUIP_SLOT.accessory, name: 'æ¢æ±‚è€…ã®æŒ‡è¼ª', iconClass: 'fa-ring', mainStatKey: SecondaryStatKey.ExpGainRate, mainStatMin: 5, mainStatMax: 14, uniqueStatKey: PrimaryStatKey.LUK, uniqueMin: 6, uniqueMax: 12 }
                    ]
                },
                {
                    minFloor: 301,
                    maxFloor: 400,
                    bases: [
                        { id: 'w_t4_sword', slot: EQUIP_SLOT.weapon, name: 'è–é‹¼å‰£', iconClass: 'fa-sword', mainStatKey: SecondaryStatKey.PhysicalAttack, mainStatMin: 20, mainStatMax: 36, uniqueStatKey: PrimaryStatKey.STR, uniqueMin: 10, uniqueMax: 16 },
                        { id: 'a_t4_armor', slot: EQUIP_SLOT.armor, name: 'è–é‹¼é§', iconClass: 'fa-shield-halved', mainStatKey: SecondaryStatKey.Defense, mainStatMin: 17, mainStatMax: 30, uniqueStatKey: SecondaryStatKey.MaxHP, uniqueMin: 60, uniqueMax: 145 },
                        { id: 'h_t4_helm', slot: EQUIP_SLOT.head, name: 'è–é‹¼å…œ', iconClass: 'fa-helmet-safety', mainStatKey: SecondaryStatKey.MaxHP, mainStatMin: 75, mainStatMax: 165, uniqueStatKey: PrimaryStatKey.VIT, uniqueMin: 10, uniqueMax: 16 },
                        { id: 'g_t4_glove', slot: EQUIP_SLOT.hands, name: 'ç²¾å¯†æ‰‹è¢‹', iconClass: 'fa-hand-back-fist', mainStatKey: SecondaryStatKey.HitRate, mainStatMin: 13, mainStatMax: 24, uniqueStatKey: PrimaryStatKey.DEX, uniqueMin: 10, uniqueMax: 16 },
                        { id: 'f_t4_boot', slot: EQUIP_SLOT.feet, name: 'å¹»å½±é´', iconClass: 'fa-shoe-prints', mainStatKey: SecondaryStatKey.AvoidRate, mainStatMin: 10, mainStatMax: 20, uniqueStatKey: SecondaryStatKey.Defense, uniqueMin: 12, uniqueMax: 22 },
                        { id: 'x_t4_ring', slot: EQUIP_SLOT.accessory, name: 'è³¢è€…ã®æŒ‡è¼ª', iconClass: 'fa-ring', mainStatKey: SecondaryStatKey.ExpGainRate, mainStatMin: 7, mainStatMax: 17, uniqueStatKey: PrimaryStatKey.LUK, uniqueMin: 10, uniqueMax: 16 }
                    ]
                },
                {
                    minFloor: 401,
                    maxFloor: 500,
                    bases: [
                        { id: 'w_t5_sword', slot: EQUIP_SLOT.weapon, name: 'ç‹å‘½å‰£', iconClass: 'fa-sword', mainStatKey: SecondaryStatKey.PhysicalAttack, mainStatMin: 24, mainStatMax: 42, uniqueStatKey: PrimaryStatKey.STR, uniqueMin: 14, uniqueMax: 20 },
                        { id: 'a_t5_armor', slot: EQUIP_SLOT.armor, name: 'ç‹å‘½é§', iconClass: 'fa-shield-halved', mainStatKey: SecondaryStatKey.Defense, mainStatMin: 21, mainStatMax: 36, uniqueStatKey: SecondaryStatKey.MaxHP, uniqueMin: 90, uniqueMax: 190 },
                        { id: 'h_t5_helm', slot: EQUIP_SLOT.head, name: 'ç‹å‘½å…œ', iconClass: 'fa-helmet-safety', mainStatKey: SecondaryStatKey.MaxHP, mainStatMin: 95, mainStatMax: 210, uniqueStatKey: PrimaryStatKey.VIT, uniqueMin: 14, uniqueMax: 20 },
                        { id: 'g_t5_glove', slot: EQUIP_SLOT.hands, name: 'ç¥çœ¼æ‰‹è¢‹', iconClass: 'fa-hand-back-fist', mainStatKey: SecondaryStatKey.HitRate, mainStatMin: 16, mainStatMax: 28, uniqueStatKey: PrimaryStatKey.DEX, uniqueMin: 14, uniqueMax: 20 },
                        { id: 'f_t5_boot', slot: EQUIP_SLOT.feet, name: 'è¿…é›·é´', iconClass: 'fa-shoe-prints', mainStatKey: SecondaryStatKey.AvoidRate, mainStatMin: 12, mainStatMax: 24, uniqueStatKey: SecondaryStatKey.Defense, uniqueMin: 15, uniqueMax: 28 },
                        { id: 'x_t5_ring', slot: EQUIP_SLOT.accessory, name: 'è¦‡è€…ã®æŒ‡è¼ª', iconClass: 'fa-ring', mainStatKey: SecondaryStatKey.ExpGainRate, mainStatMin: 9, mainStatMax: 20, uniqueStatKey: PrimaryStatKey.LUK, uniqueMin: 14, uniqueMax: 20 }
                    ]
                }
             ]);

            const SELL_PRICE_BY_RARITY = Object.freeze({
                [ITEM_RARITY.normal]: 25,
                [ITEM_RARITY.magic]: 90,
                [ITEM_RARITY.rare]: 260,
                [ITEM_RARITY.legendary]: 1000
            });

            const equipmentState = {
                inventoryItems: [],
                equipped: {
                    weapon: null,
                    armor: null,
                    head: null,
                    hands: null,
                    feet: null,
                    accessory1: null,
                    accessory2: null
                },
                filter: 'all',
                sortOrder: 'newest'
            };

            const battleState = {
                currentFloor: 1,
                currentEnemy: null,
                enemyHp: 0,
                playerHp: 0,
                playerCp: 0,
                miniLogs: []
            };

            const normalizeDamageType = (damageKind) => (damageKind === 'Magic' ? 'Magical' : 'Physical');

            const clampFloor = (floorValue) => Math.max(1, Math.min(MAX_IMPLEMENTED_FLOOR, Math.floor(Number.isFinite(floorValue) ? floorValue : 1)));
            const toTierFromFloor = (floorValue) => Math.floor((clampFloor(floorValue) - 1) / 100);
            const randomIntInclusive = (min, max, rng = Math.random) => {
                const minValue = Math.floor(Math.min(min, max));
                const maxValue = Math.floor(Math.max(min, max));
                if (minValue === maxValue) {
                    return minValue;
                }
                const roll = Math.min(0.999999999, Math.max(0, Number(rng())));
                return minValue + Math.floor(roll * (maxValue - minValue + 1));
            };

            const generateEnemyStatsForFloor = ({ floor, archetype, affixKey = 'normal', rng = Math.random }) => {
                const tier = toTierFromFloor(floor);
                const affix = ENEMY_AFFIX_SCALING[affixKey] || ENEMY_AFFIX_SCALING.normal;
                const multipliers = archetype.statMultipliers || {};
                const pickFinalValue = (key) => {
                    const [rangeMin, rangeMax] = ENEMY_COMMON_BASE_RANGES[key];
                    const rolled = randomIntInclusive(rangeMin, rangeMax, rng);
                    const tierScale = Math.pow(ENEMY_TIER_SCALING[key] || 1, tier);
                    const archetypeScale = Number.isFinite(multipliers[key]) ? multipliers[key] : 1;
                    const affixScale = Number.isFinite(affix.statMultipliers[key]) ? affix.statMultipliers[key] : 1;
                    return Math.max(0, Math.floor(rolled * tierScale * archetypeScale * affixScale));
                };

                return {
                    maxHp: Math.max(1, pickFinalValue('maxHp')),
                    physicalAttack: pickFinalValue('physicalAttack'),
                    magicAttack: pickFinalValue('magicAttack'),
                    defense: pickFinalValue('defense'),
                    hitRate: pickFinalValue('hitRate'),
                    avoidRate: pickFinalValue('avoidRate'),
                    criticalChance: pickFinalValue('criticalChance'),
                    bonusDamagePercent: pickFinalValue('bonusDamagePercent'),
                    bonusDefensePercent: pickFinalValue('bonusDefensePercent'),
                    luk: pickFinalValue('luk')
                };
            };

            const buildEnemyForFloor = ({ floor, rng = Math.random, forcedEnemyIndex = null, affixKey = 'normal' }) => {
                const normalizedFloor = clampFloor(floor);
                const poolIndex = Math.min(FLOOR_ENEMY_POOLS.length - 1, Math.floor((normalizedFloor - 1) / 100));
                const pool = FLOOR_ENEMY_POOLS[poolIndex];
                const enemyIndex = Number.isFinite(forcedEnemyIndex)
                    ? Math.max(0, Math.min(pool.length - 1, Math.floor(forcedEnemyIndex)))
                    : randomIntInclusive(0, pool.length - 1, rng);
                const archetype = pool[enemyIndex];
                return {
                    id: archetype.id,
                    name: archetype.name,
                    iconClass: archetype.iconClass,
                    iconColorClass: archetype.iconColorClass,
                    enemyPoolIndex: enemyIndex,
                    enemyPoolSize: pool.length,
                    floor: normalizedFloor,
                    tier: toTierFromFloor(normalizedFloor),
                    affixKey,
                    stats: generateEnemyStatsForFloor({ floor: normalizedFloor, archetype, affixKey, rng }),
                    ai: {
                        defaultAttack: { damageKind: 'Physical', skillPower: 1.0 }
                    }
                };
            };

            const toEnemyCombatant = (enemy) => ({
                primaryStats: createPrimaryStats({ [PrimaryStatKey.LUK]: enemy.stats.luk }),
                secondaryStats: createSecondaryStats({
                    [SecondaryStatKey.MaxHP]: enemy.stats.maxHp,
                    [SecondaryStatKey.PhysicalAttack]: enemy.stats.physicalAttack,
                    [SecondaryStatKey.MagicAttack]: enemy.stats.magicAttack,
                    [SecondaryStatKey.Defense]: enemy.stats.defense,
                    [SecondaryStatKey.HitRate]: enemy.stats.hitRate,
                    [SecondaryStatKey.AvoidRate]: enemy.stats.avoidRate,
                    [SecondaryStatKey.CriticalChance]: enemy.stats.criticalChance,
                    [SecondaryStatKey.BonusDamagePercent]: enemy.stats.bonusDamagePercent,
                    [SecondaryStatKey.BonusDefensePercent]: enemy.stats.bonusDefensePercent
                })
            });

            const getEquippedBonusStats = () => {
                const merged = {};
                const addValue = (key, value) => {
                    if (!Number.isFinite(value) || value === 0) {
                        return;
                    }
                    merged[key] = (merged[key] || 0) + value;
                };
                const equippedItems = Object.values(equipmentState.equipped).filter(Boolean);
                equippedItems.forEach((item) => {
                    if (item.isBroken) {
                        return;
                    }
                    normalizeInventoryItem(item);
                    (item.finalStats || []).forEach(({ key, value }) => addValue(key, value));
                });
                return merged;
            };

            const getPlayerCombatant = () => {
                const primaryStats = createPrimaryStats(playerProgressState.primaryStats);
                const derived = PlayerStatusCalculator.calculateSecondaryStats({
                    primaryStats,
                    bonusStats: getEquippedBonusStats()
                });
                return {
                    primaryStats,
                    secondaryStats: derived.secondaryStats
                };
            };

            const pushDropLog = (message, rarity = ITEM_RARITY.normal) => {
                const dropLogList = document.getElementById('drop-log-list');
                if (!dropLogList) {
                    return;
                }
                const row = document.createElement('div');
                row.className = `drop-log-item rarity-${rarity}`;
                row.innerHTML = `<i class="fas fa-box-open"></i><span>${message}</span>`;
                dropLogList.prepend(row);
                while (dropLogList.children.length > 8) {
                    dropLogList.removeChild(dropLogList.lastChild);
                }
            };

            const pickWeighted = (entries, rng = Math.random) => {
                const totalWeight = entries.reduce((sum, entry) => sum + Math.max(0, Number(entry.weight) || 0), 0);
                if (totalWeight <= 0) {
                    return entries[0] || null;
                }
                let cursor = rng() * totalWeight;
                for (const entry of entries) {
                    cursor -= Math.max(0, Number(entry.weight) || 0);
                    if (cursor <= 0) {
                        return entry;
                    }
                }
                return entries[entries.length - 1] || null;
            };

            const resolveEquipmentTableByFloor = (floor) => EQUIPMENT_DROP_TABLES.find((table) => floor >= table.minFloor && floor <= table.maxFloor) || EQUIPMENT_DROP_TABLES[EQUIPMENT_DROP_TABLES.length - 1];

            const rollItemRarity = (rng = Math.random) => {
                const picked = pickWeighted(RARITY_DROP_WEIGHTS, rng);
                return picked ? picked.rarity : ITEM_RARITY.normal;
            };

            const rollAffixCount = (rng = Math.random) => {
                const picked = pickWeighted(AFFIX_COUNT_WEIGHTS, rng);
                return picked ? picked.count : 0;
            };

            const rollInRange = (min, max, rng = Math.random) => {
                const safeMin = Math.floor(Math.min(min, max));
                const safeMax = Math.floor(Math.max(min, max));
                return safeMin + Math.floor(rng() * (safeMax - safeMin + 1));
            };

            const ENHANCE_STEP_RATE = 0.03;
            const getEnhanceSuccessRate = (level, enchantBonusRate = 0) => {
                const baseRate = Math.max(15, 100 - (Math.max(0, level) * 8));
                return Math.max(5, Math.min(100, baseRate + Math.max(0, enchantBonusRate)));
            };

            const getEnhanceLevelClass = (level, isBroken) => {
                if (isBroken) return 'enhance-broken';
                if (level >= 15) return 'enhance-white';
                if (level >= 12) return 'enhance-gold';
                if (level >= 10) return 'enhance-orange';
                if (level >= 8) return 'enhance-pink';
                if (level >= 6) return 'enhance-blue';
                if (level >= 4) return 'enhance-yellow';
                return 'enhance-green';
            };

            const getEnhanceCost = (item) => {
                const level = Math.max(0, Math.floor(Number(item?.enhanceLevel) || 0));
                return Math.max(10, Math.floor(getSellPrice(item) * (0.6 + (level * 0.35))));
            };

            const buildItemFinalStats = (item) => {
                if (!item) {
                    return [];
                }
                const enhanceLevel = Math.max(0, Math.floor(Number(item.enhanceLevel) || 0));
                const enhanceRate = 1 + (enhanceLevel * ENHANCE_STEP_RATE);
                const baseStats = [];
                const mainBaseValue = Math.max(0, Math.floor(Number(item.mainBaseValue) || 0));
                if (item.mainStatKey && mainBaseValue > 0) {
                    baseStats.push({ key: item.mainStatKey, value: Math.max(0, Math.floor(mainBaseValue * enhanceRate)) });
                }
                const uniqueBaseValue = Math.max(0, Math.floor(Number(item.uniqueBaseValue) || 0));
                if (item.uniqueStatKey && uniqueBaseValue > 0) {
                    baseStats.push({ key: item.uniqueStatKey, value: Math.max(0, Math.floor(uniqueBaseValue * enhanceRate)) });
                }
                (item.affixes || []).forEach((affix) => {
                    baseStats.push({ key: affix.key, value: Math.max(0, Math.floor(Number(affix.value) || 0)) });
                });
                return baseStats;
            };

            const normalizeInventoryItem = (item) => {
                if (!item) {
                    return item;
                }
                const normalized = item;
                normalized.enhanceLevel = Math.max(0, Math.floor(Number(normalized.enhanceLevel) || 0));
                normalized.isBroken = normalized.isBroken === true;
                normalized.isFavorite = normalized.isFavorite === true;
                if (!Number.isFinite(normalized.mainBaseValue) || !normalized.mainStatKey) {
                    const firstStat = Array.isArray(normalized.finalStats) ? normalized.finalStats[0] : null;
                    normalized.mainStatKey = normalized.mainStatKey || (firstStat ? firstStat.key : null);
                    normalized.mainBaseValue = Math.max(0, Math.floor(Number(normalized.mainBaseValue ?? (firstStat ? firstStat.value : 0)) || 0));
                }
                if (!Number.isFinite(normalized.uniqueBaseValue) || !normalized.uniqueStatKey) {
                    const secondStat = Array.isArray(normalized.finalStats) ? normalized.finalStats[1] : null;
                    normalized.uniqueStatKey = normalized.uniqueStatKey || (secondStat ? secondStat.key : null);
                    normalized.uniqueBaseValue = Math.max(0, Math.floor(Number(normalized.uniqueBaseValue ?? (secondStat ? secondStat.value : 0)) || 0));
                }
                normalized.finalStats = buildItemFinalStats(normalized);
                normalized.mainSummary = `${normalized.mainStatKey}+${Math.max(0, Math.floor((normalized.finalStats[0] || {}).value || 0))}`;
                return normalized;
            };

            const generateItemFromBase = ({ floor, baseDefinition, rarity, rng = Math.random }) => {
                const tier = toTierFromFloor(floor);
                const rarityMultiplier = RARITY_MULTIPLIER[rarity] || 1;
                const tierScale = baseDefinition.slot === EQUIP_SLOT.weapon ? Math.pow(WEAPON_MAIN_TIER_MULTIPLIER, tier) : 1;

                const mainRoll = rollInRange(baseDefinition.mainStatMin, baseDefinition.mainStatMax, rng);
                const mainValue = Math.floor(mainRoll * rarityMultiplier * tierScale);

                const uniqueRoll = rollInRange(baseDefinition.uniqueMin, baseDefinition.uniqueMax, rng);
                const uniqueValue = Math.floor(uniqueRoll * rarityMultiplier);

                const finalStats = [
                    { key: baseDefinition.mainStatKey, value: Math.max(0, mainValue) },
                    { key: baseDefinition.uniqueStatKey, value: Math.max(0, uniqueValue) }
                ];

                const affixCount = rollAffixCount(rng);
                const affixes = [];
                for (let i = 0; i < affixCount; i += 1) {
                    const affix = AFFIX_POOL[Math.floor(rng() * AFFIX_POOL.length)];
                    if (!affix) {
                        continue;
                    }
                    const value = Math.floor(rollInRange(affix.min, affix.max, rng));
                    affixes.push({ id: affix.id, label: affix.label, key: affix.statKey, value });
                    finalStats.push({ key: affix.statKey, value });
                }

                const sellPrice = Math.floor((SELL_PRICE_BY_RARITY[rarity] || 20) + affixes.reduce((sum, affix) => sum + Math.max(1, Math.floor(affix.value / 8)), 0));

                return {
                    instanceId: `itm_${Date.now()}_${Math.floor(rng() * 1e9)}`,
                    baseId: baseDefinition.id,
                    name: baseDefinition.name,
                    iconClass: baseDefinition.iconClass,
                    slot: baseDefinition.slot,
                    rarity,
                    floor,
                    tier,
                    affixes,
                    mainStatKey: baseDefinition.mainStatKey,
                    uniqueStatKey: baseDefinition.uniqueStatKey,
                    mainBaseValue: Math.max(0, mainValue),
                    uniqueBaseValue: Math.max(0, uniqueValue),
                    enhanceLevel: 0,
                    isBroken: false,
                    isFavorite: false,
                    finalStats,
                    sellPrice,
                    mainSummary: `${baseDefinition.mainStatKey}+${Math.max(0, mainValue)}`
                };
            };

            const attemptEquipmentDrop = ({ floor, playerCombatant, isBoss = false, rng = Math.random }) => {
                if (isBoss && rng() < BOSS_LEGENDARY_DROP_CHANCE) {
                    return null;
                }
                const dropRateBonus = Math.min(DROP_RATE_BONUS_CAP, Math.max(0, (playerCombatant.secondaryStats.DropRateBonus || 0) / 100));
                const normalDropChance = Math.min(1, BASE_DROP_CHANCE + dropRateBonus);
                if (rng() >= normalDropChance) {
                    return null;
                }
                const table = resolveEquipmentTableByFloor(floor);
                const baseDefinition = table.bases[Math.floor(rng() * table.bases.length)];
                const rarity = rollItemRarity(rng);
                if (!baseDefinition) {
                    return null;
                }
                return generateItemFromBase({ floor, baseDefinition, rarity, rng });
            };

            const getSlotLabel = (slot) => {
                if (slot === EQUIP_SLOT.weapon) return 'æ­¦å™¨';
                if (slot === EQUIP_SLOT.armor) return 'é§';
                if (slot === EQUIP_SLOT.head) return 'å…œ';
                if (slot === EQUIP_SLOT.hands) return 'æ‰‹';
                if (slot === EQUIP_SLOT.feet) return 'è¶³';
                if (slot === EQUIP_SLOT.accessory) return 'è£…é£¾å“';
                return 'è£…å‚™';
            };

            const equipmentUiState = {
                pendingEquipItemId: null,
                pendingEquipSlotKey: null
            };

            const enhanceUiState = {
                resolveTimerId: null,
                pendingResult: null
            };

            const clearEnhanceResolveTimer = () => {
                if (enhanceUiState.resolveTimerId) {
                    clearTimeout(enhanceUiState.resolveTimerId);
                    enhanceUiState.resolveTimerId = null;
                }
            };

            const getEquippedSlotKeyByItemId = (instanceId) => {
                if (!instanceId) {
                    return null;
                }
                const slots = ['weapon', 'armor', 'head', 'hands', 'feet', 'accessory1', 'accessory2'];
                for (const slotKey of slots) {
                    const entry = equipmentState.equipped[slotKey];
                    if (entry && entry.instanceId === instanceId) {
                        return slotKey;
                    }
                }
                return null;
            };

            const isItemEquipped = (instanceId) => Boolean(getEquippedSlotKeyByItemId(instanceId));

            const unequipItemById = (instanceId) => {
                const slotKey = getEquippedSlotKeyByItemId(instanceId);
                if (!slotKey) {
                    return;
                }
                equipmentState.equipped[slotKey] = null;
                renderDerivedSecondaryStats({ primaryStats: playerProgressState.primaryStats, bonusStats: getEquippedBonusStats() });
                renderStatusSummary();
                renderBattleBars();
                renderEquipmentSummary();
                renderInventory();
                persistBattleState();
            };

            const getSellPrice = (item) => {
                if (!item) {
                    return 0;
                }
                return Math.max(0, Math.floor(Number(item.sellPrice) || 0));
            };

            const toggleItemFavorite = (instanceId) => {
                const item = equipmentState.inventoryItems.find((entry) => entry.instanceId === instanceId);
                if (!item) {
                    return;
                }
                item.isFavorite = !item.isFavorite;
                renderInventory();
                persistBattleState();
            };

            const sellItemById = (instanceId) => {
                const item = equipmentState.inventoryItems.find((entry) => entry.instanceId === instanceId);
                if (!item || item.isFavorite || isItemEquipped(instanceId)) {
                    return;
                }
                playerProgressState.gold = Math.max(0, playerProgressState.gold + getSellPrice(item));
                equipmentState.inventoryItems = equipmentState.inventoryItems.filter((entry) => entry.instanceId !== instanceId);
                renderStatusSummary();
                renderInventory();
                persistBattleState();
            };

            const getCompareTargetSlotKey = (item) => {
                if (!item) {
                    return null;
                }
                if (item.slot === EQUIP_SLOT.accessory) {
                    if (equipmentState.equipped.accessory1 && equipmentState.equipped.accessory1.instanceId === item.instanceId) {
                        return 'accessory1';
                    }
                    if (equipmentState.equipped.accessory2 && equipmentState.equipped.accessory2.instanceId === item.instanceId) {
                        return 'accessory2';
                    }
                    return equipmentState.equipped.accessory1 ? 'accessory1' : 'accessory2';
                }
                return item.slot;
            };

            const syncEnhanceModal = (item) => {
                if (!item) {
                    return;
                }
                normalizeInventoryItem(item);
                const level = Math.max(0, Math.floor(Number(item.enhanceLevel) || 0));
                const cost = getEnhanceCost(item);
                const player = getPlayerCombatant();
                const successRate = getEnhanceSuccessRate(level, player.secondaryStats.EnchantSuccessRateBonus || 0);
                const titleEl = document.getElementById('enhance-modal-title');
                const levelEl = document.getElementById('enhance-modal-level');
                const costEl = document.getElementById('enhance-modal-cost');
                const previewEl = document.getElementById('enhance-modal-preview');
                const warningEl = document.getElementById('enhance-modal-warning');
                const infoEl = document.getElementById('enhance-modal-info');
                const progressEl = document.getElementById('enhance-modal-progress');
                const resultEl = document.getElementById('enhance-modal-result');
                const actionBtn = document.getElementById('enhance-modal-repeat');
                const actionLabel = document.getElementById('enhance-modal-repeat-label');
                if (titleEl) titleEl.innerHTML = `<i class="fas fa-hammer text-slate-500"></i> ${formatItemDisplayName(item)}`;
                if (levelEl) levelEl.innerHTML = `<span class="enhance-label ${getEnhanceLevelClass(level, item.isBroken)}">+${level}</span>${item.isBroken ? ' <span class="enhance-broken">ç ´æ</span>' : ''}`;
                if (costEl) costEl.innerText = `${cost}G`;
                if (previewEl) previewEl.innerText = item.isBroken
                    ? `ä¿®ç†å¾Œã«å¼·åŒ–å†é–‹ã§ãã¾ã™ï¼ˆæˆåŠŸç‡ ${successRate.toFixed(1)}%ï¼‰`
                    : `æˆåŠŸç‡ ${successRate.toFixed(1)}% / æ¬¡å¼·åŒ–ã§åŸºç¤ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹+3%`;
                if (warningEl) warningEl.innerText = level >= 10
                    ? 'å¤±æ•—æ™‚ã¯ç ´æï¼ˆä¿®ç†ãŒå¿…è¦ï¼‰'
                    : (level >= 6 ? 'å¤±æ•—æ™‚ã¯å¼·åŒ–å€¤-1' : 'å¤±æ•—æ™‚ã®å¼·åŒ–å€¤ä½ä¸‹ãªã—');
                const canAfford = playerProgressState.gold >= cost;
                const actionText = item.isBroken ? 'ä¿®ç†ã™ã‚‹' : 'å¼·åŒ–ã™ã‚‹';
                if (actionLabel) actionLabel.innerText = actionText;
                if (actionBtn) {
                    actionBtn.disabled = !canAfford;
                    actionBtn.className = `mt-4 w-full font-black py-2.5 rounded-xl shadow flex items-center justify-center gap-2 ${!canAfford
                        ? 'bg-slate-200 text-slate-400 cursor-not-allowed'
                        : (item.isBroken ? 'bg-emerald-600 text-white' : 'bg-slate-800 text-white')}`;
                    const actionIcon = item.isBroken ? 'fa-screwdriver-wrench' : 'fa-hammer';
                    actionBtn.innerHTML = `<i class="fas ${actionIcon}"></i><span id="enhance-modal-repeat-label">${actionText}</span>`;
                }
                if (infoEl) infoEl.classList.remove('hidden');
                if (progressEl) progressEl.classList.add('hidden');
                if (resultEl) resultEl.classList.add('hidden');
            };

            const openEnhanceModal = (instanceId) => {
                const item = equipmentState.inventoryItems.find((entry) => entry.instanceId === instanceId);
                const modal = document.getElementById('enhance-modal');
                if (!item || !modal) {
                    return;
                }
                modal.dataset.itemId = instanceId;
                modal.classList.remove('hidden');
                modal.classList.add('flex');
                syncEnhanceModal(item);
            };

            const runEnhancement = ({ skipAnimation = false } = {}) => {
                const modal = document.getElementById('enhance-modal');
                const instanceId = modal ? modal.dataset.itemId : '';
                const item = equipmentState.inventoryItems.find((entry) => entry.instanceId === instanceId);
                if (!item) {
                    return;
                }
                normalizeInventoryItem(item);
                const cost = getEnhanceCost(item);
                const warningEl = document.getElementById('enhance-modal-warning');
                if (playerProgressState.gold < cost) {
                    if (warningEl) warningEl.innerText = 'ã‚´ãƒ¼ãƒ«ãƒ‰ãŒè¶³ã‚Šã¾ã›ã‚“ã€‚';
                    return;
                }

                playerProgressState.gold = Math.max(0, playerProgressState.gold - cost);
                let success = true;
                let detailText = '';
                let extraText = '';

                if (item.isBroken) {
                    item.isBroken = false;
                    detailText = 'è£…å‚™ã‚’ä¿®ç†ã—ã¾ã—ãŸã€‚';
                    extraText = 'æ¬¡å›ã‹ã‚‰é€šå¸¸ã®å¼·åŒ–åˆ¤å®šã«ãªã‚Šã¾ã™ã€‚';
                } else {
                    const level = Math.max(0, Math.floor(Number(item.enhanceLevel) || 0));
                    const successRate = getEnhanceSuccessRate(level, getPlayerCombatant().secondaryStats.EnchantSuccessRateBonus || 0);
                    success = (Math.random() * 100) <= successRate;
                    if (success) {
                        item.enhanceLevel = level + 1;
                        detailText = `+${item.enhanceLevel} ã«ãªã‚Šã¾ã—ãŸã€‚`;
                        extraText = 'åŸºç¤ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã«+3%ãŒåæ˜ ã•ã‚Œã¾ã™ã€‚';
                    } else if (level >= 10) {
                        item.isBroken = true;
                        detailText = 'å¼·åŒ–å¤±æ•—ã§è£…å‚™ãŒç ´æã—ã¾ã—ãŸã€‚';
                        extraText = 'å†åº¦å¼·åŒ–ã™ã‚‹ã¨ä¿®ç†ã•ã‚Œã¾ã™ã€‚';
                    } else if (level >= 6) {
                        item.enhanceLevel = Math.max(0, level - 1);
                        detailText = `å¼·åŒ–å¤±æ•—: +${item.enhanceLevel} ã«ä½ä¸‹ã—ã¾ã—ãŸã€‚`;
                        extraText = 'æ¬¡å›ã¯å†åº¦ãƒãƒ£ãƒ¬ãƒ³ã‚¸ã§ãã¾ã™ã€‚';
                    } else {
                        detailText = 'å¼·åŒ–å¤±æ•—: å¼·åŒ–å€¤ã¯ç¶­æŒã•ã‚Œã¾ã—ãŸã€‚';
                        extraText = 'ã‚‚ã†ä¸€åº¦æŒ‘æˆ¦ã§ãã¾ã™ã€‚';
                    }
                }

                normalizeInventoryItem(item);
                renderDerivedSecondaryStats({ primaryStats: playerProgressState.primaryStats, bonusStats: getEquippedBonusStats() });
                renderStatusSummary();
                renderBattleBars();
                renderEquipmentSummary();
                renderInventory();
                persistBattleState();

                const infoEl = document.getElementById('enhance-modal-info');
                const progressEl = document.getElementById('enhance-modal-progress');
                const resultEl = document.getElementById('enhance-modal-result');
                const iconEl = document.getElementById('enhance-modal-result-icon');
                const titleEl = document.getElementById('enhance-modal-result-title');
                const detailEl = document.getElementById('enhance-modal-result-detail');
                const extraEl = document.getElementById('enhance-modal-result-extra');

                const showResult = () => {
                    clearEnhanceResolveTimer();
                    enhanceUiState.pendingResult = null;
                    if (infoEl) infoEl.classList.add('hidden');
                    if (progressEl) progressEl.classList.add('hidden');
                    if (resultEl) resultEl.classList.remove('hidden');
                    if (iconEl) iconEl.innerHTML = success
                        ? '<i class="fas fa-burst text-emerald-500 enhance-glow-success"></i>'
                        : (item.isBroken
                            ? '<i class="fas fa-skull-crossbones text-rose-600 enhance-glow-fail"></i>'
                            : '<i class="fas fa-triangle-exclamation text-rose-500 enhance-glow-fail"></i>');
                    if (titleEl) titleEl.innerText = success ? 'å¼·åŒ–æˆåŠŸ' : (item.isBroken ? 'è£…å‚™ç ´æ' : 'å¼·åŒ–å¤±æ•—');
                    if (detailEl) detailEl.innerText = detailText;
                    if (extraEl) extraEl.innerText = extraText;
                };

                if (skipAnimation) {
                    showResult();
                    return;
                }

                if (infoEl) infoEl.classList.add('hidden');
                if (resultEl) resultEl.classList.add('hidden');
                if (progressEl) progressEl.classList.remove('hidden');
                enhanceUiState.pendingResult = showResult;
                clearEnhanceResolveTimer();
                enhanceUiState.resolveTimerId = setTimeout(() => {
                    showResult();
                    syncEnhanceModal(item);
                }, 950);
            };

            const closeEnhanceModal = () => {
                const modal = document.getElementById('enhance-modal');
                if (!modal) {
                    return;
                }
                clearEnhanceResolveTimer();
                enhanceUiState.pendingResult = null;
                modal.classList.add('hidden');
                modal.classList.remove('flex');
                modal.dataset.itemId = '';
                const infoEl = document.getElementById('enhance-modal-info');
                const progressEl = document.getElementById('enhance-modal-progress');
                const resultEl = document.getElementById('enhance-modal-result');
                if (infoEl) infoEl.classList.remove('hidden');
                if (progressEl) progressEl.classList.add('hidden');
                if (resultEl) resultEl.classList.add('hidden');
            };

            const formatItemDisplayName = (item) => {
                if (!item) {
                    return 'ãªã—';
                }
                normalizeInventoryItem(item);
                const level = Math.max(0, Math.floor(Number(item.enhanceLevel) || 0));
                const suffix = level > 0
                    ? ` <span class="enhance-label ${getEnhanceLevelClass(level, false)}">+${level}</span>`
                    : '';
                const brokenText = item.isBroken ? ' <span class="text-rose-600 font-black">(ç ´æ)</span>' : '';
                return `${item.name}${suffix}${brokenText}`;
            };

            const summarizeItemStats = (item) => {
                if (!item) {
                    return 'ãªã—';
                }
                const summary = (item.finalStats || []).slice(0, 3).map((stat) => `${stat.key}+${stat.value}`).join(' / ');
                return summary || 'è£œæ­£ãªã—';
            };

            const closeEquipSlotModal = () => {
                const modal = document.getElementById('equip-slot-modal');
                if (!modal) {
                    return;
                }
                modal.classList.add('hidden');
                modal.classList.remove('flex');
                equipmentUiState.pendingEquipItemId = null;
                equipmentUiState.pendingEquipSlotKey = null;
            };

            const closeCompareModal = () => {
                const modal = document.getElementById('compare-modal');
                if (!modal) {
                    return;
                }
                modal.classList.add('hidden');
                modal.classList.remove('flex');
                equipmentUiState.pendingEquipSlotKey = null;
            };

            const openCompareModal = ({ candidateItem, slotKey }) => {
                const modal = document.getElementById('compare-modal');
                if (!modal || !candidateItem) {
                    return;
                }
                const resolvedSlotKey = slotKey || candidateItem.slot;
                const equippedItem = equipmentState.equipped[resolvedSlotKey] || null;
                const equippedName = document.getElementById('compare-modal-equipped');
                const candidateName = document.getElementById('compare-modal-candidate');
                if (equippedName) equippedName.innerHTML = equippedItem ? formatItemDisplayName(equippedItem) : 'ãªã—';
                if (candidateName) candidateName.innerHTML = formatItemDisplayName(candidateItem);

                const equippedMap = {};
                (equippedItem?.finalStats || []).forEach((stat) => {
                    equippedMap[stat.key] = (equippedMap[stat.key] || 0) + stat.value;
                });
                const candidateMap = {};
                (candidateItem.finalStats || []).forEach((stat) => {
                    candidateMap[stat.key] = (candidateMap[stat.key] || 0) + stat.value;
                });

                const increase = [];
                const decrease = [];
                const keys = new Set([...Object.keys(equippedMap), ...Object.keys(candidateMap)]);
                keys.forEach((key) => {
                    const diff = Math.floor((candidateMap[key] || 0) - (equippedMap[key] || 0));
                    if (diff > 0) increase.push(`${key} +${diff}`);
                    if (diff < 0) decrease.push(`${key} ${diff}`);
                });

                const incEl = document.getElementById('compare-modal-increase');
                const decEl = document.getElementById('compare-modal-decrease');
                if (incEl) incEl.innerHTML = increase.length ? increase.map((line) => `<div class="text-[10px] text-emerald-600 font-bold">${line}</div>`).join('') : '<div class="text-[10px] text-slate-400">ãªã—</div>';
                if (decEl) decEl.innerHTML = decrease.length ? decrease.map((line) => `<div class="text-[10px] text-rose-600 font-bold">${line}</div>`).join('') : '<div class="text-[10px] text-slate-400">ãªã—</div>';

                equipmentUiState.pendingEquipItemId = candidateItem.instanceId;
                equipmentUiState.pendingEquipSlotKey = resolvedSlotKey;
                modal.classList.remove('hidden');
                modal.classList.add('flex');
            };

            const openEquipSlotModalForItem = (instanceId) => {
                const item = equipmentState.inventoryItems.find((entry) => entry.instanceId === instanceId);
                const modal = document.getElementById('equip-slot-modal');
                if (!item || !modal) {
                    return;
                }
                equipmentUiState.pendingEquipItemId = instanceId;
                equipmentUiState.pendingEquipSlotKey = null;
                const title = document.getElementById('equip-slot-title');
                if (title) title.innerText = `${item.name} ã‚’è£…å‚™`;

                const slot1Label = document.getElementById('equip-slot-1-label');
                const slot2Label = document.getElementById('equip-slot-2-label');
                const slot1Button = document.getElementById('equip-slot-1');
                const slot2Button = document.getElementById('equip-slot-2');
                const slot2Card = slot2Label ? slot2Label.closest('.rounded-2xl') : null;

                if (item.slot === EQUIP_SLOT.accessory) {
                    if (slot2Card) slot2Card.classList.remove('hidden');
                    if (slot1Label) slot1Label.innerHTML = `è£…é£¾å“1: ${equipmentState.equipped.accessory1 ? formatItemDisplayName(equipmentState.equipped.accessory1) : 'ãªã—'}`;
                    if (slot2Label) slot2Label.innerHTML = `è£…é£¾å“2: ${equipmentState.equipped.accessory2 ? formatItemDisplayName(equipmentState.equipped.accessory2) : 'ãªã—'}`;
                    if (slot1Button) slot1Button.dataset.slotKey = 'accessory1';
                    if (slot2Button) slot2Button.dataset.slotKey = 'accessory2';
                } else {
                    if (slot2Card) slot2Card.classList.add('hidden');
                    const equipped = equipmentState.equipped[item.slot];
                    if (slot1Label) slot1Label.innerHTML = `${getSlotLabel(item.slot)}: ${equipped ? formatItemDisplayName(equipped) : 'ãªã—'}`;
                    if (slot1Button) slot1Button.dataset.slotKey = item.slot;
                    if (slot2Button) slot2Button.dataset.slotKey = '';
                }

                modal.classList.remove('hidden');
                modal.classList.add('flex');
            };

            const equipItemById = (instanceId, slotOverride = null) => {
                const targetItem = equipmentState.inventoryItems.find((item) => item.instanceId === instanceId);
                if (!targetItem) {
                    return;
                }
                if (targetItem.slot === EQUIP_SLOT.accessory) {
                    if (slotOverride === 'accessory1' || slotOverride === 'accessory2') {
                        equipmentState.equipped[slotOverride] = targetItem;
                    } else if (!equipmentState.equipped.accessory1) {
                        equipmentState.equipped.accessory1 = targetItem;
                    } else if (!equipmentState.equipped.accessory2) {
                        equipmentState.equipped.accessory2 = targetItem;
                    } else {
                        equipmentState.equipped.accessory1 = targetItem;
                    }
                } else {
                    equipmentState.equipped[targetItem.slot] = targetItem;
                }
                renderDerivedSecondaryStats({ primaryStats: playerProgressState.primaryStats, bonusStats: getEquippedBonusStats() });
                renderStatusSummary();
                renderBattleBars();
                renderEquipmentSummary();
                renderInventory();
                persistBattleState();
            };

            const renderEquipmentSummary = () => {
                const map = [
                    ['equip-weapon', 'weapon-val', equipmentState.equipped.weapon],
                    ['equip-armor', 'armor-val', equipmentState.equipped.armor],
                    ['equip-head', 'head-val', equipmentState.equipped.head],
                    ['equip-hands', 'hands-val', equipmentState.equipped.hands],
                    ['equip-feet', 'feet-val', equipmentState.equipped.feet],
                    ['equip-accessory1', 'accessory1-val', equipmentState.equipped.accessory1],
                    ['equip-accessory2', 'accessory2-val', equipmentState.equipped.accessory2]
                ];
                map.forEach(([nameId, valueId, item]) => {
                    const nameEl = document.getElementById(nameId);
                    const valueEl = document.getElementById(valueId);
                    if (nameEl) {
                        nameEl.innerHTML = item ? formatItemDisplayName(item) : 'ãªã—';
                    }
                    if (valueEl) {
                        valueEl.innerText = item ? summarizeItemStats(item) : '';
                    }
                });
            };

            const renderInventory = () => {
                const list = document.getElementById('inventory-list');
                const countEl = document.getElementById('inv-count');
                if (countEl) {
                    countEl.innerText = String(equipmentState.inventoryItems.length);
                }
                if (!list) {
                    return;
                }
                const filter = equipmentState.filter;
                const filtered = equipmentState.inventoryItems.filter((item) => filter === 'all' || item.slot === filter);
                const ordered = equipmentState.sortOrder === 'newest' ? [...filtered].reverse() : [...filtered];
                list.innerHTML = '';
                if (!ordered.length) {
                    const empty = document.createElement('div');
                    empty.className = 'bg-white rounded-xl border p-3 text-xs text-slate-400 font-bold';
                    empty.textContent = 'è£…å‚™ã¯ã¾ã ã‚ã‚Šã¾ã›ã‚“ã€‚';
                    list.appendChild(empty);
                    return;
                }
                ordered.forEach((item) => {
                    const row = document.createElement('div');
                    row.className = 'bg-white rounded-xl border p-3 shadow-sm';
                    const affixText = item.affixes.length ? item.affixes.map((affix) => `${affix.label}+${affix.value}`).join(' / ') : 'Affixãªã—';
                    const uniqueStat = item.finalStats[1] ? `${item.finalStats[1].key}+${item.finalStats[1].value}` : 'ãªã—';
                    const equippedSlotKey = getEquippedSlotKeyByItemId(item.instanceId);
                    const isEquipped = Boolean(equippedSlotKey);
                    const isFavorite = item.isFavorite === true;
                    const namePrefix = `${isEquipped ? '<span class="text-emerald-600">[E]</span>' : ''}${isFavorite ? '<span class="text-amber-400">â˜†</span>' : ''}`;
                    const equipButtonClass = isEquipped
                        ? 'equip-btn px-2 py-1 rounded-lg bg-rose-600 text-white text-[10px] font-black flex items-center justify-center gap-1'
                        : 'equip-btn px-2 py-1 rounded-lg bg-slate-800 text-white text-[10px] font-black flex items-center justify-center gap-1';
                    const sellDisabled = isEquipped || isFavorite;
                    const sellText = isEquipped ? 'è£…å‚™ä¸­' : (isFavorite ? 'ä¿è­·ä¸­' : `å£²å´ ${getSellPrice(item)}G`);
                    const enhanceCost = getEnhanceCost(item);
                    const canEnhance = playerProgressState.gold >= enhanceCost;
                    const enhanceText = item.isBroken ? 'ä¿®ç†' : 'å¼·åŒ–';
                    row.innerHTML = `
                        <div class="flex items-start justify-between gap-2">
                            <div class="min-w-0 flex-1">
                                <div class="text-[11px] font-black rarity-${item.rarity}"><i class="fas ${item.iconClass}"></i> ${namePrefix}${formatItemDisplayName(item)}</div>
                                <div class="text-[10px] text-slate-500 font-bold mt-1">${getSlotLabel(item.slot)} / ${item.mainSummary}</div>
                                <div class="text-[9px] text-slate-400 mt-1">å›ºæœ‰: ${uniqueStat}</div>
                                <div class="text-[9px] text-slate-400 mt-1">${affixText}</div>
                            </div>
                            <div class="w-[96px] grid grid-cols-1 gap-1">
                                <button class="${equipButtonClass}" data-item-id="${item.instanceId}"><i class="fas ${isEquipped ? 'fa-link-slash' : 'fa-shield'}"></i>${isEquipped ? 'ã¯ãšã™' : 'è£…å‚™'}</button>
                                <button class="sell-btn px-2 py-1 rounded-lg border text-[10px] font-black flex items-center justify-center gap-1 ${sellDisabled ? 'bg-slate-100 text-slate-400 border-slate-200 cursor-not-allowed' : 'bg-amber-50 text-amber-700 border-amber-300'}" data-item-id="${item.instanceId}" ${sellDisabled ? 'disabled' : ''}><i class="fas fa-coins"></i>${sellText}</button>
                                <button class="favorite-btn px-2 py-1 rounded-lg border text-[10px] font-black flex items-center justify-center gap-1 ${isFavorite ? 'bg-amber-100 text-amber-700 border-amber-300' : 'bg-white text-slate-600 border-slate-200'}" data-item-id="${item.instanceId}"><i class="fas ${isFavorite ? 'fa-star' : 'fa-star-half-stroke'}"></i>${isFavorite ? 'ãŠæ°—ã«å…¥ã‚Šè§£é™¤' : 'ãŠæ°—ã«å…¥ã‚Š'}</button>
                                <button class="enhance-btn px-2 py-1 rounded-lg border text-[10px] font-black flex items-center justify-center gap-1 ${canEnhance ? (item.isBroken ? 'bg-emerald-50 text-emerald-700 border-emerald-300' : 'bg-indigo-50 text-indigo-700 border-indigo-300') : 'bg-slate-100 text-slate-400 border-slate-200 cursor-not-allowed'}" data-item-id="${item.instanceId}" ${canEnhance ? '' : 'disabled'}><i class="fas ${item.isBroken ? 'fa-screwdriver-wrench' : 'fa-hammer'}"></i>${enhanceText}</button>
                                <button class="compare-btn px-2 py-1 rounded-lg border text-[10px] font-black bg-white text-slate-600 border-slate-200 flex items-center justify-center gap-1" data-item-id="${item.instanceId}"><i class="fas fa-scale-balanced"></i>æ¯”è¼ƒ</button>
                            </div>
                        </div>`;
                    list.appendChild(row);
                });

                list.querySelectorAll('.equip-btn').forEach((button) => {
                    button.addEventListener('click', (event) => {
                        event.preventDefault();
                        const itemId = button.dataset.itemId;
                        const item = equipmentState.inventoryItems.find((entry) => entry.instanceId === itemId);
                        if (!item) {
                            return;
                        }
                        if (isItemEquipped(itemId)) {
                            unequipItemById(itemId);
                            return;
                        }
                        if (item.slot === EQUIP_SLOT.accessory) {
                            openEquipSlotModalForItem(itemId);
                            return;
                        }
                        equipItemById(itemId, item.slot);
                    });
                });

                list.querySelectorAll('.sell-btn').forEach((button) => {
                    button.addEventListener('click', (event) => {
                        event.preventDefault();
                        sellItemById(button.dataset.itemId);
                    });
                });

                list.querySelectorAll('.favorite-btn').forEach((button) => {
                    button.addEventListener('click', (event) => {
                        event.preventDefault();
                        toggleItemFavorite(button.dataset.itemId);
                    });
                });

                list.querySelectorAll('.enhance-btn').forEach((button) => {
                    button.addEventListener('click', (event) => {
                        event.preventDefault();
                        openEnhanceModal(button.dataset.itemId);
                    });
                });

                list.querySelectorAll('.compare-btn').forEach((button) => {
                    button.addEventListener('click', (event) => {
                        event.preventDefault();
                        const item = equipmentState.inventoryItems.find((entry) => entry.instanceId === button.dataset.itemId);
                        if (!item) {
                            return;
                        }
                        openCompareModal({ candidateItem: item, slotKey: getCompareTargetSlotKey(item) });
                    });
                });
            };

            const setInventoryFilter = (filter) => {
                equipmentState.filter = filter;
                document.querySelectorAll('.inv-filter-btn').forEach((btn) => {
                    btn.classList.toggle('bg-slate-800', btn.dataset.invFilter === filter);
                    btn.classList.toggle('text-white', btn.dataset.invFilter === filter);
                });
                renderInventory();
            };

            const toggleInventorySort = () => {
                equipmentState.sortOrder = equipmentState.sortOrder === 'newest' ? 'oldest' : 'newest';
                const sortLabel = document.getElementById('inv-sort-label');
                if (sortLabel) {
                    sortLabel.innerText = equipmentState.sortOrder === 'newest' ? 'å…¥æ‰‹é †' : 'å¤ã„é †';
                }
                renderInventory();
            };

            const pushMiniLog = (message) => {
                battleState.miniLogs.unshift(message);
                battleState.miniLogs = battleState.miniLogs.slice(0, 10);
                for (let i = 0; i < 10; i += 1) {
                    const line = document.getElementById(`mini-log-${i}`);
                    if (line) {
                        line.innerText = battleState.miniLogs[i] || '';
                    }
                }
            };

            const showBattlePopup = ({
                kind = 'physical',
                value = '',
                target = 'enemy',
                offsetX = null,
                offsetY = null
            } = {}) => {
                const layer = document.getElementById('damage-layer');
                if (!layer) {
                    return;
                }

                const styleDef = BATTLE_POPUP_STYLE[kind] || BATTLE_POPUP_STYLE.physical;
                const textEl = document.createElement('div');
                textEl.className = 'damage-text';
                textEl.style.color = styleDef.color;
                const baseX = 50;
                const baseY = target === 'player' ? 78 : 34;
                const randomX = Number.isFinite(offsetX) ? offsetX : (Math.random() * 56) - 28;
                const randomY = Number.isFinite(offsetY) ? offsetY : (Math.random() * 20) - 10;

                textEl.style.left = `${baseX}%`;
                textEl.style.top = `${baseY}%`;
                textEl.style.setProperty('--offset-x', `${randomX}px`);
                textEl.style.setProperty('--offset-y', `${randomY}px`);

                const amountText = styleDef.text || `${styleDef.prefix || ''}${value}`;
                if (styleDef.label) {
                    const labelEl = document.createElement('span');
                    labelEl.className = 'damage-text-popup-label';
                    labelEl.innerText = styleDef.label;
                    textEl.appendChild(labelEl);
                }
                textEl.appendChild(document.createTextNode(amountText));

                layer.appendChild(textEl);
                textEl.addEventListener('animationend', () => {
                    textEl.remove();
                }, { once: true });
            };

            const renderBattleBars = () => {
                const player = getPlayerCombatant();
                const playerMaxHp = Math.max(1, Math.floor(player.secondaryStats.MaxHP));
                const currentEnemy = battleState.currentEnemy;
                const enemyMaxHp = Math.max(1, Math.floor((currentEnemy && currentEnemy.stats && currentEnemy.stats.maxHp) || 1));

                const playerHpText = document.getElementById('player-hp-text');
                if (playerHpText) {
                    playerHpText.innerText = `${battleState.playerHp}/${playerMaxHp}`;
                }
                const playerHpBar = document.getElementById('player-hp-bar');
                if (playerHpBar) {
                    playerHpBar.style.width = `${Math.max(0, Math.min(100, (battleState.playerHp / playerMaxHp) * 100))}%`;
                }

                const playerMaxMp = Math.max(0, Math.floor(player.secondaryStats.MaxCP));
                const playerCpText = document.getElementById('player-cp-text');
                if (playerCpText) {
                    playerCpText.innerText = `${battleState.playerCp}/${playerMaxMp}`;
                }
                const playerCpBar = document.getElementById('player-cp-bar');
                if (playerCpBar) {
                    const ratio = playerMaxMp > 0 ? (battleState.playerCp / playerMaxMp) * 100 : 0;
                    const clampedRatio = Math.max(0, Math.min(100, ratio));
                    playerCpBar.style.width = `${clampedRatio}%`;
                    const lightness = 72 + (clampedRatio * 0.24);
                    playerCpBar.style.backgroundColor = `hsl(210 20% ${lightness}%)`;
                }

                const enemyHpText = document.getElementById('enemy-hp-text');
                if (enemyHpText) {
                    enemyHpText.innerText = `${battleState.enemyHp}/${enemyMaxHp}`;
                }
                const enemyHpBar = document.getElementById('enemy-hp-bar');
                if (enemyHpBar) {
                    enemyHpBar.style.width = `${Math.max(0, Math.min(100, (battleState.enemyHp / enemyMaxHp) * 100))}%`;
                }

                const enemyName = document.getElementById('enemy-name');
                if (enemyName) {
                    enemyName.innerText = currentEnemy.name;
                }
                const enemyCycleLabel = document.getElementById('enemy-cycle-label');
                if (enemyCycleLabel) {
                    enemyCycleLabel.innerText = currentEnemy
                        ? `Floor ${battleState.currentFloor} å‡ºç¾å€™è£œ ${currentEnemy.enemyPoolIndex + 1} / ${currentEnemy.enemyPoolSize}`
                        : `Floor ${battleState.currentFloor} å‡ºç¾å€™è£œ - / 3`;
                }

                const headerFloor = document.getElementById('header-floor');
                if (headerFloor) {
                    headerFloor.innerText = String(battleState.currentFloor);
                }

                const enemyVisual = document.getElementById('enemy-visual');
                if (enemyVisual) {
                    enemyVisual.className = `text-8xl mb-4 ${currentEnemy.iconColorClass}`;
                    enemyVisual.innerHTML = `<i class="fas ${currentEnemy.iconClass}"></i>`;
                }
            };

            const createAttackDefinitionFromAi = (defaultAttack) => ({
                guaranteedHits: 1,
                skillBonusHitCap: 0,
                bonusHitChanceTable: [],
                bonusHitDamageScaleTable: [],
                damageType: normalizeDamageType(defaultAttack.damageKind)
            });

            const resolveEnemyAffixKeyForEncounter = (rng = Math.random) => {
                const player = getPlayerCombatant();
                const eliteRatePercent = Math.max(0, Number(player.secondaryStats[SecondaryStatKey.EliteEncounterRate] || 0));
                const eliteChance = Math.min(1, eliteRatePercent / 100);
                return rng() < eliteChance ? 'elite' : 'normal';
            };

            const advanceEnemy = () => {
                if (battleState.currentFloor < MAX_IMPLEMENTED_FLOOR) {
                    battleState.currentFloor += 1;
                }
                const affixKey = resolveEnemyAffixKeyForEncounter();
                battleState.currentEnemy = buildEnemyForFloor({ floor: battleState.currentFloor, affixKey });
                battleState.enemyHp = battleState.currentEnemy.stats.maxHp;
                const affixLabel = affixKey === 'elite' ? ' [Elite]' : '';
                pushMiniLog(`æ¬¡ã®æ•µ: ${battleState.currentEnemy.name}${affixLabel} (Floor ${battleState.currentFloor})`);
                persistBattleState();
                renderBattleBars();
            };

            const showDeathOverlay = ({ lostExp }) => {
                const overlay = document.getElementById('death-overlay');
                const lostExpEl = document.getElementById('lost-exp-val');
                if (lostExpEl) {
                    lostExpEl.innerText = String(lostExp);
                }
                if (overlay) {
                    overlay.classList.remove('hidden');
                    overlay.classList.add('flex');
                }
            };

            const closeDeathOverlay = () => {
                const overlay = document.getElementById('death-overlay');
                if (!overlay) {
                    return;
                }
                overlay.classList.add('hidden');
                overlay.classList.remove('flex');
            };

            const applyDefeatPenalty = () => {
                const lostExp = Math.floor(playerProgressState.exp * DEATH_EXP_LOSS_RATE);
                playerProgressState.exp = Math.max(0, playerProgressState.exp - lostExp);
                battleState.currentFloor = clampFloor(battleState.currentFloor - DEATH_FLOOR_PENALTY);
                battleState.playerCp = 0;
                const affixKey = resolveEnemyAffixKeyForEncounter();
                battleState.currentEnemy = buildEnemyForFloor({ floor: battleState.currentFloor, affixKey });
                battleState.enemyHp = battleState.currentEnemy.stats.maxHp;
                renderStatusSummary();
                return { lostExp };
            };

            const retryBattle = () => {
                const player = getPlayerCombatant();
                battleState.playerHp = Math.max(1, Math.floor(player.secondaryStats.MaxHP));
                renderBattleBars();
                renderAutoSkillDisplays();
                persistBattleState();
            };

            const handlePlayerDefeat = () => {
                const penaltyResult = applyDefeatPenalty();
                pushMiniLog(`ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼æ•—åŒ— â†’ Floor ${battleState.currentFloor} ã¸æ’¤é€€ / EXP-${penaltyResult.lostExp}`);
                showDeathOverlay({ lostExp: penaltyResult.lostExp });
                retryBattle();
            };

            const performEnemyTurn = () => {
                const enemy = battleState.currentEnemy;
                const enemyCombatant = toEnemyCombatant(enemy);
                const playerCombatant = getPlayerCombatant();
                const attackDefinition = createAttackDefinitionFromAi(enemy.ai.defaultAttack);
                const hitResults = resolveHitResults({
                    attackDefinition,
                    attackerPrimaryStats: enemyCombatant.primaryStats,
                    defenderPrimaryStats: playerCombatant.primaryStats,
                    attackerSecondaryStats: enemyCombatant.secondaryStats,
                    defenderSecondaryStats: playerCombatant.secondaryStats,
                    attackerSide: CombatActorSide.Enemy,
                    rollCritical: () => false
                });

                hitResults.forEach((hit, index) => {
                    if (!hit.isHit) {
                        showBattlePopup({ kind: 'miss', target: 'player' });
                        pushMiniLog(`æ•µæ”»æ’ƒ${index + 1}: ç‰©ç† MISS (å‘½ä¸­ç‡ ${hit.hitChancePercent.toFixed(2)}%)`);
                        return;
                    }

                    const damage = calcPhysicalDamageOnHit({
                        attackerSecondaryStats: enemyCombatant.secondaryStats,
                        defenderSecondaryStats: playerCombatant.secondaryStats,
                        skillPowerMultiplier: enemy.ai.defaultAttack.skillPower,
                        totalBonusDamagePercent: enemyCombatant.secondaryStats.BonusDamagePercent,
                        critTier: CritTier.None
                    });
                    battleState.playerHp = Math.max(0, battleState.playerHp - damage.finalDamage);
                    showBattlePopup({ kind: 'physical', value: damage.finalDamage, target: 'player' });
                    const guardRatio = damage.attackPart > 0 ? (damage.reducedDamage / damage.attackPart) : 1;
                    if (guardRatio <= GUARD_POPUP_THRESHOLD) {
                        showBattlePopup({ kind: 'guard', target: 'player', offsetY: 14 });
                    }
                    pushMiniLog(
                        `æ•µæ”»æ’ƒ${index + 1}: ç‰©ç† HIT ${damage.finalDamage} (å‘½ä¸­ç‡ ${hit.hitChancePercent.toFixed(2)}% / è»½æ¸›å‰ ${damage.attackPart.toFixed(2)} â†’ è»½æ¸›å¾Œ ${damage.reducedDamage.toFixed(2)})`
                    );
                });

                if (battleState.playerHp <= 0) {
                    handlePlayerDefeat();
                    return;
                }

                renderBattleBars();
            };

            const SKILL_LIBRARY = Object.freeze({
                auto_basic_attack_physical: {
                    id: 'auto_basic_attack_physical',
                    name: 'é€šå¸¸æ”»æ’ƒ(ç‰©ç†)',
                    damageType: 'Physical',
                    skillPower: 1.0,
                    cpCost: 0,
                    cpGainOnHit: 12,
                    cooldownTurns: 0
                },
                auto_basic_attack_magical: {
                    id: 'auto_basic_attack_magical',
                    name: 'é€šå¸¸æ”»æ’ƒ(é­”æ³•)',
                    damageType: 'Magical',
                    skillPower: 1.0,
                    cpCost: 0,
                    cpGainOnHit: 12,
                    cooldownTurns: 0
                }
            });

            const AUTO_SLOT1_ALLOWED_SKILL_IDS = Object.freeze([
                'auto_basic_attack_physical',
                'auto_basic_attack_magical'
            ]);

            const autoSlotState = {
                auto1: {
                    skillId: 'auto_basic_attack_physical',
                    remainingCooldown: 0
                },
                auto2: {
                    skillId: null,
                    remainingCooldown: 0
                }
            };

            const AUTO_SLOT_ORDER = Object.freeze(['auto2', 'auto1']);

            const BATTLE_RUNTIME_STATE_KEY = 'battle_runtime_state_v2';
            const LEGACY_BATTLE_RUNTIME_STATE_KEYS = Object.freeze([
                'battle_runtime_state_v1',
                'battle_runtime_state'
            ]);

            const parsePersistedBattleState = (raw) => {
                if (!raw) {
                    return null;
                }
                const parsed = JSON.parse(raw);
                if (!parsed || typeof parsed !== 'object') {
                    return null;
                }
                const loadedFloor = clampFloor(parsed.currentFloor);
                const loadedCp = Number.isFinite(parsed.playerCp) ? Math.max(0, Math.floor(parsed.playerCp)) : 0;
                const loadedEnemy = parsed.currentEnemy && parsed.currentEnemy.stats
                    ? {
                        ...parsed.currentEnemy,
                        floor: clampFloor(parsed.currentEnemy.floor || loadedFloor),
                        tier: toTierFromFloor(parsed.currentEnemy.floor || loadedFloor),
                        enemyPoolIndex: Number.isFinite(parsed.currentEnemy.enemyPoolIndex) ? Math.max(0, Math.floor(parsed.currentEnemy.enemyPoolIndex)) : 0,
                        enemyPoolSize: Number.isFinite(parsed.currentEnemy.enemyPoolSize) ? Math.max(1, Math.floor(parsed.currentEnemy.enemyPoolSize)) : 3
                    }
                    : null;
                const loadedEquipmentState = parsed.equipmentState && typeof parsed.equipmentState === 'object' ? parsed.equipmentState : null;
                return {
                    currentFloor: loadedFloor,
                    playerCp: loadedCp,
                    currentEnemy: loadedEnemy,
                    equipmentState: loadedEquipmentState
                };
            };

            const persistBattleState = () => {
                try {
                    localStorage.setItem(BATTLE_RUNTIME_STATE_KEY, JSON.stringify({
                        currentFloor: battleState.currentFloor,
                        playerCp: battleState.playerCp,
                        currentEnemy: battleState.currentEnemy,
                        equipmentState
                    }));
                } catch (e) {
                    // noop
                }
            };

            const loadPersistedBattleState = () => {
                try {
                    const latestRaw = localStorage.getItem(BATTLE_RUNTIME_STATE_KEY);
                    const latestParsed = parsePersistedBattleState(latestRaw);
                    if (latestParsed) {
                        return latestParsed;
                    }

                    for (const legacyKey of LEGACY_BATTLE_RUNTIME_STATE_KEYS) {
                        const legacyParsed = parsePersistedBattleState(localStorage.getItem(legacyKey));
                        if (!legacyParsed) {
                            continue;
                        }
                        localStorage.setItem(BATTLE_RUNTIME_STATE_KEY, JSON.stringify(legacyParsed));
                        return legacyParsed;
                    }

                    return null;
                } catch (e) {
                    return null;
                }
            };

            const getSkillById = (skillId) => (skillId ? SKILL_LIBRARY[skillId] || null : null);

            const setAutoSlot1NormalAttackSkill = (skillId) => {
                if (!AUTO_SLOT1_ALLOWED_SKILL_IDS.includes(skillId)) {
                    return false;
                }
                autoSlotState.auto1.skillId = skillId;
                autoSlotState.auto1.remainingCooldown = 0;
                return true;
            };

            const renderAutoSkillDisplays = () => {
                const auto2El = document.getElementById('auto-slot-2-display');
                const auto1El = document.getElementById('auto-slot-1-display');

                const auto2Skill = getSkillById(autoSlotState.auto2.skillId);
                const auto1Skill = getSkillById(autoSlotState.auto1.skillId);

                if (auto2El) {
                    if (!auto2Skill) {
                        auto2El.innerText = 'è‡ªå‹•ã‚¹ãƒ­ãƒƒãƒˆ2: ç©º';
                    } else {
                        auto2El.innerText = `è‡ªå‹•ã‚¹ãƒ­ãƒƒãƒˆ2: ${auto2Skill.name} (æ¶ˆè²»CP ${auto2Skill.cpCost} / ç²å¾—CP ${auto2Skill.cpGainOnHit} / CT ${autoSlotState.auto2.remainingCooldown})`;
                    }
                }

                if (auto1El) {
                    if (!auto1Skill) {
                        auto1El.innerText = 'è‡ªå‹•ã‚¹ãƒ­ãƒƒãƒˆ1: ç©º';
                    } else {
                        auto1El.innerText = `è‡ªå‹•ã‚¹ãƒ­ãƒƒãƒˆ1: ${auto1Skill.name} (æ¶ˆè²»CP ${auto1Skill.cpCost} / ç²å¾—CP ${auto1Skill.cpGainOnHit} / CT ${autoSlotState.auto1.remainingCooldown})`;
                    }
                }
            };

            const reduceAutoSkillCooldownAtTurnStart = () => {
                AUTO_SLOT_ORDER.forEach((slotKey) => {
                    const slot = autoSlotState[slotKey];
                    slot.remainingCooldown = Math.max(0, slot.remainingCooldown - 1);
                });
            };

            const resolveSkillAttackDefinition = (damageType) => ({
                guaranteedHits: 1,
                skillBonusHitCap: 0,
                bonusHitChanceTable: [],
                bonusHitDamageScaleTable: [],
                damageType
            });

            const executePlayerSkill = ({ skill, sourceLabel, slotKey }) => {
                const enemy = battleState.currentEnemy;
                const enemyCombatant = toEnemyCombatant(enemy);
                const playerCombatant = getPlayerCombatant();
                const attackDefinition = resolveSkillAttackDefinition(skill.damageType);
                const hitResults = resolveHitResults({
                    attackDefinition,
                    attackerPrimaryStats: playerCombatant.primaryStats,
                    defenderPrimaryStats: enemyCombatant.primaryStats,
                    attackerSecondaryStats: playerCombatant.secondaryStats,
                    defenderSecondaryStats: enemyCombatant.secondaryStats,
                    attackerSide: CombatActorSide.Player
                });

                let totalCpGain = 0;
                hitResults.forEach((hit, index) => {
                    if (!hit.isHit) {
                        showBattlePopup({ kind: 'miss', target: 'enemy' });
                        pushMiniLog(`${sourceLabel}${index + 1}: ${skill.damageType === 'Magical' ? 'é­”æ³•' : 'ç‰©ç†'} MISS (å‘½ä¸­ç‡ ${hit.hitChancePercent.toFixed(2)}%)`);
                        return;
                    }

                    const damage = skill.damageType === 'Magical'
                        ? calcMagicDamage({
                            attackerSecondaryStats: playerCombatant.secondaryStats,
                            defenderSecondaryStats: enemyCombatant.secondaryStats,
                            skillPowerMultiplier: skill.skillPower,
                            totalBonusDamagePercent: playerCombatant.secondaryStats.BonusDamagePercent
                        })
                        : calcPhysicalDamageOnHit({
                            attackerSecondaryStats: playerCombatant.secondaryStats,
                            defenderSecondaryStats: enemyCombatant.secondaryStats,
                            skillPowerMultiplier: skill.skillPower,
                            totalBonusDamagePercent: playerCombatant.secondaryStats.BonusDamagePercent,
                            critTier: hit.critTier
                        });

                    battleState.enemyHp = Math.max(0, battleState.enemyHp - damage.finalDamage);
                    const popupKind = skill.damageType === 'Magical'
                        ? 'magical'
                        : (hit.critTier === CritTier.DoubleCritical
                            ? 'doubleCritical'
                            : (hit.critTier === CritTier.Critical ? 'critical' : 'physical'));
                    showBattlePopup({ kind: popupKind, value: damage.finalDamage, target: 'enemy' });
                    const guardRatio = damage.attackPart > 0 ? (damage.reducedDamage / damage.attackPart) : 1;
                    if (guardRatio <= GUARD_POPUP_THRESHOLD) {
                        showBattlePopup({ kind: 'guard', target: 'enemy', offsetY: 14 });
                    }
                    const critLabel = skill.damageType === 'Magical'
                        ? ' / éã‚¯ãƒª'
                        : (hit.critTier === CritTier.DoubleCritical
                            ? ' / ãƒ€ãƒ–ãƒ«ã‚¯ãƒª'
                            : (hit.critTier === CritTier.Critical ? ' / ã‚¯ãƒª' : ' / éã‚¯ãƒª'));
                    totalCpGain += skill.cpGainOnHit;
                    pushMiniLog(
                        `${sourceLabel}${index + 1}: ${skill.damageType === 'Magical' ? 'é­”æ³•' : 'ç‰©ç†'} HIT ${damage.finalDamage}${critLabel} (å‘½ä¸­ç‡ ${hit.hitChancePercent.toFixed(2)}% / è»½æ¸›å‰ ${damage.attackPart.toFixed(2)} â†’ è»½æ¸›å¾Œ ${damage.reducedDamage.toFixed(2)} / æ¶ˆè²»CP ${skill.cpCost} / ç²å¾—CP ${skill.cpGainOnHit})`
                    );
                });

                if (totalCpGain > 0) {
                    const playerCombatantAfterHit = getPlayerCombatant();
                    const maxCp = Math.max(0, Math.floor(playerCombatantAfterHit.secondaryStats.MaxCP));
                    battleState.playerCp = Math.min(maxCp, battleState.playerCp + totalCpGain);
                }

                if (slotKey && autoSlotState[slotKey]) {
                    autoSlotState[slotKey].remainingCooldown = Math.max(0, Math.floor(skill.cooldownTurns));
                }

                persistBattleState();
                renderBattleBars();
                renderAutoSkillDisplays();

                if (battleState.enemyHp <= 0) {
                    const killExp = getKillExp(battleState.currentFloor);
                    showBattlePopup({ kind: 'exp', value: killExp, target: 'enemy' });
                    const expResult = addExperience(killExp);
                    if (expResult.leveledUpCount > 0) {
                        showBattlePopup({ kind: 'levelUp', target: 'player' });
                    }
                    pushMiniLog(`${enemy.name} ã‚’æ’ƒç ´ / EXP +${killExp}`);
                    const dropItem = attemptEquipmentDrop({
                        floor: battleState.currentFloor,
                        playerCombatant,
                        isBoss: enemy.isBoss === true
                    });
                    if (dropItem) {
                        equipmentState.inventoryItems.push(dropItem);
                        pushDropLog(`${dropItem.name} (${dropItem.mainSummary})`, dropItem.rarity);
                        pushMiniLog(`ãƒ‰ãƒ­ãƒƒãƒ—: ${dropItem.name} (${getSlotLabel(dropItem.slot)})`);
                        renderInventory();
                    }
                    advanceEnemy();
                    return;
                }

                performEnemyTurn();
            };

            const performPlayerActionBySkillSlots = () => {
                reduceAutoSkillCooldownAtTurnStart();
                renderAutoSkillDisplays();

                for (const slotKey of AUTO_SLOT_ORDER) {
                    const slot = autoSlotState[slotKey];
                    const skill = getSkillById(slot.skillId);
                    if (!skill) {
                        continue;
                    }
                    if (slot.remainingCooldown > 0) {
                        continue;
                    }
                    if (battleState.playerCp < skill.cpCost) {
                        continue;
                    }

                    battleState.playerCp = Math.max(0, battleState.playerCp - skill.cpCost);
                    executePlayerSkill({
                        skill,
                        sourceLabel: `${slotKey === 'auto2' ? 'è‡ªå‹•2' : 'è‡ªå‹•1'} ${skill.name} `,
                        slotKey
                    });
                    return;
                }

                pushMiniLog('CPãŒè¶³ã‚Šãšè‡ªå‹•ã‚¹ã‚­ãƒ«ã‚’ç™ºå‹•ã§ããªã„ãŸã‚ã‚¿ãƒ¼ãƒ³é€²è¡Œãªã—');
                persistBattleState();
                renderBattleBars();
                renderAutoSkillDisplays();
            };

            const initializeBattleSimulation = () => {
                const persisted = loadPersistedBattleState();
                battleState.currentFloor = persisted ? persisted.currentFloor : 1;
                battleState.currentEnemy = persisted && persisted.currentEnemy
                    ? persisted.currentEnemy
                    : buildEnemyForFloor({ floor: battleState.currentFloor, affixKey: resolveEnemyAffixKeyForEncounter() });
                battleState.enemyHp = battleState.currentEnemy.stats.maxHp;
                if (persisted && persisted.equipmentState) {
                    equipmentState.inventoryItems = Array.isArray(persisted.equipmentState.inventoryItems)
                        ? persisted.equipmentState.inventoryItems.map((item) => normalizeInventoryItem(item))
                        : [];
                    equipmentState.equipped = {
                        ...equipmentState.equipped,
                        ...(persisted.equipmentState.equipped || {})
                    };
                    Object.keys(equipmentState.equipped).forEach((slotKey) => {
                        if (equipmentState.equipped[slotKey]) {
                            equipmentState.equipped[slotKey] = normalizeInventoryItem(equipmentState.equipped[slotKey]);
                        }
                    });
                    equipmentState.filter = persisted.equipmentState.filter || 'all';
                    equipmentState.sortOrder = persisted.equipmentState.sortOrder || 'newest';
                }
                battleState.playerHp = Math.max(1, Math.floor(getPlayerCombatant().secondaryStats.MaxHP));
                battleState.playerCp = persisted ? persisted.playerCp : 0;
                battleState.miniLogs = [];
                setAutoSlot1NormalAttackSkill(autoSlotState.auto1.skillId || 'auto_basic_attack_physical');
                autoSlotState.auto1.remainingCooldown = 0;
                autoSlotState.auto2.remainingCooldown = 0;
                pushMiniLog(`æˆ¦é—˜é–‹å§‹: ${battleState.currentEnemy.name} (Floor ${battleState.currentFloor})`);
                persistBattleState();
                renderDerivedSecondaryStats({ primaryStats: playerProgressState.primaryStats, bonusStats: getEquippedBonusStats() });
                renderStatusSummary();
                renderBattleBars();
                renderAutoSkillDisplays();
                renderEquipmentSummary();
                renderInventory();
                setInventoryFilter(equipmentState.filter || 'all');
            };

            const noop = (event) => {
                if (event) {
                    event.preventDefault();
                    event.stopPropagation();
                }
                return false;
            };

            const switchPage = (pageName) => {
                document.querySelectorAll('.page').forEach((page) => page.classList.remove('active'));
                const targetPage = document.getElementById(`page-${pageName}`);
                if (targetPage) {
                    targetPage.classList.add('active');
                }

                ['battle', 'status', 'skill', 'inventory', 'log'].forEach((name) => {
                    const nav = document.getElementById(`nav-${name}`);
                    if (nav) {
                        nav.classList.toggle('active', name === pageName);
                    }
                });
            };

            const openStatusBreakdownModal = () => {
                const modal = document.getElementById('status-breakdown-modal');
                if (!modal) {
                    return;
                }
                modal.classList.remove('hidden');
                modal.classList.add('flex');
            };

            const closeStatusBreakdownModal = () => {
                const modal = document.getElementById('status-breakdown-modal');
                if (!modal) {
                    return;
                }
                modal.classList.add('hidden');
                modal.classList.remove('flex');
            };

            const openStatusInfoModal = () => {
                const modal = document.getElementById('status-info-modal');
                if (!modal) {
                    return;
                }
                modal.classList.remove('hidden');
                modal.classList.add('flex');
            };

            const closeStatusInfoModal = () => {
                const modal = document.getElementById('status-info-modal');
                if (!modal) {
                    return;
                }
                modal.classList.add('hidden');
                modal.classList.remove('flex');
            };

            const bottomMenuPanel = document.getElementById('bottom-menu-panel');
            const bottomMenuBackdrop = document.getElementById('bottom-menu-backdrop');
            const navHelpButton = document.getElementById('nav-help');

            const closeBottomMenu = () => {
                if (bottomMenuPanel) {
                    bottomMenuPanel.classList.add('hidden');
                }
                if (bottomMenuBackdrop) {
                    bottomMenuBackdrop.classList.add('hidden');
                }
                if (navHelpButton) {
                    navHelpButton.setAttribute('aria-expanded', 'false');
                }
            };

            const toggleBottomMenu = () => {
                if (!bottomMenuPanel || !bottomMenuBackdrop) {
                    return;
                }
                const isClosed = bottomMenuPanel.classList.contains('hidden');
                if (isClosed) {
                    bottomMenuPanel.classList.remove('hidden');
                    bottomMenuBackdrop.classList.remove('hidden');
                    if (navHelpButton) {
                        navHelpButton.setAttribute('aria-expanded', 'true');
                    }
                    return;
                }
                closeBottomMenu();
            };

            window.switchPage = switchPage;
            window.toggleBottomMenu = toggleBottomMenu;
            window.closeBottomMenu = closeBottomMenu;
            window.openBottomMenuHelp = () => {
                closeBottomMenu();
                switchPage('help');
            };
            window.openBottomMenuSave = () => {
                closeBottomMenu();
                switchPage('save');
            };
            window.openBottomMenuDonate = () => {
                closeBottomMenu();
            };
            window.openBottomMenuTweet = (event) => {
                noop(event);
                closeBottomMenu();
            };
            window.openBottomMenuFeedback = () => {
                closeBottomMenu();
                switchPage('feedback');
            };
            window.revive = () => {
                closeDeathOverlay();
            };
            window.setInventoryFilter = setInventoryFilter;
            window.toggleInventorySort = toggleInventorySort;
            window.openDonateModal = noop;
            window.closeDonateModal = noop;
            window.purchaseTip = noop;
            window.openXShare = noop;

            document.addEventListener('DOMContentLoaded', () => {
                setDashValues();
                runSecondaryStatSelfTests();
                renderDerivedSecondaryStats({ primaryStats: playerProgressState.primaryStats, bonusStats: getEquippedBonusStats() });
                renderStatusSummary();
                initializeBattleSimulation();
                closeDeathOverlay();
                switchPage('battle');

                const secondaryBreakdownBtn = document.getElementById('secondary-breakdown-btn');
                if (secondaryBreakdownBtn) {
                    secondaryBreakdownBtn.addEventListener('click', (event) => {
                        event.preventDefault();
                        openStatusBreakdownModal();
                    });
                }

                const secondaryInfoBtn = document.getElementById('secondary-info-btn');
                if (secondaryInfoBtn) {
                    secondaryInfoBtn.addEventListener('click', (event) => {
                        event.preventDefault();
                        openStatusInfoModal();
                    });
                }

                ['status-breakdown-close', 'status-breakdown-close-bottom'].forEach((id) => {
                    const closeButton = document.getElementById(id);
                    if (closeButton) {
                        closeButton.addEventListener('click', (event) => {
                            event.preventDefault();
                            closeStatusBreakdownModal();
                        });
                    }
                });

                const statusBreakdownModal = document.getElementById('status-breakdown-modal');
                if (statusBreakdownModal) {
                    statusBreakdownModal.addEventListener('click', (event) => {
                        if (event.target === statusBreakdownModal) {
                            closeStatusBreakdownModal();
                        }
                    });
                }

                ['status-info-close', 'status-info-close-bottom'].forEach((id) => {
                    const closeButton = document.getElementById(id);
                    if (closeButton) {
                        closeButton.addEventListener('click', (event) => {
                            event.preventDefault();
                            closeStatusInfoModal();
                        });
                    }
                });

                const statusInfoModal = document.getElementById('status-info-modal');
                if (statusInfoModal) {
                    statusInfoModal.addEventListener('click', (event) => {
                        if (event.target === statusInfoModal) {
                            closeStatusInfoModal();
                        }
                    });
                }

                document.querySelectorAll('.stat-adjust-btn').forEach((button) => {
                    button.addEventListener('click', (event) => {
                        event.preventDefault();
                        const statKey = button.dataset.stat;
                        const delta = Number(button.dataset.delta || 0);
                        changePrimaryStat(statKey, delta);
                    });
                });

                if (bottomMenuBackdrop) {
                    bottomMenuBackdrop.addEventListener('click', () => {
                        closeBottomMenu();
                    });
                }

                const overlay = document.getElementById('boot-overlay');
                if (overlay) overlay.style.display = 'none';
                document.body.classList.remove('is-booting');

                const actionBtn = document.getElementById('action-btn');
                if (actionBtn) {
                    actionBtn.addEventListener('click', (event) => {
                        event.preventDefault();
                        performPlayerActionBySkillSlots();
                    });
                }

                ['manual-skill-btn-1', 'manual-skill-btn-2', 'manual-skill-btn-3', 'manual-skill-btn-4'].forEach((id, index) => {
                    const manualButton = document.getElementById(id);
                    if (manualButton) {
                        manualButton.addEventListener('click', (event) => {
                            event.preventDefault();
                            pushMiniLog(`æ‰‹å‹•ã‚¹ã‚­ãƒ«${index + 1}: ã¾ã æœªå®Ÿè£…`);
                        });
                    }
                });

                const equipSlotModal = document.getElementById('equip-slot-modal');
                ['equip-slot-close', 'equip-slot-close-bottom'].forEach((id) => {
                    const closeBtn = document.getElementById(id);
                    if (closeBtn) {
                        closeBtn.addEventListener('click', (event) => {
                            event.preventDefault();
                            closeEquipSlotModal();
                        });
                    }
                });
                if (equipSlotModal) {
                    equipSlotModal.addEventListener('click', (event) => {
                        if (event.target === equipSlotModal) {
                            closeEquipSlotModal();
                        }
                    });
                }

                ['equip-slot-1', 'equip-slot-2'].forEach((id) => {
                    const equipBtn = document.getElementById(id);
                    if (equipBtn) {
                        equipBtn.addEventListener('click', (event) => {
                            event.preventDefault();
                            if (!equipmentUiState.pendingEquipItemId) {
                                return;
                            }
                            equipItemById(equipmentUiState.pendingEquipItemId, equipBtn.dataset.slotKey || null);
                            closeEquipSlotModal();
                        });
                    }
                });


                ['compare-modal-close', 'compare-modal-close-bottom'].forEach((id) => {
                    const closeBtn = document.getElementById(id);
                    if (closeBtn) {
                        closeBtn.addEventListener('click', (event) => {
                            event.preventDefault();
                            closeCompareModal();
                        });
                    }
                });
                const compareModal = document.getElementById('compare-modal');
                if (compareModal) {
                    compareModal.addEventListener('click', (event) => {
                        if (event.target === compareModal) {
                            closeCompareModal();
                        }
                    });
                }
                const compareEquipBtn = document.getElementById('compare-modal-equip');
                if (compareEquipBtn) {
                    compareEquipBtn.addEventListener('click', (event) => {
                        event.preventDefault();
                        if (!equipmentUiState.pendingEquipItemId) {
                            return;
                        }
                        equipItemById(equipmentUiState.pendingEquipItemId, equipmentUiState.pendingEquipSlotKey || null);
                        closeCompareModal();
                        closeEquipSlotModal();
                    });
                }

                ['enhance-modal-close', 'enhance-modal-close-bottom'].forEach((id) => {
                    const closeBtn = document.getElementById(id);
                    if (closeBtn) {
                        closeBtn.addEventListener('click', (event) => {
                            event.preventDefault();
                            closeEnhanceModal();
                        });
                    }
                });
                const enhanceModal = document.getElementById('enhance-modal');
                if (enhanceModal) {
                    enhanceModal.addEventListener('click', (event) => {
                        if (event.target === enhanceModal) {
                            closeEnhanceModal();
                        }
                    });
                }
                const enhanceRepeatBtn = document.getElementById('enhance-modal-repeat');
                if (enhanceRepeatBtn) {
                    enhanceRepeatBtn.addEventListener('click', (event) => {
                        event.preventDefault();
                        runEnhancement();
                    });
                }
                const enhanceProgress = document.getElementById('enhance-modal-progress');
                if (enhanceProgress) {
                    enhanceProgress.addEventListener('click', () => {
                        if (enhanceUiState.pendingResult) {
                            enhanceUiState.pendingResult();
                        }
                    });
                }
                const enhanceResult = document.getElementById('enhance-modal-result');
                if (enhanceResult) {
                    enhanceResult.addEventListener('click', (event) => {
                        closeEnhanceModal();
                    });
                }

                const warpModal = document.getElementById('warp-modal');
                const warpBtn = document.getElementById('warp-btn');
                const warpClose = document.getElementById('warp-close');
                if (warpBtn && warpModal) {
                    warpBtn.addEventListener('click', (event) => {
                        event.preventDefault();
                        warpModal.classList.remove('hidden');
                        warpModal.classList.add('flex');
                    });
                }
                if (warpClose && warpModal) {
                    warpClose.addEventListener('click', (event) => {
                        event.preventDefault();
                        warpModal.classList.add('hidden');
                        warpModal.classList.remove('flex');
                    });
                }
                if (warpModal) {
                    warpModal.addEventListener('click', (event) => {
                        if (event.target === warpModal) {
                            warpModal.classList.add('hidden');
                            warpModal.classList.remove('flex');
                        }
                    });
                }
            });
        })();
    </script>
    </div>
</body>
</html>
